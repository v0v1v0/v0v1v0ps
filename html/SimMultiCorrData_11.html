<div class="container">

<table style="width: 100%;"><tr>
<td>error_loop</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Error Loop to Correct Final Correlation of Simulated Variables</h2>

<h3>Description</h3>

<p>This function corrects the final correlation of simulated variables to be within a precision value (<code>epsilon</code>) of the
target correlation.  It updates the pairwise intermediate MVN correlation iteratively in a loop until either the maximum error
is less than epsilon or the number of iterations exceeds the maximum number set by the user (<code>maxit</code>).  It uses
<code>error_vars</code> to simulate all variables and calculate the correlation of all variables in each
iteration.  This function would not ordinarily be called directly by the user.  The function is a
modification of  Barbiero &amp; Ferrari's <code>ordcont</code> function in <code>GenOrd-package</code>.
The <code>ordcont</code> has been modified in the following ways:
</p>
<p>1) It works for continuous, ordinal (r &gt;= 2 categories), and count variables.
</p>
<p>2) The initial correlation check has been removed because this intermediate correlation
Sigma from <code>rcorrvar</code> or <code>rcorrvar2</code> has already been
checked for positive-definiteness and used to generate variables.
</p>
<p>3) Eigenvalue decomposition is done on <code>Sigma</code> to impose the correct interemdiate correlations on the normal variables.
If <code>Sigma</code> is not positive-definite, the negative eigen values are replaced with 0.
</p>
<p>4) The final positive-definite check has been removed.
</p>
<p>5) The intermediate correlation update function was changed to accommodate more situations.
</p>
<p>6) A final "fail-safe" check was added at the end of the iteration loop where if the absolute
error between the final and target pairwise correlation is still &gt; 0.1, the intermediate correlation is set
equal to the target correlation (if <code>extra_correct</code> = "TRUE").
</p>
<p>7) Allowing specifications for the sample size and the seed for reproducibility.
</p>


<h3>Usage</h3>

<pre><code class="language-R">error_loop(k_cat, k_cont, k_pois, k_nb, Y_cat, Y, Yb, Y_pois, Y_nb, marginal,
  support, method, means, vars, constants, lam, size, prob, mu, n, seed,
  epsilon, maxit, rho0, Sigma, rho_calc, extra_correct)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>k_cat</code></td>
<td>
<p>the number of ordinal (r &gt;= 2 categories) variables</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>k_cont</code></td>
<td>
<p>the number of continuous variables</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>k_pois</code></td>
<td>
<p>the number of Poisson variables</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>k_nb</code></td>
<td>
<p>the number of Negative Binomial variables</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Y_cat</code></td>
<td>
<p>the ordinal variables generated from <code>rcorrvar</code> or <code>rcorrvar2</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Y</code></td>
<td>
<p>the continuous (mean 0, variance 1) variables</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Yb</code></td>
<td>
<p>the continuous variables with desired mean and variance</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Y_pois</code></td>
<td>
<p>the Poisson variables</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Y_nb</code></td>
<td>
<p>the Negative Binomial variables</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>marginal</code></td>
<td>
<p>a list of length equal <code>k_cat</code>; the i-th element is a vector of the cumulative
probabilities defining the marginal distribution of the i-th variable;
if the variable can take r values, the vector will contain r - 1 probabilities (the r-th is assumed to be 1)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>support</code></td>
<td>
<p>a list of length equal <code>k_cat</code>; the i-th element is a vector of containing the r
ordered support values; if not provided, the default is for the i-th element to be the vector 1, ..., r</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method</code></td>
<td>
<p>the method used to generate the continuous variables.  "Fleishman" uses a third-order polynomial transformation
and "Polynomial" uses Headrick's fifth-order transformation.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>means</code></td>
<td>
<p>a vector of means for the continuous variables</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>vars</code></td>
<td>
<p>a vector of variances</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>constants</code></td>
<td>
<p>a matrix with <code>k_cont</code> rows, each a vector of constants c0, c1, c2, c3 (if <code>method</code> = "Fleishman") or
c0, c1, c2, c3, c4, c5 (if <code>method</code> = "Polynomial"), like that returned by
<code>find_constants</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lam</code></td>
<td>
<p>a vector of lambda (&gt; 0) constants for the Poisson variables (see <code>Poisson</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>size</code></td>
<td>
<p>a vector of size parameters for the Negative Binomial variables (see <code>NegBinomial</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>prob</code></td>
<td>
<p>a vector of success probability parameters</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mu</code></td>
<td>
<p>a vector of mean parameters (*Note: either <code>prob</code> or <code>mu</code> should be supplied for all Negative Binomial variables,
not a mixture)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>n</code></td>
<td>
<p>the sample size</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>seed</code></td>
<td>
<p>the seed value for random number generation</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>epsilon</code></td>
<td>
<p>the maximum acceptable error between the final and target correlation matrices;
smaller epsilons take more time</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>maxit</code></td>
<td>
<p>the maximum number of iterations to use to find the intermediate correlation; the
correction loop stops when either the iteration number passes <code>maxit</code> or <code>epsilon</code> is reached</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>rho0</code></td>
<td>
<p>the target correlation matrix</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Sigma</code></td>
<td>
<p>the intermediate correlation matrix previously used in <code>rcorrvar</code>
or <code>rcorrvar2</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>rho_calc</code></td>
<td>
<p>the final correlation matrix calculated in <code>rcorrvar</code>
or <code>rcorrvar2</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>extra_correct</code></td>
<td>
<p>if "TRUE", a final "fail-safe" check is used at the end of the iteration loop where if the absolute
error between the final and target pairwise correlation is still &gt; 0.1, the intermediate correlation is set
equal to the target correlation</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>A list with the following components:
</p>
<p><code>Sigma</code> the intermediate MVN correlation matrix resulting from the error loop
</p>
<p><code>rho_calc</code> the calculated final correlation matrix generated from Sigma
</p>
<p><code>Y_cat</code> the ordinal variables
</p>
<p><code>Y</code> the continuous (mean 0, variance 1) variables
</p>
<p><code>Yb</code> the continuous variables with desired mean and variance
</p>
<p><code>Y_pois</code> the Poisson variables
</p>
<p><code>Y_nb</code> the Negative Binomial variables
</p>
<p><code>niter</code> a matrix containing the number of iterations required for each variable pair
</p>


<h3>References</h3>

<p>Barbiero A, Ferrari PA (2015). GenOrd: Simulation of Discrete Random Variables with Given
Correlation Matrix and Marginal Distributions. R package version 1.4.0. <a href="https://CRAN.R-project.org/package=GenOrd">https://CRAN.R-project.org/package=GenOrd</a>
</p>
<p>Ferrari PA, Barbiero A (2012). Simulating ordinal data. Multivariate Behavioral Research, 47(4): 566-589.
doi: <a href="http://doi.org/10.1080/00273171.2012.692630">10.1080/00273171.2012.692630</a>.
</p>
<p>Fleishman AI (1978). A Method for Simulating Non-normal Distributions. Psychometrika, 43, 521-532. doi: <a href="http://doi.org/10.1007/BF02293811">10.1007/BF02293811</a>.
</p>
<p>Headrick TC (2002). Fast Fifth-order Polynomial Transforms for Generating Univariate and Multivariate
Non-normal Distributions. Computational Statistics &amp; Data Analysis, 40(4):685-711. doi: <a href="http://doi.org/10.1016/S0167-9473(02)00072-5">10.1016/S0167-9473(02)00072-5</a>.
(<a href="http://www.sciencedirect.com/science/article/pii/S0167947302000725">ScienceDirect</a>)
</p>
<p>Headrick TC (2004). On Polynomial Transformations for Simulating Multivariate Nonnormal Distributions.
Journal of Modern Applied Statistical Methods, 3(1), 65-71. doi: <a href="http://doi.org/10.22237/jmasm/1083370080">10.22237/jmasm/1083370080</a>.
</p>
<p>Headrick TC, Kowalchuk RK (2007). The Power Method Transformation: Its Probability Density Function, Distribution
Function, and Its Further Use for Fitting Data. Journal of Statistical Computation and Simulation, 77, 229-249. doi: <a href="http://doi.org/10.1080/10629360600605065">10.1080/10629360600605065</a>.
</p>
<p>Headrick TC, Sawilowsky SS (1999). Simulating Correlated Non-normal Distributions: Extending the Fleishman Power
Method. Psychometrika, 64, 25-35. doi: <a href="http://doi.org/10.1007/BF02294317">10.1007/BF02294317</a>.
</p>
<p>Headrick TC, Sheng Y, &amp; Hodis FA (2007). Numerical Computing and Graphics for the Power Method Transformation Using
Mathematica. Journal of Statistical Software, 19(3), 1 - 17. doi: <a href="http://doi.org/10.18637/jss.v019.i03">10.18637/jss.v019.i03</a>.
</p>
<p>Higham N (2002). Computing the nearest correlation matrix - a problem from finance; IMA Journal of Numerical Analysis 22: 329-343.
</p>


<h3>See Also</h3>

<p><code>ordcont</code>, <code>rcorrvar</code>, <code>rcorrvar2</code>,
<code>findintercorr</code>, <code>findintercorr2</code>
</p>


</div>