<div class="container">

<table style="width: 100%;"><tr>
<td>residuals.sdmTMB</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Residuals method for sdmTMB models</h2>

<h3>Description</h3>

<p>See the residual-checking vignette: <code>browseVignettes("sdmTMB")</code> or <a href="https://pbs-assess.github.io/sdmTMB/articles/residual-checking.html">on the documentation site</a>.
See notes about types of residuals in 'Details' section below.
</p>


<h3>Usage</h3>

<pre><code class="language-R">## S3 method for class 'sdmTMB'
residuals(
  object,
  type = c("mle-mvn", "mle-eb", "mle-mcmc", "response", "pearson"),
  model = c(1, 2),
  mcmc_samples = NULL,
  qres_func = NULL,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>object</code></td>
<td>
<p>An <code>sdmTMB()</code> model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>type</code></td>
<td>
<p>Residual type. See details.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>model</code></td>
<td>
<p>Which delta/hurdle model component?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mcmc_samples</code></td>
<td>
<p>A vector of MCMC samples of the linear predictor in link
space. See the <code>predict_mle_mcmc()</code> function in the
<a href="https://github.com/pbs-assess/sdmTMBextra">sdmTMBextra</a> package.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>qres_func</code></td>
<td>
<p>A custom quantile residuals function. Function should take
the arguments <code style="white-space: pre;">⁠object, y, mu, ...⁠</code> and return a vector of length
<code>length(y)</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>Passed to custom <code>qres_func</code> function. Unused.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p><strong>Randomized quantile residuals:</strong>
</p>
<p><code>mle-mvn</code>, <code>mle-eb</code>, and <code>mle-mcmc</code> are all implementations of
randomized quantile residuals (Dunn &amp; Smyth 1996), which are also known as
probability integral transform (PIT) residuals (Smith 1985). If the data are
consistent with model assumptions, these residuals should be distributed as
normal(0, 1). Randomization is added to account for integer or binary
response observations. For example, for a Poisson observation likelihood with
observations <code>y</code> and mean predictions <code>mu</code>, we would create randomized
quantile residuals as:
</p>
<div class="sourceCode"><pre>a &lt;- ppois(y - 1, mu)
b &lt;- ppois(y, mu)
u &lt;- runif(n = length(y), min = a, max = b)
qnorm(u)
</pre></div>
<p><strong>Types of residuals:</strong>
</p>
<p>Acronyms:
</p>

<ul>
<li>
<p> EB: Empirical Bayes
</p>
</li>
<li>
<p> MCMC: Markov chain Monte Carlo
</p>
</li>
<li>
<p> MLE: Maximum Likelihood Estimate
</p>
</li>
<li>
<p> MVN: Multivariate normal
</p>
</li>
</ul>
<p><strong><code>mle-mvn</code></strong>: Fixed effects are held at their MLEs and random effects are
taken from a single approximate posterior sample. The "approximate" part
refers to the sample being taken from the random effects' assumed MVN
distribution. In practice, the sample is obtained based on the mode and
Hessian of the random effects taking advantage of sparsity in the Hessian for
computational efficiency. This sample is taken with <code>obj$MC()</code>, where <code>obj</code>
is the <span class="pkg">TMB</span> object created with <code>TMB::MakeADFun()</code>. See Waagepetersen
(2006) and the description in the source code for the internal <span class="pkg">TMB</span>
function <code>TMB:::oneSamplePosterior()</code>. Residuals are converted to randomized
quantile residuals as described above.
</p>
<p><strong><code>mle-eb</code></strong>: Fixed effects are held at their MLEs and random effects are
taken as their EB estimates. These used to be the default residuals in
<span class="pkg">sdmTMB</span> (and were called <code>mle-laplace</code>). They are available for
backwards compatibility and for research purposes but they are <em>not</em>
recommended for checking goodness of fit. Residuals are converted to
randomized quantile residuals as described above.
</p>
<p><strong><code>mle-mcmc</code></strong>: Fixed effects are held at their MLEs and random effects are
taken from a single posterior sample obtained with MCMC. These are an
excellent option since they make no assumption about the distribution of the
random effects (compared to the <code>mle-mvn</code> option) but can be slow to obtain.
See Waagepetersen (2006) and Thygesen et al. (2017). Residuals are converted
to randomized quantile residuals as described above.
</p>
<p>See the <a href="https://github.com/pbs-assess/sdmTMBextra"><span class="pkg">sdmTMBextra</span></a>
package for the function <code>predict_mle_mcmc()</code>, which can generate the MCMC
samples to pass to the <code>mcmc_samples</code> argument. Ideally MCMC is run until
convergence and then the last iteration can be used for residuals.
The defaults may not be sufficient for many models.
</p>
<p><strong><code>response</code></strong>: These are simple observed minus predicted residuals.
</p>
<p><strong><code>pearson</code></strong>: These are Pearson residuals: response residuals scaled by the
standard deviation. If weights are present, the residuals are then
multiplied by sqrt(weights).
</p>


<h3>Value</h3>

<p>A vector of residuals. Note that randomization from any single
random effect posterior sample and from any randomized quantile routines
will result in different residuals with each call. It is suggested to <strong>set
a randomization seed</strong> and to not go "fishing" for the perfect residuals or
to present all inspected residuals.
</p>


<h3>References</h3>

<p>Dunn, P.K. &amp; Smyth, G.K. (1996). Randomized Quantile Residuals. Journal of
Computational and Graphical Statistics, 5, 236–244.
</p>
<p>Smith, J.Q. (1985). Diagnostic checks of non-standard time series models.
Journal of Forecasting, 4, 283–291.
</p>
<p>Waagepetersen, R. (2006). A simulation-based goodness-of-fit test for random
effects in generalized linear mixed models. Scandinavian Journal of
Statistics, 33(4), 721-731.
</p>
<p>Thygesen, U.H., Albertsen, C.M., Berg, C.W., Kristensen, K., and Nielsen, A.
2017. Validation of ecological state space models using the Laplace
approximation. Environ Ecol Stat 24(2): 317–339.
<a href="https://doi.org/10.1007/s10651-017-0372-4">doi:10.1007/s10651-017-0372-4</a>
</p>
<p>Rufener, M.-C., Kristensen, K., Nielsen, J.R., and Bastardie, F. 2021.
Bridging the gap between commercial fisheries and survey data to model the
spatiotemporal dynamics of marine species. Ecological Applications. e02453.
<a href="https://doi.org/10.1002/eap.2453">doi:10.1002/eap.2453</a>
</p>


<h3>See Also</h3>

<p><code>simulate.sdmTMB()</code>, <code>dharma_residuals()</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">
mesh &lt;- make_mesh(pcod_2011, c("X", "Y"), cutoff = 10)
fit &lt;- sdmTMB(
  present ~ as.factor(year) + poly(depth, 2),
  data = pcod_2011, mesh = mesh,
  family = binomial()
)

# the default "mle-mvn" residuals use fixed effects at their MLE and a
# single sample from the approximate random effect posterior:
set.seed(9283)
r &lt;- residuals(fit, type = "mle-mvn")
qqnorm(r)
abline(0, 1)

# response residuals will be not be normally distributed unless
# the family is Gaussian:
r &lt;- residuals(fit, type = "response")
qqnorm(r)
abline(0, 1)

# "mle-eb" are quick but are not expected to be N(0, 1); not recommended:
set.seed(2321)
r &lt;- residuals(fit, type = "mle-eb")
qqnorm(r)
abline(0, 1)

# see also "mle-mcmc" residuals with the help of the sdmTMBextra package
# we can fake them here by taking a single sample from the joint precision
# matrix and pretending they are MCMC samples:
set.seed(82728)
p &lt;- predict(fit, nsim = 1) # pretend these are from sdmTMBextra::predict_mle_mcmc()
r &lt;- residuals(fit, mcmc_samples = p)
qqnorm(r)
abline(0, 1)
</code></pre>


</div>