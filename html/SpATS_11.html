<div class="container">

<table style="width: 100%;"><tr>
<td>SpATS</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>
Spatial analysis of field trials with splines
</h2>

<h3>Description</h3>

<p>Function specifically designed for the analysis of field trials experiments with the spatial trend being modelled by means of two-dimensional P-splines.
</p>


<h3>Usage</h3>

<pre><code class="language-R">SpATS(response, genotype, geno.decomp = NULL, genotype.as.random = FALSE, spatial, 
 fixed = NULL, random = NULL, data, family = gaussian(), offset = 0, weights = NULL, 
 control = controlSpATS())
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>response</code></td>
<td>
<p>a character string with the name of the variable that contains the response variable of interest.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>genotype</code></td>
<td>
<p>a character string with the name of the variable that contains the genotypes or varieties. This variable must be a factor on the data frame.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>geno.decomp</code></td>
<td>
<p>an optional character string with the name of a factor variable according which genotypes are grouped, with different genetic variance being assumed for each group. Only applies when genotype is random</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>genotype.as.random</code></td>
<td>
<p>logical. If TRUE, the genotype is included as random effect in the model. The default is FALSE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>spatial</code></td>
<td>
<p>a right hand <code>formula</code> object specifying the spatial P-Spline model. See <code>SAP</code> and <code>PSANOVA</code> for more details about how to specify the spatial trend.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fixed</code></td>
<td>
<p>an optional right hand <code>formula</code> object specifying the fixed effects.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>random</code></td>
<td>
<p>an optional right hand <code>formula</code> object specifying the random effects. Currently, only sets of independent and identically distributed random effects can be incorporated.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>data frame containing all needed variables</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>family</code></td>
<td>
<p>object of class <code>family</code> specifying the distribution and link function.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>offset</code></td>
<td>
<p>an optional numerical vector containing an a priori known component to be included in the linear predictor during fitting. </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>weights</code></td>
<td>
<p>an optional numerical vector of weights to be used in the fitting process. By default, the weights are considered to be one.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>control</code></td>
<td>
<p>a list of control values to replace the default values returned by the function <code>controlSpATS</code>.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>This function fits a (generalised) linear mixed model, with the variance components being estimated by the restricted log-likelihood (REML). The estimation procedure is an extension of the SAP (Separation of anisotropic penalties) algorithm by Rodriguez - Alvarez et al. (2015). In this package, besides the spatial trend, modelled as a two-dimensional P-spline, the implemented estimation algorithm also allows for the incorporation of both fixed and (sets of i.i.d) random effects on the (generalised) linear mixed model.
As far as the implementation of the algorithm is concerned, the sparse structure of the design matrix associated with the genotype has been taken into account. The combination of both the SAP algorithm and this sparse structure makes the algorithm computational efficient, allowing the proposal to be applied for the analysis of large datasets.  
</p>


<h3>Value</h3>

<p>A list with the following components:
</p>
<table>
<tr style="vertical-align: top;">
<td><code>call</code></td>
<td>
<p>the matched call.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>the original supplied data argument with a new column with the weights used during the fitting process.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>model</code></td>
<td>
<p>a list with the model components: response, spatial, genotype, fixed and/or random.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fitted</code></td>
<td>
<p>a numeric vector with the fitted values.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>residuals</code></td>
<td>
<p>a numeric vector with deviance residuals.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>psi</code></td>
<td>
<p>a two-length vector with the values of the dispersion parameter at convergence. For Gaussian responses both elements coincide, being the (REML) estimate of dispersion parameter. For non-Gaussian responses, the result depends on the argument <code>update.psi</code> of the <code>controlSpATS</code> function. If this argument was specified to <code>FALSE</code> (the default), the first component of the vector corresponds to the default value used for the dispersion parameter (usually 1). The second element, correspond to the (REML) estimate of the dispersion parameter at convergence. If the argument <code>update.psi</code> was specified to <code>TRUE</code>, both components coincide (as in the Gaussian case).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>var.comp</code></td>
<td>
<p>a numeric vector with the (REML) variance component estimates. These vector contains the variance components associated with the spatial trend, as well as those related with the random model terms.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>eff.dim</code></td>
<td>
<p>a numeric vector with the estimated effective dimension (or effective degrees of freedom) for each model component (genotype, spatial, fixed and/or random)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dim</code></td>
<td>
<p>a numeric vector with the (model) dimension of each model component (genotype, spatial, fixed and/or random). This value corresponds to the number of parameters to be estimated</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dim.nom</code></td>
<td>
<p>a numeric vector with the (nominal) dimension of each component (genotype, spatial, fixed and/or random). For the random terms of the model, this value corresponds to upper bound for the effective dimension (i.e., the maximum effective dimension a random term can achive). This nominal dimension is <code class="reqn">rank[X, Z_k] - rank[X]</code>, where <code class="reqn">Z_k</code> is the design matrix of the k-th random factor and <code class="reqn">X</code> is the design matrix of the fixed part of the model. In most cases (but not always), the nominal dimension corresponds to the model dimension minus one, “lost” due to the implicit constraint that ensures the mean of the random effects to be zero.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nobs</code></td>
<td>
<p>number of observations used to fit the model</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>niterations</code></td>
<td>
<p>number of iterations EM-algorithm</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>deviance</code></td>
<td>
<p>the (REML) deviance at convergence (i.e., - 2 times the restricted log-likelihood)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>coeff</code></td>
<td>
<p>a numeric vector with the estimated fixed and random effect coefficients.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>terms</code></td>
<td>
<p>a list with the model terms: response, spatial, genotype, fixed and/or random. The information provided here is useful for printing and prediction purposes.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>vcov</code></td>
<td>
<p>inverse of the coefficient matrix of the mixed models equations. The inverse is needed for the computation of standard errors. For computational issues, the inverse is returned as a list: C11_inv corresponds to the coefficient matrix associated with the genotype; C22_inv corresponds to the coefficient matrix associated with the spatial, the fixed and the random components; and C12_inv and C21_inv correspond to the “combination” of both.</p>
</td>
</tr>
</table>
<h3>References</h3>

<p>Currie, I., and Durban, M. (2002). Flexible smoothing with P-splines: a unified approach. Statistical Modelling, 4, 333 - 349.
</p>
<p>Eilers, P.H.C., and Marx, B.D. (2003). Multivariate calibration with temperature interaction using two-dimensional penalised signal regression. Chemometrics and Intelligent Laboratory Systems, 66, 159 - 174.
</p>
<p>Eilers, P.H.C., Marx, B.D., Durban, M. (2015). Twenty years of P-splines. SORT, 39(2), 149 - 186.
</p>
<p>Gilmour, A.R., Cullis, B.R., and Verbyla, A.P. (1997). Accounting for Natural and Extraneous Variation in the Analysis of Field Experiments. Journal of Agricultural, Biological, and Environmental Statistics, 2, 269 - 293.
</p>
<p>Lee, D.-J., Durban, M., and Eilers, P.H.C. (2013). Efficient two-dimensional smoothing with P-spline ANOVA mixed models and nested bases. Computational Statistics and Data Analysis, 61, 22 - 37.
</p>
<p>Rodriguez-Alvarez, M.X, Boer, M.P., van Eeuwijk, F.A., and Eilers, P.H.C. (2018). Correcting for spatial heterogeneity in plant breeding experiments with P-splines. Spatial Statistics, 23, 52 - 71. https://doi.org/10.1016/j.spasta.2017.10.003.
</p>
<p>Rodriguez-Alvarez, M.X., Lee, D.-J., Kneib, T., Durban, M., and Eilers, P.H.C. (2015). Fast smoothing parameter separation in multidimensional generalized P-splines: the SAP algorithm. Statistics and Computing, 25, 941 - 957.
</p>


<h3>See Also</h3>

<p><code>SpATS-package</code>, <code>controlSpATS</code>, <code>SAP</code>, <code>PSANOVA</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">library(SpATS)
data(wheatdata)
summary(wheatdata)

# Create factor variable for row and columns
wheatdata$R &lt;- as.factor(wheatdata$row)
wheatdata$C &lt;- as.factor(wheatdata$col)

m0 &lt;- SpATS(response = "yield", spatial = ~ SAP(col, row, nseg = c(10,20), degree = 3, pord = 2), 
 genotype = "geno", fixed = ~ colcode + rowcode, random = ~ R + C, data = wheatdata, 
 control =  list(tolerance = 1e-03))
# Brief summary
m0
# More information: dimensions
summary(m0) # summary(fit.m2, which = "dimensions") 
# More information: variances
summary(m0, which = "variances") 
# More information: all
summary(m0, which = "all") 

# Plot results
plot(m0)
plot(m0, all.in.one = FALSE)

# Variogram
var.m0 &lt;- variogram(m0)
plot(var.m0)
</code></pre>


</div>