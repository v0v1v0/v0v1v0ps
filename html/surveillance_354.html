<div class="container">

<table style="width: 100%;"><tr>
<td>twinSIR_simulation</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>
Simulation of Epidemic Data
</h2>

<h3>Description</h3>

<p>This function simulates the infection (and removal) times of 
an epidemic.  Besides the classical SIR type of epidemic, also SI, SIRS and
SIS epidemics are supported.  Simulation works via the conditional intensity 
of infection of an individual, given some (time varying) endemic covariates 
and/or some distance functions (epidemic components) as well as the fixed 
positions of the individuals.  The lengths of the infectious and removed 
periods are generated following a pre-specified function (can be
deterministic).
</p>
<p>The <code>simulate</code> method for objects of class
<code>"twinSIR"</code> simulates new epidemic data using the model and
the parameter estimates of the fitted object.
</p>


<h3>Usage</h3>

<pre><code class="language-R">simEpidata(formula, data, id.col, I0.col, coords.cols, subset,
           beta, h0, f = list(), w = list(), alpha, infPeriod,
           remPeriod = function(ids) rep(Inf, length(ids)),
           end = Inf, trace = FALSE, .allocate = NULL)

## S3 method for class 'twinSIR'
simulate(object, nsim = 1, seed = 1,
         infPeriod = NULL, remPeriod = NULL,
         end = diff(range(object$intervals)), trace = FALSE, .allocate = NULL,
         data = object$data, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>formula</code></td>
<td>

<p>an object of class <code>"formula"</code> (or one that can be coerced to
that class): a symbolic description of the intensity model to be estimated.  
The details of model specification are given under Details.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>

<p>a data.frame containing the variables in <code>formula</code> and the variables
specified by <code>id.col</code>, <code>I0.col</code> and <code>coords.col</code> (see below).
It represents the “history” of the endemic covariates to use for the
simulation.  The form is similar to and can be an object of class
<code>"epidata"</code>.  The simulation period is split up into
<em>consecutive</em> intervals of constant endemic covariables.  The 
data frame consists of a block of N (number of individuals) rows for each of
those time intervals (all rows in a block share the same start and stop 
values... therefore the name “block”), where there is one row per 
individual in the block.  Each row describes the (fixed) state of the 
endemic covariates of the individual during the time interval given by the 
start and stop columns (specified through the lhs of <code>formula</code>).
</p>
<p>For the <code>simulate</code> method of class <code>"twinSIR"</code> this should be 
the object of class <code>"epidata"</code> used for the fit.  This is a
part of the return value of the function <code>twinSIR</code>, if called with 
argument <code>keep.data</code> set to <code>TRUE</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>id.col</code></td>
<td>

<p>only if <code>data</code> does not inherit from <code>epidata</code>:
single index of the <code>id</code> column in <code>data</code>.  Can be numeric
(by column number) or character (by column name).<br>
The <code>id</code> column identifies the individuals in the data-frame.  It will
be converted to a factor variable and its levels serve also to identify 
individuals as argument to the <code>infPeriod</code> function.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>I0.col</code></td>
<td>

<p>only if <code>data</code> does not inherit from <code>epidata</code>:
single index of the <code>I0</code> column in <code>data</code>.  Can be numeric
(by column number), character (by column name) or <code>NULL</code>.<br>
The <code>I0</code> column indicates if an individual is initially infectious,
i.e. it is already infectious at the beginning of the first time block.
Setting <code>I0.col = NULL</code> is short for “there are no initially
infectious individuals”. Otherwise, the variable must be logical or in
0/1-coding.  As this variable is constant over time the initially
infectious individuals are derived from the first time block only.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>coords.cols</code></td>
<td>

<p>only if <code>data</code> does not inherit from <code>epidata</code>:
index<em>es</em> of the <code>coords</code> column<em>s</em> in <code>data</code>.  Can be a
numeric (by column number), a character (by column name) vector or
<code>NULL</code>.<br>
These columns contain the coordinates of the individuals.  It must be
emphasized that the functions in this package currently assume <em>fixed
positions</em> of the individuals during the whole epidemic.  Thus, an
individual has the same coordinates in every block.  For simplicity, the
coordinates are derived from the first time block only.  The epidemic
covariates are calculated based on the Euclidean distance between the
individuals, see <code>f</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>subset</code></td>
<td>

<p>an optional vector specifying a subset of the covariate history to be used 
in the simulation.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>beta</code></td>
<td>

<p>numeric vector of length equal the number of endemic (<code>cox</code>) terms on
the rhs of <code>formula</code>.  It contains the effects of the endemic predictor
(excluding the log-baseline <code>h0</code>, see below) in the same order as in 
the formula.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>h0</code></td>
<td>

<p><em>either</em> a single number to specify a constant baseline hazard
(equal to <code>exp(h0)</code>) <em>or</em> a list of functions named
<code>exact</code> and <code>upper</code>.  In the latter case, <code>h0$exact</code>
is the true log-baseline hazard function and <code>h0$upper</code> is a
<em>piecewise constant upper bound</em> for <code>h0$exact</code>.  The function
<code>h0$upper</code> must inherit from <code>stepfun</code> with
<code>right=FALSE</code>.  Theoretically, the intensity function is
left-continuous, thus <code>right=TRUE</code> would be adequate, but in the
implementation, when we evaluate the intensity at the
<code>knots</code> (change points) of <code>h0$upper</code> we need its value
for the subsequent interval.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>f, w</code></td>
<td>

<p>see <code>as.epidata</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>alpha</code></td>
<td>

<p>a named numeric vector of coefficients for the epidemic
covariates generated by <code>f</code> and <code>w</code>. The names are matched
against <code>names(f)</code> and <code>names(w)</code>.
Remember that <code>alpha &gt;= 0</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>infPeriod</code></td>
<td>

<p>a function generating lengths of infectious periods.  It should take one
parameter (e.g. <code>ids</code>), which is a character vector of id's of 
individuals, and return appropriate infection periods for those
individuals.  Therefore, the value of the function should be of length
<code>length(ids)</code>.  For example, for independent and identically
distributed infection periods following <code class="reqn">Exp(1)</code>,
the generating function is <code>function(ids) rexp(length(ids), rate=1)</code>.  
For a constant infectious period of length c, it is sufficient to set
<code>function (x) {c}</code>.<br>
For the <code>simulate</code> method of class <code>"twinSIR"</code> only, this can
also be <code>NULL</code> (the default), which means that the observed infectious
periods of infected individuals are re-used when simulating a new epidemic
and individuals with missing infectious periods (i.e. infection and 
recovery was not observed) are attributed to the mean observed
infectious period.
</p>
<p>Note that it is even possible to simulate an SI-epidemic by setting
</p>
<p><code>infPeriod = function (x) {Inf}</code>
</p>
<p>In other words: once an individual became
infected it spreads the disease forever, i.e. it will never be removed.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>remPeriod</code></td>
<td>

<p>a function generating lengths of removal periods.  Per default, once an
individual was removed it will stay in this state forever (<code>Inf</code>).
Therefore, it will not become at-risk (S) again and re-infections are not
possible.  Alternatively, always returning 0 as length of the removal 
period corresponds to a SIS epidemic.  Any other values correspond to SIRS.
Note that <code>end</code> should be set to a finite value in these cases.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>end</code></td>
<td>

<p>a single positive numeric value specifying the time point at which the
simulation should be forced to end.  By default, this is <code>Inf</code>, i.e.
the simulation continues until there is no susceptible individual left.<br>
For the <code>simulate</code> method of class <code>"twinSIR"</code> the default is
to have equal simulation and observation periods.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>trace</code></td>
<td>

<p>logical (or integer) indicating if (or how often) the sets of susceptible 
and infected individuals as well as the rejection indicator (of the 
rejection sampling step) should be <code>cat</code>ed.  Defaults to <code>FALSE</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.allocate</code></td>
<td>

<p>number of blocks to initially allocate for the event history (i.e.
<code>.allocate*N</code> rows). By default (<code>NULL</code>), this number is set to
<code>max(500, ceiling(nBlocks/100)*100)</code>, i.e. 500 but at least the
number of blocks in <code>data</code> (rounded to the next multiple of 100).
Each time the simulated epidemic exceeds the allocated space, the
event history will be enlarged by <code>.allocate</code> blocks.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>object</code></td>
<td>

<p>an object of class <code>"twinSIR"</code>.  This must contain the original
<code>data</code> used for the fit (see <code>data</code>).
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nsim</code></td>
<td>

<p>number of epidemics to simulate.  Defaults to 1.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>seed</code></td>
<td>

<p>an integer that will be used in the call to <code>set.seed</code> before
simulating the epidemics.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>

<p>unused (argument of the generic).
</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>A model is specified through the <code>formula</code>, which has the form
</p>
<p><code>cbind(start, stop) ~ cox(endemicVar1) * cox(endemicVar2)</code>,
</p>
<p>i.e. the right hand side has the usual form as in <code>lm</code>, but
all variables are marked as being endemic by the special function
<code>cox</code>.  The effects of those predictor terms are specified by
<code>beta</code>.  The left hand side of the formula denotes the start
and stop columns in <code>data</code>.  This can be omitted, if <code>data</code> inherits
from class <code>"epidata"</code> in which case <code>cbind(start, stop)</code> will be
used.  The epidemic model component is specified by the arguments
<code>f</code> and <code>w</code> (and the associated coefficients <code>alpha</code>).
</p>
<p>If the epidemic model component is empty and <code>infPeriod</code>
always returns <code>Inf</code>, then one actually simulates from a pure Cox model.
</p>
<p>The simulation algorithm used is <em>Ogata's modified thinning</em>.
For details, see Höhle (2009), Section 4.
</p>


<h3>Value</h3>

<p>An object of class <code>"simEpidata"</code>, which is a <code>data.frame</code> with the
columns <code>"id"</code>, <code>"start"</code>, <code>"stop"</code>, <code>"atRiskY"</code>,
<code>"event"</code>, <code>"Revent"</code> and the coordinate columns (with the original
names from <code>data</code>), which are all obligatory.  These columns are followed
by all the variables appearing on the rhs of the <code>formula</code>.  Last but not
least, the generated columns with epidemic covariates corresponding to the
functions in the lists <code>f</code> and <code>w</code> are appended.
</p>
<p>Note that objects of class <code>"simEpidata"</code> also inherit from class
<code>"epidata"</code>, thus all <code>"epidata"</code> methods can be
applied.
</p>
<p>The <code>data.frame</code> is given the additional <em>attributes</em>
</p>
<table>
<tr style="vertical-align: top;">
<td><code>"eventTimes"</code></td>
<td>

<p>numeric vector of infection time points (sorted chronologically).
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>"timeRange"</code></td>
<td>

<p>numeric vector of length 2: <code>c(min(start), max(stop))</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>"coords.cols"</code></td>
<td>

<p>numeric vector containing the column indices of the coordinate columns in
the resulting data-frame.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>"f"</code></td>
<td>

<p>this equals the argument <code>f</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>"w"</code></td>
<td>

<p>this equals the argument <code>w</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>"config"</code></td>
<td>

<p>a list with elements <code>h0 = h0$exact</code>, <code>beta</code> and <code>alpha</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>call</code></td>
<td>
<p>the matched call.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>terms</code></td>
<td>
<p>the <code>terms</code> object used.</p>
</td>
</tr>
</table>
<p>If <code>nsim &gt; 1</code> epidemics are simulated by the
<code>simulate</code>-method for fitted <code>"twinSIR"</code> models, these are
returned in a list.
</p>


<h3>Author(s)</h3>

 
<p>Sebastian Meyer and Michael Höhle
</p>


<h3>References</h3>

<p>Höhle, M. (2009),
Additive-Multiplicative Regression Models for Spatio-Temporal
Epidemics, Biometrical Journal, 51(6):961-978.
</p>


<h3>See Also</h3>

<p>The <code>plot.epidata</code> and <code>animate.epidata</code> methods
for plotting and animating (simulated) epidemic data, respectively.
The <code>intensityplot.simEpidata</code> method for plotting paths of
infection intensities.
</p>
<p>Function <code>twinSIR</code> for fitting spatio-temporal epidemic intensity
models to epidemic data.
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Generate a data frame containing a hypothetic population with 100 individuals
set.seed(1234)
n &lt;- 100
pos &lt;- matrix(rnorm(n*2), ncol=2, dimnames=list(NULL, c("x", "y")))
pop &lt;- data.frame(id=1:n, x=pos[,1], y=pos[,2], 
                  gender=sample(0:1, n, replace=TRUE),
                  I0col=c(rep(1,3),rep(0,n-3)), # 3 initially infectious
                  start=rep(0,n), stop=rep(Inf,n))

## Simulate an SIR epidemic in this population
set.seed(123)
infPeriods &lt;- setNames(c(1:3/10, rexp(n-3, rate=1)), 1:n)
epi &lt;- simEpidata(
    cbind(start,stop) ~ cox(gender), data = pop,
    id.col = "id", I0.col = "I0col", coords.cols = c("x","y"),
    beta = c(-2), h0 = -1, alpha = c(B1=0.1), f = list(B1=function(u) u&lt;=1),
    infPeriod = function(ids) infPeriods[ids],
    ##remPeriod = function(ids) rexp(length(ids), rate=0.1), end = 30   # -&gt; SIRS
)

## extract event times by id
head(summary(epi)$byID)

## Plot the numbers of susceptible, infectious and removed individuals
plot(epi)


## load the 1861 Hagelloch measles epidemic
data("hagelloch")
summary(hagelloch)
plot(hagelloch)

## fit a simplistic twinSIR model
fit &lt;- twinSIR(~ household, data = hagelloch)

## simulate a new epidemic from the above model
## with simulation period = observation period, re-using observed infPeriods
sim1 &lt;- simulate(fit, data = hagelloch)
plot(sim1)

## check if we find similar parameters in the simulated epidemic
fitsim1 &lt;- update(fit, data = sim1)
cbind(base = coef(fit), new = coef(fitsim1))


if (surveillance.options("allExamples")) {

## simulate only 10 days, using random infPeriods ~ Exp(0.1)
sim2 &lt;- simulate(fit, data = hagelloch, seed = 2, end = 10,
    infPeriod = function(ids) rexp(length(ids), rate = 0.1))
plot(sim2)

## simulate from a different model with manually specified parameters
set.seed(321)
simepi &lt;- simEpidata(~ cox(AGE), data = hagelloch,
    beta = c(0.1), h0 = -4, alpha = c(household = 0.05),
    f = list(household = function(u) u == 0),
    infPeriod = function(ids) rexp(length(ids), rate=1/8))
plot(simepi)
intensityplot(simepi)

## see if we correctly estimate the parameters
fitsimepi &lt;- twinSIR(~ cox(AGE) + household, data = simepi)
cbind(true = c(0.05, -4, 0.1), est = coef(fitsimepi), confint(fitsimepi))

}
</code></pre>


</div>