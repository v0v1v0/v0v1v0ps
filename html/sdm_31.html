<div class="container">

<table style="width: 100%;"><tr>
<td>ensemble</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Ensemble Forecasting of SDMs</h2>

<h3>Description</h3>

<p>Make a Raster object with a weighted averaging over all predictions from several fitted model in a sdmModel object.
</p>


<h3>Usage</h3>

<pre><code class="language-R">## S4 method for signature 'sdmModels'
ensemble(x, newdata, filename="",setting,overwrite=FALSE,pFilename="",...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>x</code></td>
<td>
<p>a sdmModels object</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>newdata</code></td>
<td>
<p>raster object or data.frame, can be either predictors or the results of the <code>predict</code> function</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>filename</code></td>
<td>
<p>optional character, output file name (if newdata is raster object)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>setting</code></td>
<td>
<p>list, contains the parameters that are used in the ensemble procedure; see details</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>overwrite</code></td>
<td>
<p>logical, whether existing filename is overwritten (if exists and filename is given) </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pFilename</code></td>
<td>
<p>it is ignored if newdata is the output of <code>predict</code>, otherwise, since the ensemble first call <code>predict</code>, it specifies the filename to write the output of <code>predict (if newdata is raster) </code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>additional arguments pass to the <code>writeRaster</code> function (if used)</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>ensemble function uses the fitted models in an <code>sdmModels</code> object to generate an ensemble/consensus of predictions by multiple individual models. Several <code>ensemble</code> methods are available and can be defined in the setting argument.
</p>
<p>A list of settings can be introduced in the <code>setting</code> argument including:
</p>
<p>- <code>method</code>: a character vector specifies which ensemble method(s) should be employed (multiple choice is possible). The details about the available methods are provided at the end of this page.
</p>
<p>- <code>stat</code>: if the - <code>method='weighted'</code> is used, it specifies which evaluation metrics can be used as weight in the weighted averaging procedure. Alternatively, one may directly introduce weights (see the next argument).
</p>
<p>- <code>weights</code>: an optional numeric vector (with a length equal to the models that are successfully fitted) to specify the weights for weighted averaging procedure (if the method='weighted' is specified).
</p>
<p>- <code>id</code>: specifies the model IDs that should be considered in the ensemble procedure. If missing, all the models that are successfully fitted are considered.
</p>
<p>- <code>expr</code>: A character or an expression specifies a condition to select models for the ensemble procedure. For example: <code>expr='auc &gt; 0.7'</code> only use models with AUC accuracy greater than 0.7. OR  <code>expr='auc &gt; 0.7 &amp; tss &gt; 0.5'</code> subsets models based on both AUC and TSS metrics.
</p>
<p>- <code>wtest</code>: specifies which test dataset ("training","test.dep","test.indep") should be used to extract the statistic (stat) values as weights (if a relevant method is specified)
</p>
<p>- <code>opt</code>: if a thershold_based metric is used in  is selected in <code>stat</code> or in <code>expr</code>, <code>opt</code> specifies the threshold selection criterion. The possible value can be between 1 to 14 for <code>"sp=se", "max(se+sp)", "min(cost)", "minROCdist", "max(kappa)", "max(ppv+npv)", "ppv=npv", "max(NMI)", "max(ccr)", "prevalence", "P10", "P5", "P1", "P0"</code> criteria, respectively.
</p>
<p>- <code>power</code>: default: 1, a numeric value to which the weights are raised. Greater value than 1 affects weighting scheme (for the methods e.g., "weighted") to increase the weights for the models with greater weight. For example, if weights are c(0.2,0.2,0.2,0.4), raising them to power 2 would be resulted to new weights as c(0.1428571,0.1428571, 0.1428571, 0.5714286) that causes greater contribution of the models with  greater performances to the ensemble output.
</p>
<p>—&gt; The available ensemble methods (to be specified in <code>method</code>) include:
</p>
<p>– 'unweighted': unweighted averaging/mean.
</p>
<p>– 'weighted': weighted averaging.
</p>
<p>– 'median': median.
</p>
<p>– 'pa': mean of predicted presence-absence values (predicted probabilities are first converted to presence-absence given a threshold (<code>opt</code> defines which threshold optimisation strategy should be used), then they are averaged).
</p>
<p>– 'mean-weighted': A two step averaging, that can be used when several replications are available for each modelling methods (e.g., fitted through bootstrapping or cross-validation resampling); it first takes an unweighted mean over the predicted values of multiple replications for each method (within model averaging), then a weighted mean is employed to combine the probabilities of different methods (between models averaging).
</p>
<p>– 'mean-unweighted': Same as the previous one, but an unweighted mean is also used for the second step (instead of weighted mean).
</p>
<p>– 'median-weighted': Same as the 'mean-weighted, but the median is used in the first step.
</p>
<p>– 'median-unweighted': another two-step method, median is used for the first step and unweighted mean is used for the second step.
</p>
<p>—-&gt; in addition to tne ensemble methods, some other methods are available to generate some outputs that can represent uncertainty:
</p>
<p>– 'uncertainty' or 'entropy': this method generates the uncertainty among the models' predictions that can be interpreted as model-based uncertainty or inconsistency among different models. It ranges between 0 and 1, 0 means all the models predicted the same value (either presence or absence), and 1 referes to maximum uncertainy, e.g., half of the models predicted presence (or absence) and the other half predicted the oposite value.
</p>
<p>– 'cv': Coefficient of variation of probabilities generated from multiple models
</p>
<p>– 'stdev': Standard deviation of probabilities generated from multiple models
</p>
<p>– 'ci': This generates confidence interval length (marginal error) which assigns the difference between upper and lower limits of confidence interval to each pixel (upper - lower). The default level of confidence interval is 95% (i.e., <code>alpha = 0.05</code>), unless a different <code>alpha</code> is defined in <code>setting</code>. In case two separate upper and lower rasters are needed, by using the following codes, the upper and lower limits can be calculated:
</p>
<p><code>en &lt;- ensemble(x, newdata, setting=list(method=c('mean','ci')))</code> # taking unweighted averaging and ci
</p>
<p># en[[1]] is the mean of all probabilities and en[[2]] is the ci
<code>ci.upper &lt;- en[[1]] + en[[2]] / 2</code> # adding marginal error (half of the generated ci) to mean
<code>ci.lower &lt;- en[[1]] - en[[2]] / 2</code> # subtracting marginal error from mean
</p>
<p><code>plot(ci.upper,main='Upper limit of Confidence Interval - alpha = 0.05')</code>
</p>
<p><code>plot(ci.lower,main='Lower limit of Confidence Interval - alpha = 0.05')</code>
</p>


<h3>Value</h3>

<p>- a Raster object if <code>predictors</code> is a Raster object
</p>
<p>- a numeric vector (or a data.frame) if <code>predictors</code> is a data.frame object
</p>


<h3>Author(s)</h3>

<p>Babak Naimi <a href="mailto:naimi.b@gmail.com">naimi.b@gmail.com</a>
</p>
<p><a href="https://www.r-gis.net/">https://www.r-gis.net/</a>
</p>
<p><a href="https://www.biogeoinformatics.org/">https://www.biogeoinformatics.org/</a>
</p>


<h3>References</h3>

<p>Naimi, B., Araujo, M.B. (2016) sdm: a reproducible and extensible R platform for species distribution modelling, Ecography, 39:368-375, DOI: 10.1111/ecog.01881
</p>


<h3>See Also</h3>

<p># </p>


<h3>Examples</h3>

<pre><code class="language-R">## Not run: 


file &lt;- system.file("external/species.shp", package="sdm") # get the location of the species data

species &lt;- vect(file) # read the shapefile

path &lt;- system.file("external", package="sdm") # path to the folder contains the data

lst &lt;- list.files(path=path,pattern='asc$',full.names = T) # list the name of the raster files 


# stack is a function in the raster package, to read/create a multi-layers raster dataset
preds &lt;- rast(lst) # making a raster object

d &lt;- sdmData(formula=Occurrence~., train=species, predictors=preds)

d

# fit the models (5 methods, and 10 replications using bootstrapping procedure):
m &lt;- sdm(Occurrence~.,data=d,methods=c('rf','tree','fda','mars','svm'),
          replicatin='boot',n=10)
    
# ensemble using weighted averaging based on AUC statistic:    
p1 &lt;- ensemble(m, newdata=preds, filename='ens.img',setting=list(method='weighted',stat='AUC'))
plot(p1)

# ensemble using weighted averaging based on TSS statistic
# and optimum threshold critesion 2 (i.e., Max(spe+sen)) :    
p2 &lt;- ensemble(m, newdata=preds, filename='ens2.img',setting=list(method='weighted',
                                                                  stat='TSS',opt=2))
plot(p2)


## End(Not run)


</code></pre>


</div>