<div class="container">

<table style="width: 100%;"><tr>
<td>smooth_residuals</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Smooth residuals after model fit</h2>

<h3>Description</h3>

<p>Smooth a series by fitting the model to the data, smoothing the residuals,
and then putting the model predictions back.
</p>


<h3>Usage</h3>

<pre><code class="language-R">smooth_residuals(
  res,
  t0,
  outcomename,
  post.only = TRUE,
  smooth_k = SMOOTH_K,
  fit_model = fit_model_default,
  covariates = res,
  full_output = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>res</code></td>
<td>
<p>A dataframe with a month column and an 'outcomename' column (which
is the column that will be smoothed).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>t0</code></td>
<td>
<p>last pre-policy timepoint</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>outcomename</code></td>
<td>
<p>String name of the outcome variable in dat.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>post.only</code></td>
<td>
<p>If TRUE fit model and smooth post-policy only. WHY fit model
on post-policy data only?  Because this will make sure the fixed pre-policy
does not dominate too much?  We are focusing on post-policy so we want a
good fitting model for that so we can get our residuals as "white noise" as
possible before smoothing.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>smooth_k</code></td>
<td>
<p>A rough proxy for the number of observations to primarily
consider to kernal weight in the neighborhood of each timepoint (this is a
bandwidth, and the loess smoother gets smooth_k / n as a span value).  We
want to smooth with an absolute bandwidth, not one as function of how long
the time series is.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fit_model</code></td>
<td>
<p>A function that takes data, fits a linear model, and returns
the fit model. This function needs an option to include (or not) lagged
covariates.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>covariates</code></td>
<td>
<p>A dataframe with all covariates needed in the model fitting
defined by fit_model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>full_output</code></td>
<td>
<p>If TRUE give back pieces for diagnostics of smoothing
process.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>Use loess smoother on complete series of residuals including original data
pre-policy and synthetic data post policy (i.e., smooth the entire plausible
series).
</p>


<h3>Value</h3>

<p>A numeric vector of the smoothed residuals.  If full_output=TRUE
return a dataframe with several other columns: 'resid', the residuals based
on Ystar and the model, ‘residStar' the smoothed residuals, ’Ybar.sm' the
structural predictions of the model used for smoothing.  Here the smoothed
values will be 'Ysmooth'.
</p>


<h3>See Also</h3>

<p>See <code>smooth_series</code> for a more vanilla version that
smooths without the model fitting step.
</p>


<h3>Examples</h3>

<pre><code class="language-R">
data( "newjersey" )
smooth = smooth_series( newjersey, outcomename = "n.warrant", t0= -8,
                        smooth_k = 30,
                        post.only = FALSE)
plot( newjersey$month, newjersey$n.warrant )
lines( newjersey$month, smooth, col="red" )  

mod =  make_fit_season_model( ~ temperature )
newjersey = add_lagged_covariates( newjersey, outcomename = "n.warrant", 
                                   covariates = c("temperature") )

smooth = smooth_residuals( newjersey, outcomename = "n.warrant", t0=-8,
                           smooth_k = 30,
                           post.only = FALSE,
                           fit_model = mod )
plot( newjersey$month, newjersey$n.warrant )
lines( newjersey$month, smooth, col="red" )  
</code></pre>


</div>