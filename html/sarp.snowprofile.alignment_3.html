<div class="container">

<table style="width: 100%;"><tr>
<td>averageSPalongSeason</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Compute a seasonal timeseries of an average snowprofile</h2>

<h3>Description</h3>

<p>This routine computes the seasonal timeseries of the average snow profile for a given region/set of profiles. The total snow height of the
seasonal average profile closely follows the <em>median snow height</em> represented by the group of profiles each day. Also the
new snow amounts represent the <em>median new snow amounts</em> within the group (i.e., PP and DF grains). The routine maintains
temporal consistency by using the previous day average profile as initial condition to derive the next day's. This creates the need for re-scaling
the layer thicknesses each day to account for snow settlement and melting. Two different re-scaling approaches have been implemented,
which both aim to re-scale the old snow part of the column (i.e., the snow which was on the ground already at the previous day).
See parameter description for more details. Also note, that the routine can be started at any day of the season by providing
an average profile from the previous day. The routine modifies several parameters, which are passed on to dtwSP. These
parameters differ from the defaults specified in dtwSP, which are held very generic, whereas the application in this function
is much more specific to certain requirements and algorithm behavior. For more details, refer to the reference paper.
</p>


<h3>Usage</h3>

<pre><code class="language-R">averageSPalongSeason(
  SPx,
  sm = summary(SPx),
  AvgDayBefore = NULL,
  DateEnd = max(sm$date),
  keep.profiles = TRUE,
  progressbar = requireNamespace("progress", quietly = TRUE),
  dailyRescaling = c("settleTopOldSnow", "settleEntireOldSnow")[1],
  proportionPWL = 0.3,
  breakAtSim = 0.9,
  breakAfter = 2,
  verbose = FALSE,
  resamplingRate = 0.5,
  top.down = FALSE,
  checkGlobalAlignment = FALSE,
  prefLayerWeights = NA,
  dims = c("gtype", "hardness", "ddate"),
  weights = c(0.375, 0.125, 0.5),
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>SPx</code></td>
<td>
<p>a sarp.snowprofile::snowprofileSet that contains all profiles from the region to be averaged at all days of the season for which you want to compute the average profile.
Identically to dbaSP, weak layers need to be labeled prior to this function call, see dbaSP and sarp.snowprofile::labelPWL. Note that only daily sampling is
allowed at this point (i.e., one profile per grid point per day).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sm</code></td>
<td>
<p>a summary of <code>SPx</code> containing meta-data</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>AvgDayBefore</code></td>
<td>
<p>an average sarp.snowprofile::snowprofile from the previous day. This is only necessary if you want to resume the computation
mid season.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>DateEnd</code></td>
<td>
<p>an end date character string (<code>"YYYY-MM-DD"</code>) if you only want to compute the timeseries up to a certain point
in time. Defaults to the future-most date contained in the meta-data object <code>sm</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>keep.profiles</code></td>
<td>
<p>Do you want to keep the (resampled) individual snow profiles from <code>SPx</code> in your return object? <strong>Note</strong>
that this must be <code>TRUE</code> if you plan to backtrackLayers to derive any kind of summary statistics for the averaged layers.
See Notes below, and examples of how to conveniently backtrackLayers.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>progressbar</code></td>
<td>
<p>display a progress bar during computation?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dailyRescaling</code></td>
<td>
<p>choose between two settlement rescaling approaches. <code>settleEntireOldSnow</code> re-scales the entire old snow
column so that the average snow height represents the median snow height from the profile set. <code>settleTopOldSnow</code> (the default)
re-scales the upper part of the old snow column to achieve the same goal. While the former mostly leads to buried layers being
settled to too deep snow depths, the default approach aims to leave those buried layers unchanged, which are located at depths
that represent the median depths of their aligned layers.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>proportionPWL</code></td>
<td>
<p>decimal number that specifies the proportion required to average an ensemble of grain types as weak layer type.
A value of 0.3, for example, means that layers will get averaged to a PWL type if 30% of the layers are of PWL type.
Meaningful range is between <code style="white-space: pre;">⁠[0.1, 0.5]⁠</code>. Values larger than 0.5 get set to 0.5.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>breakAtSim</code></td>
<td>
<p>stop iterations when simSP between the last average profiles is beyond that value. Can range between <code style="white-space: pre;">⁠[0, 1]⁠</code>. Default values differ between dbaSP and averageSP.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>breakAfter</code></td>
<td>
<p>integer specifying how many values of simSP need to be above <code>breakAtSim</code> to stop iterating. Default values differ between dbaSP and averageSP.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>verbose</code></td>
<td>
<p>print similarities between old and new average in between iterations?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>resamplingRate</code></td>
<td>
<p>Resampling rate for a regular depth grid among the profiles</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>top.down</code></td>
<td>
<p>a dtwSP parameter, which needs to be set to <code>FALSE</code> to ensure correct growing of the snowpack during snowfall.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>checkGlobalAlignment</code></td>
<td>
<p>a dtwSP parameter, which needs to be set to <code>FALSE</code> analogous to <code>top.down</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>prefLayerWeights</code></td>
<td>
<p>a dtwSP parameter. Might be best to set this to <code>NA</code>, but can potentially be set to
<code>layerWeightingMat(FALSE)</code> <em>in case of</em> averaging a very large geographic region with temporal lags between weather events.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dims</code></td>
<td>
<p>a dtwSP parameter, which is modified to include deposition date alignments per default</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>weights</code></td>
<td>
<p>a dtwSP parameter that sets the according weights to the <code>dims</code> specified above.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>any other parameters passed on to dbaSP and then dtwSP.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>Computing the seasonal average profile for an entire season and about 100 grid points (with a max of 150 cm snow depth) takes roughly 60 mins.
</p>


<h3>Value</h3>

<p>A list of class <code>avgSP_timeseries</code> containing the fields <code style="white-space: pre;">⁠$avgs⁠</code> with a sarp.snowprofile::snowprofileSet of the average profiles at each day.
If <code>keep.profiles == TRUE</code> a field <code style="white-space: pre;">⁠$sets⁠</code> with the according profiles informing the average profile at each day (which can be
used to backtrackLayers to compute summary statistics of the averaged layers). And two fields <code style="white-space: pre;">⁠$call⁠</code> and <code style="white-space: pre;">⁠$meta⁠</code>. The
latter contains several useful meta-information such as <code>...$date</code>, <code>...$hs</code>, <code>...$hs_median</code>, <code>...$thicknessPPDF_median</code>, or <code>...$rmse</code>, which gauges
the representativity of the average profile (the closer to <code>0</code>, the better; the closer to <code>1</code>, the worse).
</p>


<h3>Note</h3>


<ul>
<li>
<p> If you don't provide an AvgDayBefore, it will be computed with averageSP and <em>default</em> parameters
(dots won't be passed to initializing the first average profile)!
</p>
</li>
<li>
<p> Even though backtrackLayers allows for backtracking layers based on height, it is not recommended to try and
backtrack layers if <code>keep.profiles = FALSE</code>, since profiles that can't be aligned to the average profile (<code style="white-space: pre;">⁠$avgs[[i]]⁠</code>)
are being discarded from the profile set at that day (<code style="white-space: pre;">⁠$sets[[i]]⁠</code>), which changes <code>queryID</code>s in the backtrackingTable.
Conclusion: If you want to backtrack layers from the seasonal average profile, you <em>must</em> <code>keep.profiles = TRUE</code>. See examples!
</p>
</li>
</ul>
<h3>Author(s)</h3>

<p>fherla
</p>


<h3>References</h3>

<p>Herla, F., Haegeli, P., and Mair, P. (2022). A data exploration tool for averaging and accessing large data sets of snow stratigraphy profiles useful for avalanche forecasting,
The Cryosphere, 16(8), 3149–3162, https://doi.org/10.5194/tc-16-3149-2022
</p>


<h3>See Also</h3>

<p>dbaSP, averageSP, sarp.snowprofile::labelPWL
</p>


<h3>Examples</h3>

<pre><code class="language-R">
run_the_examples &lt;- FALSE  # exclude long-running examples
if (run_the_examples) {

## compute average timeseries for simplistic example data set 'SPspacetime'
## first: label weak layers (you can choose your own rules and thresholds!)
SPspacetime &lt;- snowprofileSet(lapply(SPspacetime, function(sp) {
 labelPWL(sp, pwl_gtype = c("SH", "DH", "FC", "FCxr"), threshold_RTA = 0.8)
}))  # label weak layers in each profile of the profile set 'SPspacetime'

## second: average along several days
avgTS &lt;- averageSPalongSeason(SPspacetime)

## explore resulting object
names(avgTS)

# timeseries figure
plot(avgTS$avgs, main = "average time series")
# add line representing median snow height
lines(avgTS$meta$date, avgTS$meta$hs_median)
# add line representing median new snow amounts
lines(avgTS$meta$date, avgTS$meta$hs - avgTS$meta$thicknessPPDF_median, lty = 'dashed')

# individual profile sets from one day
plot(avgTS$sets[[1]], SortMethod = "hs", main = "individual profiles from first day")


## backtrack individual layers of the average profile...
individualLayers &lt;- backtrackLayers(avgProfile = avgTS$avgs[[1]],
                      profileSet = avgTS$sets[[1]],
                      layer = findPWL(avgTS$avgs[[1]], pwl_gtype = c("SH", "DH"),
                                      pwl_date = "2018-10-17", threshold_RTA = 0.8))
## ... to retrieve summary statistics or distributions, e.g. stability distribution
hist(individualLayers[[1]]$rta)
hist(individualLayers[[1]]$depth)

## see the Vignette about averaging profiles for more examples!


}

</code></pre>


</div>