<div class="container">

<table style="width: 100%;"><tr>
<td>ModelMatrix</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Model matrix from hierarchies and/or a formula</h2>

<h3>Description</h3>

<p>A common interface to <code>Hierarchies2ModelMatrix</code>, <code>Formula2ModelMatrix</code> and <code>HierarchiesAndFormula2ModelMatrix</code>
</p>


<h3>Usage</h3>

<pre><code class="language-R">ModelMatrix(
  data,
  hierarchies = NULL,
  formula = NULL,
  inputInOutput = TRUE,
  crossTable = FALSE,
  sparse = TRUE,
  viaOrdinary = FALSE,
  total = "Total",
  removeEmpty = !is.null(formula) &amp; is.null(hierarchies),
  modelMatrix = NULL,
  dimVar = NULL,
  select = NULL,
  ...
)

NamesFromModelMatrixInput(
  data = NULL,
  hierarchies = NULL,
  formula = NULL,
  dimVar = NULL,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>Matrix or data frame with data containing codes of relevant variables</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>hierarchies</code></td>
<td>
<p>List of hierarchies, which can be converted by <code>AutoHierarchies</code>.
Thus, the variables can also be coded by <code>"rowFactor"</code> or <code>""</code>, which correspond to using the categories in the data.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>formula</code></td>
<td>
<p>A model formula</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>inputInOutput</code></td>
<td>
<p>Logical vector (possibly recycled) for each element of hierarchies.
TRUE means that codes from input are included in output. Values corresponding to <code>"rowFactor"</code> or <code>""</code> are ignored.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>crossTable</code></td>
<td>
<p>Cross table in output when TRUE</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sparse</code></td>
<td>
<p>Sparse matrix in output when TRUE (default)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>viaOrdinary</code></td>
<td>
<p>When TRUE, output is generated by <code>model.matrix</code> or <code>sparse.model.matrix</code>.
Since these functions omit a factor level, an empty factor level is first added.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>total</code></td>
<td>
<p>String(s) used to name totals</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>removeEmpty</code></td>
<td>
<p>When <code>TRUE</code>, empty columns (only zeros) are not included in output.
Default is <code>TRUE</code> with formula input without hierarchy and otherwise <code>FALSE</code> (see details).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>modelMatrix</code></td>
<td>
<p>The model matrix as input (same as output)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dimVar</code></td>
<td>
<p>The main dimensional variables and additional aggregating variables. This parameter can be  useful when hierarchies and formula are unspecified.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>select</code></td>
<td>
<p>Data frame specifying variable combinations for output
or a named list specifying code selections for each variable (see details).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>Further arguments to  <code>Hierarchies2ModelMatrix</code>, <code>Formula2ModelMatrix</code> or <code>HierarchiesAndFormula2ModelMatrix</code></p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The default value of <code>removeEmpty</code> corresponds to the default settings of the underlying functions.
The functions <code>Hierarchies2ModelMatrix</code> and <code>HierarchiesAndFormula2ModelMatrix</code>
have <code>removeEmpty</code> as an explicit parameter with <code>FALSE</code> as default.
The function <code>Formula2ModelMatrix</code> is a wrapper for <code>FormulaSums</code>,
which has a parameter <code>includeEmpty</code> with <code>FALSE</code> as default.
Thus, <code>ModelMatrix</code> makes a call to <code>Formula2ModelMatrix</code> with <code>includeEmpty = !removeEmpty</code>.
</p>
<p><code>NamesFromModelMatrixInput</code> returns the names of the data columns involved in creating the model matrix.
Note that <code>data</code> must be non-NULL to convert dimVar as indices to names.
</p>
<p>The <code>select</code> parameter is forwarded to <code>Hierarchies2ModelMatrix</code> unless <code>removeEmpty = TRUE</code> is combined with <code>select</code> as a data frame.
In all other cases, <code>select</code> is handled outside the underlying functions by making selections in the result.
Empty columns can be added to the model matrix when <code>removeEmpty = FALSE</code> (with warning).
</p>


<h3>Value</h3>

<p>A (sparse) model matrix or a list of two elements (model matrix and cross table)
</p>


<h3>Author(s)</h3>

<p>Ã˜yvind Langsrud
</p>


<h3>See Also</h3>

<p>formula_utils
</p>


<h3>Examples</h3>

<pre><code class="language-R"># Create some input
z &lt;- SSBtoolsData("sp_emp_withEU")
ageHier &lt;- data.frame(mapsFrom = c("young", "old"), mapsTo = "Total", sign = 1)
geoDimList &lt;- FindDimLists(z[, c("geo", "eu")], total = "Europe")[[1]]

# Small dataset example. Two dimensions.
s &lt;- z[z$geo == "Spain" &amp; z$year != 2016, ]
rownames(s) &lt;- NULL
s

# via Hierarchies2ModelMatrix() and converted to ordinary matrix (not sparse)
ModelMatrix(s, list(age = ageHier, year = ""), sparse = FALSE)

# Hierarchies generated automatically. Then via Hierarchies2ModelMatrix()
ModelMatrix(s[, c(1, 4)])

# via Formula2ModelMatrix()
ModelMatrix(s, formula = ~age + year)

# via model.matrix() after adding empty factor levels
ModelMatrix(s, formula = ~age + year, sparse = FALSE, viaOrdinary = TRUE)

# via sparse.model.matrix() after adding empty factor levels
ModelMatrix(s, formula = ~age + year, viaOrdinary = TRUE)

# via HierarchiesAndFormula2ModelMatrix() and using different data and parameter settings
ModelMatrix(s, list(age = ageHier, geo = geoDimList, year = ""), formula = ~age * geo + year, 
            inputInOutput = FALSE, removeEmpty = TRUE, crossTable = TRUE)
ModelMatrix(s, list(age = ageHier, geo = geoDimList, year = ""), formula = ~age * geo + year, 
            inputInOutput = c(TRUE, FALSE), removeEmpty = FALSE, crossTable = TRUE)
ModelMatrix(z, list(age = ageHier, geo = geoDimList, year = ""), formula = ~age * year + geo, 
            inputInOutput = c(FALSE, TRUE), crossTable = TRUE)
            
# via Hierarchies2ModelMatrix() using unnamed list element. See AutoHierarchies.             
colnames(ModelMatrix(z, list(age = ageHier, c(Europe = "geo", Allyears = "year", "eu"))))
colnames(ModelMatrix(z, list(age = ageHier, c("geo", "year", "eu")), total = c("t1", "t2")))

# Example using the select parameter as a data frame
select &lt;- data.frame(age = c("Total", "young", "old"), geo = c("EU", "nonEU", "Spain"))
ModelMatrix(z, list(age = ageHier, geo = geoDimList), 
            select = select, crossTable = TRUE)$crossTable
            
# Examples using the select parameter as a list
ModelMatrix(z, list(age = ageHier, geo = geoDimList), inputInOutput = FALSE, 
            select = list(geo = c("nonEU", "Portugal")), crossTable = TRUE)$crossTable
ModelMatrix(z, list(age = ageHier, geo = geoDimList), 
            select = list(geo = c("nonEU", "Portugal"), age = c("Total", "young")), 
            crossTable = TRUE)$crossTable

# Using NAomit parameter avalable in Formula2ModelMatrix()
s$age[1] &lt;- NA
ModelMatrix(s, formula = ~age + year)
ModelMatrix(s, formula = ~age + year, NAomit = FALSE)

</code></pre>


</div>