<div class="container">

<table style="width: 100%;"><tr>
<td>calibrate_to_estimate</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Calibrate weights from a primary survey to estimated totals from a control survey,
with replicate-weight adjustments that account for variance of the control totals</h2>

<h3>Description</h3>

<p>Calibrate the weights of a primary survey to match estimated totals from a control survey,
using adjustments to the replicate weights to account for the variance of the estimated control totals.
The adjustments to replicate weights are conducted using the method proposed by Fuller (1998).
This method can be used to implement general calibration as well as post-stratification or raking specifically
(see the details for the <code>calfun</code> parameter).
</p>


<h3>Usage</h3>

<pre><code class="language-R">calibrate_to_estimate(
  rep_design,
  estimate,
  vcov_estimate,
  cal_formula,
  calfun = survey::cal.linear,
  bounds = list(lower = -Inf, upper = Inf),
  verbose = FALSE,
  maxit = 50,
  epsilon = 1e-07,
  variance = NULL,
  col_selection = NULL
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>rep_design</code></td>
<td>
<p>A replicate design object for the primary survey, created with either the <code>survey</code> or <code>srvyr</code> packages.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>estimate</code></td>
<td>
<p>A vector of estimated control totals.
The names of entries must match the names from calling <code>svytotal(x = cal_formula, design = rep_design)</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>vcov_estimate</code></td>
<td>
<p>A variance-covariance matrix for the estimated control totals.
The column names and row names must match the names of <code>estimate</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cal_formula</code></td>
<td>
<p>A formula listing the variables to use for calibration.
All of these variables must be included in <code>rep_design</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>calfun</code></td>
<td>
<p>A calibration function from the <code>survey</code> package,
such as cal.linear, cal.raking, or cal.logit.
Use <code>cal.linear</code> for ordinary post-stratification, and <code>cal.raking</code> for raking.
See calibrate for additional details.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bounds</code></td>
<td>
<p>Parameter passed to grake for calibration. See calibrate for details.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>verbose</code></td>
<td>
<p>Parameter passed to grake for calibration. See calibrate for details.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>maxit</code></td>
<td>
<p>Parameter passed to grake for calibration. See calibrate for details.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>epsilon</code></td>
<td>
<p>Parameter passed to grake for calibration. <br>
After calibration, the absolute difference between each calibration target and the calibrated estimate
will be no larger than <code>epsilon</code> times (1 plus the absolute value of the target).
See calibrate for details.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>variance</code></td>
<td>
<p>Parameter passed to grake for calibration. See calibrate for details.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>col_selection</code></td>
<td>
<p>Optional parameter to determine which replicate columns
will have their control totals perturbed. If supplied, <code>col_selection</code> must be an integer vector
with length equal to the length of <code>estimate</code>.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>With the Fuller method, each of <code>k</code> randomly-selected replicate columns from the primary survey
are calibrated to control totals formed by perturbing the <code>k</code>-dimensional vector of
estimated control totals using a spectral decomposition of the variance-covariance matrix
of the estimated control totals. Other replicate columns are simply calibrated to the unperturbed control totals.
<br></p>
<p>Because the set of replicate columns whose control totals are perturbed should be random,
there are multiple ways to ensure that this matching is reproducible.
The user can either call set.seed before using the function,
or supply a vector of randomly-selected column indices to the argument <code>col_selection</code>.
</p>


<h3>Value</h3>

<p>A replicate design object, with full-sample weights calibrated to totals from <code>estimate</code>,
and replicate weights adjusted to account for variance of the control totals.
The element <code>col_selection</code> indicates, for each replicate column of the calibrated primary survey,
which column of replicate weights it was matched to from the control survey.
</p>


<h3>Syntax for Common Types of Calibration</h3>

<p>For ratio estimation with an auxiliary variable <code>X</code>,
use the following options: <br>
- <code>cal_formula = ~ -1 + X</code> <br>
- <code>variance = 1</code>, <br>
- <code>cal.fun = survey::cal.linear</code>
</p>
<p>For post-stratification, use the following option:
</p>
<p>- <code>cal.fun = survey::cal.linear</code>
</p>
<p>For raking, use the following option:
</p>
<p>- <code>cal.fun = survey::cal.raking</code>
</p>


<h3>References</h3>

<p>Fuller, W.A. (1998).
"Replication variance estimation for two-phase samples."
<strong>Statistica Sinica</strong>, <em>8</em>: 1153-1164.
</p>
<p>Opsomer, J.D. and A. Erciulescu (2021).
"Replication variance estimation after sample-based calibration."
<strong>Survey Methodology</strong>, <em>47</em>: 265-277.
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Not run: 

# Load example data for primary survey ----

  suppressPackageStartupMessages(library(survey))
  data(api)

  primary_survey &lt;- svydesign(id=~dnum, weights=~pw, data=apiclus1, fpc=~fpc) |&gt;
    as.svrepdesign(type = "JK1")

# Load example data for control survey ----

  control_survey &lt;- svydesign(id = ~ 1, fpc = ~fpc, data = apisrs) |&gt;
    as.svrepdesign(type = "JK1")

# Estimate control totals ----

  estimated_controls &lt;- svytotal(x = ~ stype + enroll,
                                 design = control_survey)
  control_point_estimates &lt;- coef(estimated_controls)
  control_vcov_estimate &lt;- vcov(estimated_controls)

# Calibrate totals for one categorical variable and one numeric ----

  calibrated_rep_design &lt;- calibrate_to_estimate(
    rep_design = primary_survey,
    estimate = control_point_estimates,
    vcov_estimate = control_vcov_estimate,
    cal_formula = ~ stype + enroll
  )

# Inspect estimates before and after calibration ----

  ##_ For the calibration variables, estimates and standard errors
  ##_ from calibrated design will match those of the control survey

    svytotal(x = ~ stype + enroll, design = primary_survey)
    svytotal(x = ~ stype + enroll, design = control_survey)
    svytotal(x = ~ stype + enroll, design = calibrated_rep_design)

  ##_ Estimates from other variables will be changed as well

    svymean(x = ~ api00 + api99, design = primary_survey)
    svymean(x = ~ api00 + api99, design = control_survey)
    svymean(x = ~ api00 + api99, design = calibrated_rep_design)

# Inspect weights before and after calibration ----

  summarize_rep_weights(primary_survey, type = 'overall')
  summarize_rep_weights(calibrated_rep_design, type = 'overall')

# For reproducibility, specify which columns are randomly selected for Fuller method ----

  column_selection &lt;- calibrated_rep_design$col_selection
  print(column_selection)

  calibrated_rep_design &lt;- calibrate_to_estimate(
    rep_design = primary_survey,
    estimate = control_point_estimates,
    vcov_estimate = control_vcov_estimate,
    cal_formula = ~ stype + enroll,
    col_selection = column_selection
  )

## End(Not run)
</code></pre>


</div>