<div class="container">

<table style="width: 100%;"><tr>
<td>spaMM</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Inference in mixed models, in particular spatial GLMMs</h2>

<h3>Description</h3>

<p>Fits a range of mixed-effect models, including those with spatially correlated random effects. The random effects are either Gaussian (which defines GLMMs), or other distributions (which defines the wider class of hierarchical GLMs), or simply absent (which makes a LM or GLM).  Multivariate-response models can be fitted by the <code>fitmv</code> function. Other models can be fitted by <code>fitme</code>. Also available are previously conceived fitting functions <code>HLfit</code> (sometimes faster, for non-spatial models), <code>HLCor</code> (sometimes faster, for conditional-autoregressive models and fixed-correlation models), and <code>corrHLfit</code> (now of lesser interest). A variety of post-fit procedures are available for prediction, simulation and testing (see, e.g., <code>fixedLRT</code>, <code>simulate</code> and <code>predict</code>).
</p>
<p>A variety of special syntaxes for fixed effects, such as <code>poly</code>, <code>splines::</code><code>ns</code> or <code>bs</code>, or <code>lmDiallel::GCA</code>, may be handled natively although some might not be fully handled by post-fit procedures such as <code>predict</code>. <code>poly</code> is fully handled. <code>lmDiallel::GCA</code> cannot be due to its inherent limitations, but see <code>X.GCA</code> for a more functional alternative for diallel/multi-membership fixed-effect terms. Note that packages implementing these terms must be attached to the search list as <code>::</code> will not be properly understood in a <code>formula</code>. 
</p>
<p>Both maximum likelihood (ML) and restricted likelihood (REML) can be used for linear mixed models, and extensions of these methods using Laplace approximations are used for non-Gaussian random response. Several variants of these methods discussed in the literature are included (see Details in <code>HLfit</code>), the most notable of which may be “PQL/L” for binary-response GLMMs (see Example for <code>arabidopsis</code> data). PQL methods implemented in spaMM are closer to (RE)ML methods than those implemented in <code>MASS::glmmPQL</code>. 
</p>


<h3>Details</h3>

<p>The standard response families <code>gaussian</code>, <code>binomial</code>, <code>poisson</code>, and <code>Gamma</code> are handled, as well as negative binomial (see <code>negbin1</code> and <code>negbin2</code>), beta (<code>beta_resp</code>), beta-binomial (<code>betabin</code>), zero-truncated poisson and negative binomial and Conway-Maxwell-Poisson response (see <code>Tpoisson</code>, <code>Tnegbin</code> and <code>COMPoisson</code>). A <code>multi</code> family look-alike is also available for <code>multinomial</code> response, with some constraints. 
</p>
<p>The variance parameter of residual error is denoted <code class="reqn">\phi</code> (<code>phi</code>): this is the residual variance for gaussian response, but for Gamma-distributed response, the residual variance is <code class="reqn">\phi</code><code class="reqn">\mu^2</code> where <code class="reqn">\mu</code> is expected response. A (possibly mixed-effects) linear predictor for <code class="reqn">\phi</code>, modeling heteroscedasticity, can be considered (see Examples). 
</p>
<p>The package fits models including several nested or crossed random effects, including autocorrelated ones. An interface is being developed allowing users to implement their own parametric correlation models (see <code>corrFamily</code>), beyond the following ones which are built in <span class="pkg">spaMM</span>:<br><code style="white-space: pre;">⁠ ⁠</code> * geostatistical (<code>Matern</code>, <code>Cauchy</code>),<br><code style="white-space: pre;">⁠ ⁠</code> * interpolated Markov Random Fields (<code>IMRF</code>, <code>MaternIMRFa</code>),<br><code style="white-space: pre;">⁠ ⁠</code> * autoregressive time-series (<code>AR1</code>, <code>ARp</code>, <code>ARMA</code>),<br><code style="white-space: pre;">⁠ ⁠</code> * conditional autoregressive as specified by an <code>adjacency</code> matrix,<br><code style="white-space: pre;">⁠ ⁠</code> * pairwise interactions with individual-level random effects, such as diallel experiments (<code>diallel</code>),<br><code style="white-space: pre;">⁠ ⁠</code> * or any fixed correlation matrix (<code>corrMatrix</code>). 
</p>
<p>GLMMs and HGLMs are fit via Laplace approximations for (1) the marginal likelihood with respect to random effects and (2) the restricted likelihood (as in REML), i.e. the likelihood of random effect parameters given the fixed effect estimates. All handled models can be formulated in terms of a linear predictor of the traditional form <code>offset</code>+ <b>X</b><code class="reqn">\beta</code> + <b>Z b</b>, where <b>X</b> is the design matrix of fixed effects, <code class="reqn">\beta</code> (<code>beta</code>) is a vector of fixed-effect coefficients, <b>Z</b> is a “design matrix” for the random effects (which is instead denoted <b>M</b>=<b>ZAL</b> elsewhere in the package documentation), and <b>b</b> a vector of random effect values. The general structure of <b>Mb</b> is described in <code>random-effects</code>.
</p>
<p>Gaussian and non-gaussian random effects can be fitted. Different <strong>gaussian</strong> random-effect terms are handled, with the following effects:<br></p>
<pre>
* (1|&lt;RHS&gt;), for non-autocorrelated random effects as in lme4;
* (&lt;LHS&gt;|&lt;RHS&gt;), for random-coefficient terms as in lme4, *and 
   additional terms depending on the &lt;LHS&gt; type* (further detailed below);
* (&lt;LHS&gt; || &lt;RHS&gt;) is interpreted as in lme4: any such term is immediately 
   converted to ( (1|&lt;RHS&gt;) + (0+&lt;LHS&gt;|&lt;RHS&gt;) ). It should be counted as two 
   random effects for all purposes (e.g., for fixing the variances of the 
   random effects). However, this syntax is useless when the LHS includes a 
   factor (see help('lme4::expandDoubleVerts')).
* &lt;prefix&gt;(1|&lt;RHS&gt;), to specify autocorrelated random effects, 
   e.g. Matern(1|long+lat). 
* &lt;prefix&gt;(&lt;LHS&gt;|&lt;RHS&gt;), where the &lt;LHS&gt; can be used to alter the 
   autocorrelated random effect as detailed below. 
</pre>   
<p>Different LHS types of <strong>gaussian</strong> <code>(&lt;LHS&gt;|&lt;RHS&gt;)</code> random-effect terms are handled, with the following effects:
</p>
<pre>
* &lt;logical&gt; (TRUE/FALSE): affects only responses for which &lt;LHS&gt; is TRUE. 
* &lt;factor built from a logical&gt;: same a &lt;logical&gt; case;
* &lt;factor not built from a logical&gt;: random-coefficient term as in lme4;
* 0 + &lt;factor not built from a logical&gt;: same but contrasts are not used;
* factors specified by the mv(...) expression, generate random-coefficient 
  terms specific to multivariate-response models fitted by fitmv() (see 
  help("mv")). 0 + mv(...) has the expected effect of not using contrasts; 
* &lt;numeric&gt; (but not '0+&lt;numeric&gt;'): random-coefficient term as in lme4, 
  with 2*2 covariance matrix of effects on Intercept and slope;
* 0 + &lt;numeric&gt;: no Intercept so no covariance matrix (random-slope-only 
   term);
</pre>
<p>The '0 + &lt;numeric&gt;' effect is achieved by direct control of the elements of the incidence matrix <b>Z</b> through the <code>&lt;LHS&gt;</code> term: for numeric <code>z</code>, such elements are multiplied by <code>z</code> values, and thus provide a variance of order O(<code>z</code> <b>squared</b>).
</p>
<p>If one wishes to fit uncorrelated group-specific random-effects with distinct variances for different groups or for different response variables, three syntaxes are thus possible. The most general, suitable for fitting several variances (see <code>GxE</code> for an example), is to fit a (0 + &lt;factor&gt;| &lt;RHS&gt;) random-coefficient term with correlation(s) fixed to 0. Alternatively, one can define <b>numeric</b> (0|1) variables for each group (as <code>as.numeric(&lt;boolean for given group membership&gt;)</code>), and use each of them in a <code style="white-space: pre;">⁠0 + &lt;numeric&gt;⁠</code> LHS (so that the variance of each such random effect is zero for response not belonging to the given group). See <code>lev2bool</code> for various ways of specifying such indicator variables for several levels.
</p>
<p><strong>Gaussian</strong> <code>&lt;prefix&gt;(&lt;LHS not 1&gt;|&lt;RHS&gt;)</code> random-effect terms may be handled, with two main cases depending on the LHS type, motivated by the following example: independent Matérn effects can be fitted for males and females by using the syntax <code>Matern(male|.) + Matern(female|.)</code>, where <code>male</code> and <code>female</code> are TRUE/FALSE (or a factor with TRUE/FALSE levels). In contrast to a <code>(male|.)</code> term, no random-coefficient correlation matrix is fitted. However, for some other types of RHS, one can fit <em>composite random effects</em> combining a random-coefficient correlation matrix and the correlation model defined by the “prefix”. This combination is defined in <code>composite-ranef</code>. This leads to the following distinction:<br><code style="white-space: pre;">⁠   ⁠</code> * The terms are *not* composite random effects when the non-‘<code>1</code>’ LHS type is boolean or factor-from-boolean, a just illustrated, but also <code>0+&lt;numeric&gt;</code>: for example, <code>Matern(0+&lt;numeric&gt;|.)</code> represents an autocorrelated random-slope (only) term or, equivalently, a direct specification of heteroscedasticity of the Matérn random effect.<br><code style="white-space: pre;">⁠   ⁠</code> * By contrast, <code>Matern(&lt;numeric&gt;|.)</code> implies estimating a random-coefficient covariance matrix and thus defines a composite random effects, as does an LHS that is a factor constructed from numeric or character levels.<br> 
Composite random effects can be fitted in principle for all “prefixes”, including for <code>&lt;corrFamily&gt;</code> terms. In practice, this functionality has been checked for <code>Matern</code>, <code>corrMatrix</code>, <code>AR1</code> and the <code>ARp</code>-corrFamily term. In these terms, the <code>&lt;.&gt; %in% &lt;.&gt;</code> form of nested random effect is allowed. 




</p>
<p>The syntax <code>(z-1|.)</code>, for <b>numeric</b> <code>z</code> only, can also be used to fit <strong>some heteroscedastic non-Gaussian</strong> random effects. For example, a Gamma random-effect term <code>(wei-1|block)</code> specifies an heteroscedastic Gamma random effect <code class="reqn">u</code> with constant mean 1 and variance <code>wei^2</code> <code class="reqn">\lambda</code>, where <code class="reqn">\lambda</code> is still the estimated variance parameter. See Details of <code>negbin</code> for a possible application. Here, this effect is not implemented through direct control of <b>Z</b> (multiplying the elements of an incidence matrix <b>Z</b> by <code>wei</code>), as this would have a different effect on the distribution of the random effect term. <code>(z|.)</code> is not defined for <em>non-Gaussian</em> random effects. It could mean that a correlation structure between random intercepts and random slopes for (say) Gamma-distributed random effects is considered, but such correlation structures are not well-specified by their correlation matrix. 
</p>


<h3>Author(s)</h3>

<p><code>spaMM</code> was initially published by François Rousset and Jean-Baptiste Ferdy, and is continually developed by F. Rousset and tested by Alexandre Courtiol.  
</p>


<h3>References</h3>

<p>Lee, Y., Nelder, J. A. and Pawitan, Y. (2006). Generalized linear models with random effects: unified analysis via
h-likelihood. Chapman &amp; Hall: London.
</p>
<p>Rousset F., Ferdy, J.-B. (2014) Testing environmental and genetic effects in the presence of spatial autocorrelation. Ecography, 37: 781-790.
<a href="https://doi.org/10.1111/ecog.00566">doi:10.1111/ecog.00566</a>
</p>


<h3>See Also</h3>

<p>See the <code>test</code> directory of the package for many additional examples of <span class="pkg">spaMM</span> usage beyond those from the formal documentation. 
</p>
<p>See <code>fitme</code> for multivariate-response models. 
</p>


<h3>Examples</h3>

<pre><code class="language-R">data("wafers")
data("scotlip") ## loads 'scotlip' data frame, but also 'Nmatrix'

##     Linear model
fitme(y ~ X1, data=wafers)

##     GLM
fitme(y ~ X1, family=Gamma(log), data=wafers)
fitme(cases ~ I(log(population)), data=scotlip, family=poisson)

##     Non-spatial GLMMs
fitme(y ~ 1+(1|batch), family=Gamma(log), data=wafers)
fitme(cases ~ 1+(1|gridcode), data=scotlip, family=poisson)
#
# Random-slope model (mind the output!)        
fitme(y~X1+(X2|batch),data=wafers, method="REML")

## Spatial, conditional-autoregressive GLMM
if (spaMM.getOption("example_maxtime")&gt;2) {   
  fitme(cases ~ I(log(population))+adjacency(1|gridcode), data=scotlip, family=poisson, 
        adjMatrix=Nmatrix) # with adjacency matrix provided by data("scotlip")
} 
# see ?adjacency for more details on these models 

## Spatial, geostatistical GLMM: 
# see e.g. examples in ?fitme, ?corrHLfit, ?Loaloa, or ?arabidopsis;
# see examples in ?Matern for group-specific spatial effects.

##     Hierachical GLMs with non-gaussian random effects
 data("salamander")
if (spaMM.getOption("example_maxtime")&gt;1) {   
 # both gaussian and non-gaussian random effects
 fitme(cbind(Mate,1-Mate)~1+(1|Female)+(1|Male),family=binomial(),
        rand.family=list(gaussian(),Beta(logit)),data=salamander)
 
 # Random effect of Male nested in that of Female:
 fitme(cbind(Mate,1-Mate)~1+(1|Female/Male),
       family=binomial(),rand.family=Beta(logit),data=salamander)
 # [ also allowed is cbind(Mate,1-Mate)~1+(1|Female)+(1|Male %in% Female) ]
}

##    Modelling residual variance ( = structured-dispersion models)    
# GLM response, fixed effects for residual variance 
fitme( y ~ 1,family=Gamma(log),
      resid.model = ~ X3+I(X3^2) ,data=wafers)
#
# GLMM response, and mixed effects for residual variance
if (spaMM.getOption("example_maxtime")&gt;1.5) {   
  fitme(y ~ 1+(1|batch),family=Gamma(log),
        resid.model = ~ 1+(1|batch) ,data=wafers)
}

</code></pre>


</div>