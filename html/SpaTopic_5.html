<div class="container">

<table style="width: 100%;"><tr>
<td>SpaTopic_inference</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>'SpaTopic': fast topic inference to identify tissue architecture in multiplexed images</h2>

<h3>Description</h3>

<p>This is the main function of 'SpaTopic', implementing a Collapsed Gibbs
Sampling algorithm to learn topics, which referred to different tissue microenvironments, 
across multiple multiplexed tissue images. 
The function takes cell labels and coordinates on tissue images as input,
and returns the inferred topic labels for every cell, as well as topic contents, a distribution
over celltypes.
The function recovers spatial tissue architectures across images, 
as well as indicating cell-cell interactions in each domain.
</p>


<h3>Usage</h3>

<pre><code class="language-R">SpaTopic_inference(
  tissue,
  ntopics,
  sigma = 50,
  region_radius = 400,
  kneigh = 5,
  npoints_selected = 1,
  ini_LDA = TRUE,
  ninit = 10,
  niter_init = 100,
  beta = 0.05,
  alpha = 0.01,
  trace = FALSE,
  seed = 123,
  thin = 20,
  burnin = 1000,
  niter = 200,
  display_progress = TRUE,
  do.parallel = FALSE,
  n.cores = 1,
  axis = "2D"
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>tissue</code></td>
<td>
<p>(Required). A data frame or a list of data frames. One for each image. 
Each row represent a cell with its image ID, X, Y coordinates on the image, celltype,
with column names (image, X, Y, type), respectively. You may add another column 
Y2 for 3D tissue image.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ntopics</code></td>
<td>
<p>(Required). Number of topics. Topics will be obtained as distributions 
of cell types.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sigma</code></td>
<td>
<p>Default is 50. The lengthscale of the Nearest-neighbor Exponential Kernel.
Sigma controls the strength of decay of correlation with distance in the kernel function.
Please check the paper for more information. 
Need to be adjusted based on the image resolution</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>region_radius</code></td>
<td>
<p>Default is 400. The radius for each grid square when
sampling region centers for each image. 
Need to be adjusted based on the image resolution and pattern complexity.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>kneigh</code></td>
<td>
<p>Default is 5. Only consider the top 5 closest region centers for each cell.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>npoints_selected</code></td>
<td>
<p>Default is 1. Number of points sampled for each grid square 
when sampling region centers for each image. Used with <code>region_radius</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ini_LDA</code></td>
<td>
<p>Default is TRUE. Use warm start strategy for initialization and choose the best one
to continue. If 0, it simply uses the first initialization.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ninit</code></td>
<td>
<p>Default is 10. Number of initialization. 
Only retain the initialization with the highest log likelihood (perplexity).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>niter_init</code></td>
<td>
<p>Default is 100. Warm start with 100 iterations in the Gibbs sampling 
during initialization.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>beta</code></td>
<td>
<p>Default is 0.05. A hyperparameter to control the sparsity of topic content
(topic-celltype) matrix <code>Beta</code>. A smaller value introduces more sparse in <code>Beta</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>alpha</code></td>
<td>
<p>Default is 0.01. A hyperparameter to control the sparsity of document (region) content
(region-topic) matrix <code>Theta</code>. For our application, we keep it 
very small for the sparsity in <code>Theta</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>trace</code></td>
<td>
<p>Default is FALSE. Compute and save log likelihood, <code>Ndk</code>, <code>Nwk</code> 
for every posterior samples. Useful when you want to use DIC to select number of 
topics, but it is time consuming to compute the likelihood for every posterior samples.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>seed</code></td>
<td>
<p>Default is 123. Random seed.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>thin</code></td>
<td>
<p>Default is 20. Key parameter in Gibbs sampling. 
Collect a posterior sample for every thin=20 iterations.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>burnin</code></td>
<td>
<p>Default is 1000. Key parameter in Gibbs sampling.
Start to collect posterior samples after 1000 iterations. You may increase
the number of iterations for burn-in for highly complex tissue images.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>niter</code></td>
<td>
<p>Default is 200. Key parameter in Gibbs sampling. 
Number of posterior samples collected for model inference.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>display_progress</code></td>
<td>
<p>Default is TRUE. Display the progress bar.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>do.parallel</code></td>
<td>
<p>Default is FALSE. Use parallel computing through R package <code>foreach</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>n.cores</code></td>
<td>
<p>Default is 1. Number of cores used in parallel computing.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>axis</code></td>
<td>
<p>Default is "2D". You may switch to "3D" for 3D tissue images. 
However, the model inference for 3D tissue is still under test.</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>Return a <code>gibbs.res-class</code> object. A list of outputs from Gibbs sampling.
</p>


<h3>See Also</h3>

<p><code>gibbs.res-class</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">
## tissue is a data frame containing cellular information from one image or
## multiple data frames from multiple images.

data("lung5")
## NOT RUN, it takes about 90s
library(sf)
#gibbs.res&lt;-SpaTopic_inference(lung5, ntopics = 7,
#                               sigma = 50, region_radius = 400)
                             
                              
## generate a fake image 2 and make an example for multiple images
## NOT RUN
#lung6&lt;-lung5
#lung6$image&lt;-"image2"  ## The image ID of two images should be different
#gibbs.res&lt;-SpaTopic_inference(list(A = lung5, B = lung6), 
#                 ntopics = 7, sigma = 50, region_radius = 400) 

</code></pre>


</div>