<div class="container">

<table style="width: 100%;"><tr>
<td>compare_screenshot_threshold</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Compare screenshots given threshold value</h2>

<h3>Description</h3>

<p><span class="pkg">chromote</span> can sometimes produce screenshot images with non-deterministic
(yet close) color values. This can happen in locations such as rounded
corners of <code>div</code>s or <code>textarea</code>s.
</p>


<h3>Usage</h3>

<pre><code class="language-R">compare_screenshot_threshold(
  old,
  new,
  ...,
  threshold = NULL,
  kernel_size = 5,
  quiet = FALSE
)

screenshot_max_difference(old, new = missing_arg(), ..., kernel_size = 5)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>old</code></td>
<td>
<p>Current screenshot file path</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>new</code></td>
<td>
<p>New screenshot file path</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>Must be empty. Allows for parameter expansion.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>threshold</code></td>
<td>
<p>If the value of <code>threshold</code> is <code>NULL</code>,
<code>compare_screenshot_threshold()</code> will act like
<code>testthat::compare_file_binary</code>. However, if <code>threshold</code> is a positive
number, it will be compared against the largest convolution value found if
the two images fail a <code>testthat::compare_file_binary</code> comparison. The max
value that can be found is <code>4 * kernel_size ^ 2</code>.
</p>
<p>Threshold values values below 5 help deter
false-positive screenshot comparisons (such as inconsistent rounded
corners). Larger values in the 10s and 100s will help find <em>real</em>
changes. However, not all values are one size fits all and you will need
to play with a threshold that fits your needs.
</p>
<p>To find the current difference between two images, use
<code>screenshot_max_difference()</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>kernel_size</code></td>
<td>
<p>The <code>kernel_size</code> represents the height and width of the
convolution kernel applied to the matrix of pixel differences. This
integer-like value should be relatively small, such as 5.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>quiet</code></td>
<td>
<p>If <code>FALSE</code> and the value is larger than <code>threshold</code>, then a
message is printed to the console. This is helpful when getting a failing
image and being informed about how different the <code>new</code> image is from the
<code>old</code> image.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>These differences make comparing screenshots impractical using traditional
expectation methods as false-positives are produced often over time. To
mitigate this, we can use a <em>fuzzy matching</em> algorithm that can tolerate
small regional differences throughout the image. If the local changes found
are larger than the <code>threshold</code>, then the images are determined to be
different. Both the screenshot difference <code>threshold</code> and the size of the
kernel (<code>kernel_size</code>) can be set to tune the false positive rate.
</p>


<h3>Functions</h3>


<ul>
<li> <p><code>compare_screenshot_threshold()</code>: Compares two images and allows for a <code>threshold</code> difference of <em>so many</em>
units in each RGBA color channel.
</p>
<p>It is suggested to use this method with
<code>AppDriver</code><code style="white-space: pre;">⁠$expect_screenshot(threshold=, kernel_size=)⁠</code> to make
expectations on screenshots given particular <code>threshold</code> and <code>kernel_size</code>
values.
</p>
</li>
<li> <p><code>screenshot_max_difference()</code>: Finds the difference between two screenshots.
</p>
<p>This value can be used in <code>compare_screenshot_threshold(threshold=)</code>. It is
recommended that the value used for <code>compare_screenshot_threshold(threshold=)</code>
is larger than the immediate max difference found. This allows for random
fluctuations when rounding sub pixels.
</p>
<p>If <code>new</code> is missing, it will use the file value of <code>old</code> (<code>FILE.png</code>) and
default to <code>FILE.new.png</code>
</p>
</li>
</ul>
<h3>Algorithm for the difference between two screenshots</h3>


<ol>
<li>
<p> First the two images are compared using
<code>testthat::compare_file_binary()</code>. If the files are identical, return
<code>TRUE</code> that the screenshot images are the same.
</p>
</li>
<li>
<p> If <code>threshold</code> is <code>NULL</code>, return <code>FALSE</code> as the convolution will not
occur.
</p>
</li>
<li>
<p> Prepare the screenshot difference matrix by reading the RGBA channels of
each image and find their respective absolute differences
</p>
</li>
<li>
<p> Sum the screenshot difference matrix channels at each pixel location
</p>
</li>
<li>
<p> Perform a convolution using a small square kernel matrix that is
<code>kernel_size</code> big and filled with <code>1</code>s.
</p>
</li>
<li>
<p> Find the largest value in the resulting convolution matrix.
</p>
</li>
<li>
<p> If this max convolution value is larger than <code>threshold</code>, return <code>FALSE</code>,
images are different.
</p>
</li>
<li>
<p> Otherwise, return <code>TRUE</code>, images are the same.
</p>
</li>
</ol>
<h3>Examples</h3>

<pre><code class="language-R">img_folder &lt;- system.file("example/imgs/", package = "shinytest2")
slider_old &lt;- fs::path(img_folder, "slider-old.png")
slider_new &lt;- fs::path(img_folder, "slider-new.png")

# Can you see the differences between these two images?
showimage::show_image(slider_old)
showimage::show_image(slider_new)

# You might have caught the difference between the two images!
slider_diff &lt;- fs::path(img_folder, "slider-diff.png")
showimage::show_image(slider_diff)

# Let's find the difference between the two images
screenshot_max_difference(slider_old, slider_new)
# ~ 28

# Using different threshold values...
compare_screenshot_threshold(slider_old, slider_new, threshold = NULL)
#&gt; FALSE # Images are not identical
compare_screenshot_threshold(slider_old, slider_new, threshold = 25)
#&gt; FALSE # Images are more different than 25 units
compare_screenshot_threshold(slider_old, slider_new, threshold = 30)
#&gt; TRUE # Images are not as different as 30 units

#########################

# Now let's look at two fairly similar images
bookmark_old &lt;- fs::path(img_folder, "bookmark-old.png")
bookmark_new &lt;- fs::path(img_folder, "bookmark-new.png")

# Can you see the difference between these two images?
# (Hint: Focused corners)
showimage::show_image(bookmark_old)
showimage::show_image(bookmark_new)

# Can you find the red pixels showing the differences?
# Hint: Look in the corners of the focused text
bookmark_diff &lt;- fs::path(img_folder, "bookmark-diff.png")
showimage::show_image(bookmark_diff)

# Let's find the difference between the two images
screenshot_max_difference(bookmark_old, bookmark_new)
# ~ 0.25

# Using different threshold values...
compare_screenshot_threshold(bookmark_old, bookmark_new, threshold = NULL)
#&gt; FALSE # Images are not identical
compare_screenshot_threshold(bookmark_old, bookmark_new, threshold = 5)
#&gt; TRUE # Images are not as different than 5 units
</code></pre>


</div>