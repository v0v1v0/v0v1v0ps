<div class="container">

<table style="width: 100%;"><tr>
<td>fit_wrc_hcc</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>
Parametric Modelling of Soil Hydraulic Properties
</h2>

<h3>Description</h3>

<p>The function <code>fit_wrc_hcc</code> estimates parameters of models for the
soil water retention curve and/or soil hydraulic conductivity function
from respective measurements by nonlinear regression methods, optionally
subject to physical constraints on the estimated parameters.
<code>fit_wrc_hcc</code> uses optimisation algorithms of the NLopt library
(Johnson, see <code>nloptr-package</code>) and the Shuffled
Complex Evolution (SCE) algorithm (Duan et al., 1994) implemented in the
function <code>SCEoptim</code>.
</p>


<h3>Usage</h3>

<pre><code class="language-R">
fit_wrc_hcc(
    wrc_formula, hcc_formula, data,
    subset = NULL, wrc_subset = subset, hcc_subset = subset,
    weights = NULL, wrc_weights = weights, hcc_weights = weights,
    na.action, param = NULL, lower_param = NULL, upper_param = NULL,
    fit_param = default_fit_param(),
    e0 = 2.5e-3, ratio_lc_lt_bound = c(lower = 0.5, upper = 2),
    control = control_fit_wrc_hcc(), verbose = 0)

default_fit_param(
    alpha = TRUE, n = TRUE, tau = FALSE,
    thetar = TRUE, thetas = TRUE, k0 = TRUE)

</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>wrc_formula</code></td>
<td>
<p>an optional two-sided formula such as <code>wc ~ head</code>
or <code>wc ~ head | id</code>, specifying the variables for the water content
(<code>wc</code>), the capillary pressure <code>head</code> and, optionally, for
sample <code>id</code>s when model parameters are estimated for several soil
samples at the same time, see <code>formula</code> and
<em>Details</em>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>hcc_formula</code></td>
<td>
<p>an optional two-sided formula such as <code>hc ~ head</code>
or <code>hc ~ head | id</code>, specifying the variables for the hydraulic
conductivity (<code>hc</code>), the capillary pressure <code>head</code> and,
optionally, for sample <code>id</code>s when model parameters are estimated for
several soil samples at the same time.  See <code>formula</code>
and <em>Details</em>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>a mandatory data frame containing the variables specified in
the formula, the subset and weights arguments.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>subset</code></td>
<td>
<p>an optional expression generating a vector to choose a
subset of water content and hydraulic conductivity data.  The expression
is evaluated in the environment generated by
<code>model.frame(wrc_formula, data)</code> and<br><code>model.frame(hcc_formula,
  data)</code>, respectively.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>wrc_subset</code></td>
<td>
<p>an optional expression generating a vector to choose a
subset of water content data.  The expression is evaluated in the
environment generated by<br><code>model.frame(wrc_formula, data)</code>.  Defaults
to <code>subset</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>hcc_subset</code></td>
<td>
<p>an optional expression generating a vector to choose a
subset of hydraulic conductivity data.
The expression is evaluated in the environment generated by
<code>model.frame(hcc_formula, data)</code>.  Defaults to <code>subset</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>weights</code></td>
<td>
<p>an optional expression generating a numeric vector of case
weights <code class="reqn">w^\prime_{\theta,i}</code> and <code class="reqn">w^\prime_{K,i}</code> (default: 1,
see <code>soilhypfitIntro</code>) for water content and hydraulic
conductivity data.  The expression is evaluated in the environment
generated by <code>model.frame(wrc_formula, data)</code> and
<code>model.frame(hcc_formula, data)</code>, respectively.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>wrc_weights</code></td>
<td>
<p>an optional expression generating a numeric vector of
case weights <code class="reqn">w^\prime_{\theta,i}</code> (see
<code>soilhypfitIntro</code>) for water content data.  The expression is
evaluated in the environment generated by <code>model.frame(wrc_formula,
  data)</code>.  Defaults to <code>weights</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>hcc_weights</code></td>
<td>
<p>an optional expression generating a numeric vector of
case weights <code class="reqn">w^\prime_{K,i}</code> (see <code>soilhypfitIntro</code>) for
hydraulic conductivity data.  The expression is evaluated in the
environment generated by <code>model.frame(hcc_formula, data)</code>.  Defaults
to <code>weights</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>na.action</code></td>
<td>
<p>a function which indicates what should happen when the
data contain <code>NA</code>s.  The default is set by the <code>na.action</code>
argument of <code>options</code>, and is <code>na.fail</code> if that
is unset.  The “factory-fresh” default is <code>na.omit</code>.
Another possible value is <code>NULL</code>, no action.  Value
<code>na.exclude</code> can be useful.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>param</code></td>
<td>
<p>an optional named numeric vector (or a numeric matrix or a
dataframe with specified row and column names, see <em>Details</em>) with
initial values for the model parameters.  Currently, <code>param</code> may
have elements (or columns) named <code>"alpha"</code>, <code>"n"</code>,
<code>"tau"</code>, <code>"thetar"</code>, <code>"thetas"</code>, <code>"k0"</code>, see
<code>wc_model</code> and <code>hc_model</code> and <em>Details</em>.
For consistency with other quantities, the unit of <code class="reqn">\alpha</code> should be
<b>1/meter</b> [<code class="reqn">\mathrm{m}^{-1}</code>] and the unit of <code class="reqn">K_0</code>
<b>meter/day</b> [<code class="reqn">\mathrm{m}\,\mathrm{d}^{-1}</code>].</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lower_param</code></td>
<td>
<p>an optional named numeric vector (or a numeric matrix
or a dataframe with specified row and column names, see <em>Details</em>)
with lower bounds for the parameters of the models.  Currently,
<code>lower_param</code> may have elements (or columns) named <code>"alpha"</code>,
<code>"n"</code>, <code>"tau"</code>, <code>"thetar"</code>, <code>"thetas"</code>, <code>"k0"</code>,
see <code>wc_model</code>, <code>hc_model</code> and
<code>param_boundf</code>.  For consistency with other quantities, the
unit of <code class="reqn">\alpha</code> should be <b>1/meter</b>
[<code class="reqn">\mathrm{m}^{-1}</code>] and the unit of <code class="reqn">K_0</code> <b>meter/day</b>
[<code class="reqn">\mathrm{m}\,\mathrm{d}^{-1}</code>].  If lower bounds are
specified for <code class="reqn">\theta_r</code> but not for <code class="reqn">\theta_s</code> then the lower
bounds specified for <code class="reqn">\theta_r</code> will also be used for
<code class="reqn">\theta_s</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>upper_param</code></td>
<td>
<p>an optional named numeric vector (or a numeric matrix
or a dataframe with specified row and column names, see <em>Details</em>)
with upper bounds for the parameters of the models.  Currently,
<code>upper_param</code> may have elements (or columns) named <code>"alpha"</code>,
<code>"n"</code>, <code>"tau"</code>, <code>"thetar"</code>, <code>"thetas"</code>, <code>"k0"</code>,
see <code>wc_model</code>, <code>hc_model</code> and
<code>param_boundf</code>.  For consistency with other quantities, the
unit of <code class="reqn">\alpha</code> should be <b>1/meter</b>
[<code class="reqn">\mathrm{m}^{-1}</code>] and the unit of <code class="reqn">K_0</code> <b>meter/day</b>
[<code class="reqn">\mathrm{m}\,\mathrm{d}^{-1}</code>].  If upper bounds are
specified for <code class="reqn">\theta_s</code> but not for <code class="reqn">\theta_r</code> then the upper
bounds specified for <code class="reqn">\theta_s</code> will also be used for
<code class="reqn">\theta_r</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fit_param</code></td>
<td>
<p>a named logical vector (or a logical matrix or a
dataframe with specified row and column names, see <em>Details</em>)
containing flags that control whether model parameters are estimated
(<code>TRUE</code>) or kept fixed at the initial values (<code>FALSE</code>) as
specified in <code>param</code>.  This vector can be generated easily by the
function <code>default_fit_param</code>.  Currently, <code>fit_param</code> may have
elements (or columns) named <code>"alpha"</code>, <code>"n"</code>, <code>"tau"</code>,<br><code>"thetar"</code>, <code>"thetas"</code>, <code>"k0"</code>, see <em>Details</em>,
<code>wc_model</code> and <code>hc_model</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>e0</code></td>
<td>
<p>a numeric scalar (or named vector, see <em>Details</em>) with the
stage-I rate of evaporation <code class="reqn">E_0</code> from a soil (default <code class="reqn">2.5\cdot
  10^{-3} \ \mathrm{m}\,\mathrm{d}^{-1}</code>) required to
evaluate the <em>characteristic evaporative length</em>, see
<code>evaporative-length</code> and <code>soilhypfitIntro</code>.  For
consistency with other quantities, the unit of <code class="reqn">E_0</code> should
<b>meter/day</b> [<code class="reqn">\mathrm{m}\,\mathrm{d}^{-1}</code>].  Note that
<code>e0</code> is ignored when an unconstrained nonlinear optimisation
algorithm is chosen (argument <code>settings</code> of
<code>control_fit_wrc_hcc</code> equal to <code>"uglobal"</code>, <code>"sce"</code>
or <code>"ulocal"</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ratio_lc_lt_bound</code></td>
<td>
<p>a named numeric vector of length 2 (or a matrix
with specified rownames and two columns, see <em>Details</em>) defining the
default <code>lower</code> and <code>upper</code> bounds of the ratio
<code class="reqn">L_\mathrm{c}/L_\mathrm{t}</code> (<cite>Lehmann et al., 2008,
2020</cite>) for constrained estimation of the <em>nonlinear</em> parameters
<code class="reqn">\boldsymbol{\nu}^\mathrm{T} =(\alpha, n, \tau)</code> (default values 0.5 (<code>lower</code>)
and 2 (<code>upper</code>)), see <code>evaporative-length</code> and
<code>soilhypfitIntro</code>.  Note that <code>ratio_lc_lt_bound</code> is
ignored when an unconstrained nonlinear optimisation algorithm is chosen
(argument <code>settings</code> of <code>control_fit_wrc_hcc</code> equal to
<code>"uglobal"</code>, <code>"sce"</code> or <code>"ulocal"</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>control</code></td>
<td>
<p>a list with options to control <code>fit_wrc_hcc</code> or a
function such as<br><code>control_fit_wrc_hcc</code> that generates such
a list.  The main argument <code>settings</code> of <code>control_fit_wrc_hcc</code>
selects a nonlinear optimisation approach, see<br><code>soilhypfitIntro</code> and <code>control_fit_wrc_hcc</code>
for full details.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>verbose</code></td>
<td>
<p>positive integer controlling logging of diagnostic
messages to the console and plotting of data and model curves
during fitting.
</p>

<dl>
<dt><code>verbose &lt; 0</code></dt>
<dd>
<p>suppresses all output,</p>
</dd>
<dt><code>verbose &gt;= 0</code></dt>
<dd>
<p>suppresses all output except
warning messages,</p>
</dd>
<dt><code>verbose &gt;= 1</code></dt>
<dd>
<p>displays at the end the measurements along
with the fitted model curves,</p>
</dd>
<dt><code>verbose &gt;= 2</code></dt>
<dd>
<p>prints for each iteration the parameters
values, the value of the objective function and the ratio of
<code class="reqn">L_\mathrm{c}/L_\mathrm{t}</code> (see
<code>evaporative-length</code>),</p>
</dd>
<dt><code>verbose &gt;= 3</code></dt>
<dd>
<p>plots for each iteration the measurements
along with the fitted model curves.</p>
</dd>
</dl>
<p>Logging of further diagnostics during fitting is controlled in addition
by the arguments <code>print_level</code>, <code>check_derivatives</code>,
<code>check_derivatives_print</code> when <code>nloptr</code> is used
(see <code>nloptr.print.options</code> and
<code>control_nloptr</code>) and by the argument <code>trace</code> of
<code>SCEoptim</code> (see <code>control_sce</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>alpha</code></td>
<td>
<p>a logical scalar controlling whether the inverse air entry
pressure <code class="reqn">\alpha</code> should be estimated (<code>TRUE</code>, default) or kept
fixed at the initial value (<code>FALSE</code>) specified by <code>param</code>, see
<code>wc_model</code> and <code>hc_model</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>n</code></td>
<td>
<p>a logical scalar controlling whether the shape parameter <code class="reqn">n</code>
should be estimated (<code>TRUE</code>, default) or kept fixed at the initial
value (<code>FALSE</code>) specified by <code>param</code>, see
<code>wc_model</code> and <code>hc_model</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>tau</code></td>
<td>
<p>a logical scalar controlling whether the tortuosity parameter
<code class="reqn">\tau</code> should be estimated (<code>TRUE</code>) or kept fixed at the initial
value (<code>FALSE</code>, default) specified by <code>param</code>, see
<code>hc_model</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>thetar</code></td>
<td>
<p>a logical scalar controlling whether the residual water
content <code class="reqn">\theta_r</code> should be estimated (<code>TRUE</code>, default) or kept
fixed at the initial value (<code>FALSE</code>) specified by <code>param</code>, see
<code>wc_model</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>thetas</code></td>
<td>
<p>a logical scalar controlling whether the saturated water
content <code class="reqn">\theta_s</code> should be estimated (<code>TRUE</code>, default) or kept
fixed at the initial value (<code>FALSE</code>) specified by <code>param</code>, see
<code>wc_model</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>k0</code></td>
<td>
<p>a logical scalar controlling whether the saturated hydraulic
conductivity <code class="reqn">K_0</code> should be estimated (<code>TRUE</code>, default) or kept
fixed at the initial value (<code>FALSE</code>) specified by <code>param</code>, see
<code>hc_model</code>.</p>
</td>
</tr>
</table>
<h3>Details</h3>



<h4>Estimating model parameters of water retention curves and/or
hydraulic conductivity functions</h4>

<p>The function <code>fit_wrc_hcc</code> estimates model parameters of water
retention curves and/or hydraulic conductivity functions by
<em>maximum likelihood</em> (ml, default) <em>maximum posterior density</em>
(mpd) or <em>nonlinear least squares</em> (wls), see argument
<code>method</code> of <code>control_fit_wrc_hcc</code>.  Measurements must
be available for at least one of the two material functions.  If one
type of data is missing then the respective <code>formula</code>,
<code>subset</code> and <code>weights</code> arguments should be omitted.
</p>
<p>If both types of data are available then measurements are weighed when
computing the residual sum of squares for wls, but unit weights are
used by default for mpd and ml estimation, see
<code>soilhypfitIntro</code>.  The wls weights are the product of the
<em>case weights</em> <code class="reqn">w^\prime_{\theta,i}</code> and <code class="reqn">w^\prime_{K,i}</code>
given by <code>weights</code>, <code>wrc_weights</code> and <code>hcc_weights</code>,
respectively, and the <em>variable weights</em> as specified by the
argument <code>variable_weight</code> of <code>control_fit_wrc_hcc</code>.
Note that the <code>variable_weights</code> are not used “as is”, but they
are multiplied by the inverse variances of the water content or the
(log-transformed) conductivity data per sample to obtain the variable
weights <code class="reqn">w_\theta</code>, <code class="reqn">w_K</code> mentioned in
<code>soilhypfitIntro</code>.</p>



<h4>Estimating model parameters for a single or multiple soil
samples</h4>

<p>When parameters are estimated for a single soil sample only, then model
formulae are of the form <code>wc ~ head</code> and/or <code>hc ~head</code>, and
there is no need to specify a sample <code>id</code>.  In this case
<code>param</code>, <code>lower_param</code>, <code>upper_param</code>, <code>fit_param</code>
and <code>ratio_lc_lt_bound</code> are vectors and <code>e0</code> is a scalar.
</p>
<p><code>fit_wrc_hcc</code> allows to fit models to datasets containing data for
multiple soil samples.  The model formula must then be of the form
<code>wc ~ head|id</code> and/or <code>hc ~ head|id</code> where the factor
<code>id</code> identifies the soil samples.  If <code>param</code>,
<code>lower_param</code>, <code>upper_param</code>, <code>fit_param</code> and
<code>ratio_lc_lt_bound</code> are vectors and <code>e0</code> is a scalar then
this information is used for processing all the soil samples.  If
specific information per sample should be used then <code>param</code>,
<code>lower_param</code>, <code>upper_param</code>, <code>fit_param</code> and
<code>ratio_lc_lt_bound</code> must be matrices (or data frames) with as many
rows as there are soil samples.  The matrices (or data.frames) must
have rownames matching the levels of the factor <code>id</code> defining the
soil samples.  <code>e0</code> must be a named vector with as many elements
as there are soil samples and the names must again match the levels of
<code>id</code>.
</p>
<p>By default, <code>fit_wrc_hcc</code> processes data of multiple soil samples
in parallel, see <code>control_pcmp</code> for options to control
parallel computing.  Note that diagnostic output (except warning
messages) is suppressed in parallel computations.  If computations fail
for a particular soil sample, the id of the sample with the failed fit
can be extracted by the utility function
<code>select_failed_fits</code> and the respective error messages by
<code>extract_error_messages</code>.
</p>



<h4>Controlling <code>fit_wrc_hcc</code>
</h4>

<p>The argument <code>control</code> is used to pass a list of options to
<code>fit_wrc_hcc</code> that steer the function, see
<code>soilhypfit-package</code> and <code>control_fit_wrc_hcc</code>
for full details.
</p>



<h3>Value</h3>

<p><code>fit_wrc_hcc</code> returns an object of <code>class</code>
<code>fit_wrc_hcc</code>, which is a list with the following components:
</p>
<table>
<tr style="vertical-align: top;">
<td><code>fit</code></td>
<td>
<p>a list with as many components as there are soils samples.
Each component is in turn a list that contains the estimated parameters
and accompanying information:
</p>

<ul>
<li>
<p><code>converged</code>: an integer code issued by
<code>SCEoptim</code> or <code>nloptr</code> on (non-)
convergence, see <code>convergence_message</code> and
<a href="https://nlopt.readthedocs.io/en/latest/NLopt_Reference/#return-values">NLopt
return values</a>.
</p>
</li>
<li>
<p><code>message</code>: a character string issued by
<code>SCEoptim</code> or <code>nloptr</code> on
(non-)convergence.
</p>
</li>
<li>
<p><code>evaluation</code>: the number of evaluations of the objective
function and of the gradient.
</p>
</li>
<li>
<p><code>objective</code>: the value of the objective function
evaluated at the solution.  The contributions of the water retention
curve and the hydraulic conductivity function to <code>objective</code> are
reported as attributes <code>obj_wc</code> and <code>obj_hc</code>.  The
attributes <code>ssq_wc</code> and <code>ssq_hc</code> are the respective
residual sums of squares <code class="reqn">Q_\theta</code> and <code class="reqn">Q_K</code>, see
<code>soilhypfitIntro</code>.
</p>
</li>
<li>
<p><code>gradient</code>: the gradient of the objective function at the
solution with respect to the (possibly transformed) nonlinear parameters.
</p>
</li>
<li>
<p><code>lp</code>: the estimated values for the linear parameters
<code class="reqn">\boldsymbol{\mu}^\mathrm{T} =(\theta_r, \theta_s, K_0)</code>, see
<code>wc_model</code> and <code>hc_model</code>.
</p>
</li>
<li>
<p><code>nlp</code>: the estimated values for the nonlinear parameters
<code class="reqn">\boldsymbol{\nu}^\mathrm{T} =(\alpha, n, \tau)</code>, see <code>wc_model</code> and
<code>hc_model</code>.
</p>
</li>
<li>
<p><code>inequality_constraint</code>: a list with the values of the
inequality constraints evaluated at the solutions.  Currently, values
are reported for the expressions.
</p>
<p style="text-align: center;"><code class="reqn">-(\frac{L_\mathrm{c}}{L_\mathrm{t}} - l)</code>
</p>

<p style="text-align: center;"><code class="reqn">\frac{L_\mathrm{c}}{L_\mathrm{t}} - u</code>
</p>

<p>in the only component <code>lc</code>, where <code class="reqn">l</code> and <code class="reqn">u</code> are the
lower and upper bounds of the ratio, see argument
<code>ratio_lc_lt_bound</code> and <code>evaporative-length</code>.  The
values of <code class="reqn">L_\mathrm{c}</code>, <code class="reqn">L_\mathrm{t}</code>, the
imposed bounds on their ratio and <code>e0</code> are
returned as attributes of <code>lc</code>.
</p>
</li>
<li>
<p><code>hessian</code>: optionally the Hessian matrix of the objective
function with respect to the possibly transformed nonlinear
parameters at the solution.
</p>
</li>
<li>
<p><code>variable_weight</code>: a named vector with the variable
weights <code class="reqn">w_{\theta}</code> and <code class="reqn">w_{K}</code>, see <em>Details</em>.
</p>
</li>
<li>
<p><code>weight</code>: a list with one or two components named
<code>weights_wc</code> and or <code>weights_hc</code> with the case weights
<code class="reqn">w_{\theta,i}</code> and <code class="reqn">w_{K,i}</code> used in the objective function,
see <em>Details</em>.
</p>
</li>
<li>
<p><code>fitted</code>: a list with one or two components named
<code>wrc</code> and/or <code>hcc</code> with the fitted values for the water
retention and the (possibly log-transformed) hydraulic conductivity
data.
</p>
</li>
<li>
<p><code>residuals</code>: a list with one or two components named
<code>wrc</code> and/or <code>hcc</code> with residuals for the water retention
and the (possibly log-transformed) hydraulic conductivity data.
</p>
</li>
<li>
<p><code>model</code>: a list with one or two components named <code>wrc</code>
and/or <code>hcc</code> with the <code>model.frame</code>s for the
water retention and hydraulic conductivity data.
</p>
</li>
<li>
<p><code>initial_objects</code>: a list with the values for
<code>param</code>, <code>fit_param</code>, <code>variable_weight</code>,
<code>param_bound</code>, <code>e0</code> and <code>ratio_lc_lt_bound</code> as taken
from the (processed) arguments of the call of <code>fit_wrc_hcc</code>.
</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sample_id_variable</code></td>
<td>
<p>the name of the variable defining the samples.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>wrc</code></td>
<td>
<p>logical scalar signalling whether water retention data were
used to estimate the parameters.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>wrc_formula</code></td>
<td>
<p>formula defining the variables for water content and
hydraulic head of the water retention data (<code>NULL</code> if not <code>wrc</code>
equal to <code>FALSE</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>wrc_mf</code></td>
<td>
<p>unevaluated call of <code>model.frame</code> to
build the modelframe for the water retention data (<code>NULL</code> if
<code>wrc</code> equal to <code>FALSE</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>wrc</code></td>
<td>
<p>logical scalar signalling whether water retention data were
used to estimate the parameters.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>hcc_formula</code></td>
<td>
<p>formula defining the variables for hydraulic
conductivity and hydraulic head of the hydraulic conductivity data
(<code>NULL</code> if not <code>hcc</code> equal to <code>FALSE</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>hcc_mf</code></td>
<td>
<p>unevaluated call of <code>model.frame</code> to
build the modelframe for the water retention data (<code>NULL</code> if
<code>hcc</code> equal to <code>FALSE</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>control</code></td>
<td>
<p>a list with the options used to control
<code>fit_wrc_hcc</code>, see <code>control_fit_wrc_hcc</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>call</code></td>
<td>
<p>the matched call.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>na.action</code></td>
<td>
<p>information returned by <code>model.frame</code>
on the special handling of <code>NA</code>s.</p>
</td>
</tr>
</table>
<h3>Author(s)</h3>

<p>Andreas Papritz <a href="mailto:papritz@retired.ethz.ch">papritz@retired.ethz.ch</a>.
</p>


<h3>References</h3>

<p>Duan, Q., Sorooshian, S., and Gupta, V. K. (1994) Optimal use of the
SCE-UA global optimisation method for calibrating watershed models,
<em>Journal of Hydrology</em> <b>158</b>, 265–284,
<a href="https://doi.org/10.1016/0022-1694%2894%2990057-4">doi:10.1016/0022-1694(94)90057-4</a>.
</p>
<p>Johnson, S.G. The NLopt nonlinear-optimisation package.
<a href="https://github.com/stevengj/nlopt">https://github.com/stevengj/nlopt</a>.
</p>
<p>Lehmann, P., Assouline, S., Or, D. (2008) Characteristic lengths
affecting evaporative drying of porous media.  <em>Physical Review E</em>,
<b>77</b>, 056309, <a href="https://doi.org/10.1103/PhysRevE.77.056309">doi:10.1103/PhysRevE.77.056309</a>.
</p>
<p>Lehmann, P., Bickel, S., Wei, Z., Or, D. (2020) Physical Constraints for
Improved Soil Hydraulic Parameter Estimation by Pedotransfer Functions.
<em>Water Resources Research</em> <b>56</b>, e2019WR025963,
<a href="https://doi.org/10.1029/2019WR025963">doi:10.1029/2019WR025963</a>.
</p>


<h3>See Also</h3>

<p><code>soilhypfitIntro</code> for a description of the models and a brief
summary of the parameter estimation approach;
</p>



<p><code>control_fit_wrc_hcc</code> for options to control
<code>fit_wrc_hcc</code>;
</p>
<p><code>soilhypfitmethods</code> for common S3 methods for class
<code>fit_wrc_hcc</code>;
</p>
<p><code>vcov</code> for computing (co-)variances of the estimated
nonlinear parameters;
</p>
<p><code>prfloglik_sample</code> for profile loglikelihood
computations;
</p>
<p><code>wc_model</code> and <code>hc_model</code> for currently
implemented models for soil water retention curves and hydraulic
conductivity functions;
</p>
<p><code>evaporative-length</code> for physically constraining parameter
estimates of soil hydraulic material functions.
</p>


<h3>Examples</h3>

<pre><code class="language-R">
# use of \donttest{} because execution time exceeds 5 seconds

data(sim_wrc_hcc)

# define number of cores for parallel computations
if(interactive()) ncpu &lt;- parallel::detectCores() - 1L else ncpu &lt;- 1L


# estimate parameters for single sample ...

#  ... from wrc and hcc data
plot(rfit_wrc_hcc &lt;- fit_wrc_hcc(
  wrc_formula = wc ~ head, hcc_formula = hc ~ head,
  data = sim_wrc_hcc, subset = id == 1))
coef(rfit_wrc_hcc, gof = TRUE)

#  ... from wrc data
plot(rfit_wrc &lt;- fit_wrc_hcc(
  wrc_formula = wc ~ head,
  data = sim_wrc_hcc, subset = id == 1))
coef(rfit_wrc, gof = TRUE)

#  ... from  hcc data
plot(rfit_hcc &lt;- fit_wrc_hcc(
  hcc_formula = hc ~ head,
  data = sim_wrc_hcc, subset = id == 1))
coef(rfit_hcc, gof = TRUE)

# ... from wrc and hcc data
#     keeping some parameters fixed
plot(rfit_wrc_hcc_fixed &lt;- fit_wrc_hcc(
  wrc_formula = wc ~ head, hcc_formula = hc ~ head,
  data = sim_wrc_hcc, subset = id == 1,
  param = c(alpha = 2.1, thetar = 0.1),
  fit_param = default_fit_param(alpha = FALSE, thetar = FALSE)),
  y = rfit_wrc_hcc)
coef(rfit_wrc_hcc, gof = TRUE)
coef(rfit_wrc_hcc_fixed, gof = TRUE)


# estimate parameters for 3 samples simultaneously by ...

# ... unconstrained, global optimisation algorithm NLOPT_GN_MLSL (default)
rfit_uglob &lt;- fit_wrc_hcc(
  wrc_formula = wc ~ head | id, hcc_formula = hc ~ head | id,
  data = sim_wrc_hcc,
  control = control_fit_wrc_hcc(pcmp = control_pcmp(ncores = ncpu)))
summary(rfit_uglob)
op &lt;- par(mfrow = c(3, 2))
plot(rfit_uglob)
on.exit(par(op))

# ... unconstrained, global optimisation algorithm SCEoptim
rfit_sce &lt;- update(
  rfit_uglob,
  control = control_fit_wrc_hcc(
    settings = "sce", pcmp = control_pcmp(ncores = ncpu)))
coef(rfit_sce, gof = TRUE, lc = TRUE)
convergence_message(2, sce = TRUE)
op &lt;- par(mfrow = c(3, 2))
plot(rfit_sce, y = rfit_uglob)
on.exit(par(op))

# ... unconstrained, local optimisation algorithm NLOPT_LN_BOBYQA,
#     logging iteration results to console
rfit_uloc &lt;- update(
  rfit_uglob,
  param = as.matrix(coef(rfit_uglob, what = "nonlinear")),
  control = control_fit_wrc_hcc(
    settings = "ulocal", pcmp = control_pcmp(ncores = 1L)),
  verbose = 2)
coef(rfit_uloc, gof = TRUE, lc = TRUE)

# ... constrained, global optimisation algorithm NLOPT_GN_ISRES
rfit_cglob &lt;- update(
  rfit_uglob,
  ratio_lc_lt_bound = c(lower = 0.8, upper = 1.2),
  control = control_fit_wrc_hcc(
    settings = "cglobal", nloptr = control_nloptr(ranseed = 1),
    pcmp = control_pcmp(ncores = ncpu)))
coef(rfit_cglob, gof = TRUE, lc = TRUE)

# ... constrained, local optimisation algorithm NLOPT_LD_CCSAQ
#     starting from unconstrained, locally fitted initial values
rfit_cloc_1 &lt;- update(
  rfit_uglob,
  param = coef(rfit_uloc, what = "nonlinear"),
  ratio_lc_lt_bound = c(lower = 0.8, upper = 1.2),
  control = control_fit_wrc_hcc(
    settings = "clocal", pcmp = control_pcmp(ncores = ncpu)))
coef(rfit_cloc_1, gof = TRUE, lc = TRUE)
op &lt;- par(mfrow = c(3, 2))
plot(x = rfit_uloc, y = rfit_cloc_1)
on.exit(par(op))

# ... constrained, local optimisation algorithm NLOPT_LD_CCSAQ
#     starting from constrained, globally fitted initial values,
#     using sample-specific evaporation rates and limits for ratio lc/lt
rfit_cloc_2 &lt;- update(
  rfit_uglob,
  param = as.matrix(coef(rfit_cglob, what = "nonlinear")),
  e0 = c("1" = 0.002, "2" = 0.0025, "3" = 0.003),
  ratio_lc_lt_bound = rbind(
    "1" = c(lower = 0.7, upper = 2),
    "2" = c(lower = 0.8, upper = 1.4),
    "3" = c(lower = 0.8, upper = 2)
  ),
  control = control_fit_wrc_hcc(
    settings = "clocal", pcmp = control_pcmp(ncores = ncpu)))
coef(rfit_cloc_2, gof = TRUE, lc = TRUE, e0 = TRUE)

# ... global optimisation algorithm NLOPT_GN_MLSL
#     with sample-specific box-constraints

rfit_uglob_bc &lt;- update(
  rfit_uglob,
  lower_param = rbind(
    "1" = c(alpha = 2.4, n = 1.11, thetar = 0.2, thetas = 0.6),
    "2" = c(alpha = 1.2, n = 1.12, thetar = 0.2, thetas = 0.6),
    "3" = c(alpha = 1.2, n = 1.13, thetar = 0.2, thetas = 0.6)
  ),
  upper_param = rbind(
    "1" = c(alpha = 20.1, n = 2.51, thetar = 0.6, thetas = 0.6),
    "2" = c(alpha = 20.2, n = 1.5,  thetar = 0.6, thetas = 0.6),
    "3" = c(alpha = 1.3, n = 2.53,  thetar = 0.6, thetas = 0.6)
  )
)
coef(rfit_uglob, gof = TRUE)
coef(rfit_uglob_bc, gof = TRUE)

</code></pre>


</div>