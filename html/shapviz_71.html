<div class="container">

<table style="width: 100%;"><tr>
<td>sv_waterfall</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>SHAP Waterfall Plot</h2>

<h3>Description</h3>

<p>Creates a waterfall plot of SHAP values of one observation. If multiple
observations are selected, their SHAP values and predictions are averaged.
</p>


<h3>Usage</h3>

<pre><code class="language-R">sv_waterfall(object, ...)

## Default S3 method:
sv_waterfall(object, ...)

## S3 method for class 'shapviz'
sv_waterfall(
  object,
  row_id = 1L,
  max_display = 10L,
  order_fun = function(s) order(abs(s)),
  fill_colors = c("#f7d13d", "#a52c60"),
  format_shap = getOption("shapviz.format_shap"),
  format_feat = getOption("shapviz.format_feat"),
  contrast = TRUE,
  show_connection = TRUE,
  show_annotation = TRUE,
  annotation_size = 3.2,
  ...
)

## S3 method for class 'mshapviz'
sv_waterfall(
  object,
  row_id = 1L,
  max_display = 10L,
  order_fun = function(s) order(abs(s)),
  fill_colors = c("#f7d13d", "#a52c60"),
  format_shap = getOption("shapviz.format_shap"),
  format_feat = getOption("shapviz.format_feat"),
  contrast = TRUE,
  show_connection = TRUE,
  show_annotation = TRUE,
  annotation_size = 3.2,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>object</code></td>
<td>
<p>An object of class "(m)shapviz".</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>Arguments passed to <code>ggfittext::geom_fit_text()</code>.
For example, <code>size = 9</code> will use fixed text size in the bars and <code>size = 0</code>
will altogether suppress adding text to the bars.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>row_id</code></td>
<td>
<p>Subset of observations to plot, typically a single row number.
If more than one row is selected, SHAP values are averaged, and feature values
are shown only when they are unique.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>max_display</code></td>
<td>
<p>Maximum number of features (with largest absolute SHAP values)
should be plotted? If there are more features, they will be collapsed to one
feature. Set to <code>Inf</code> to show all features.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>order_fun</code></td>
<td>
<p>Function specifying the order of the variables/SHAP values.
It maps the vector <code>s</code> of SHAP values to sort indices from 1 to <code>length(s)</code>.
The default is <code>function(s) order(abs(s))</code>. To plot without sorting, use
<code>function(s) 1:length(s)</code> or <code>function(s) length(s):1</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fill_colors</code></td>
<td>
<p>A vector of exactly two fill colors: the first for positive
SHAP values, the other for negative ones.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>format_shap</code></td>
<td>
<p>Function used to format SHAP values. The default uses the
global option <code>shapviz.format_shap</code>, which equals to
<code>function(z) prettyNum(z, digits = 3, scientific = FALSE)</code> by default.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>format_feat</code></td>
<td>
<p>Function used to format numeric feature values. The default uses
the global option <code>shapviz.format_feat</code>, which equals to
<code>function(z) prettyNum(z, digits = 3, scientific = FALSE)</code> by default.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>contrast</code></td>
<td>
<p>Logical flag that detemines whether to use white text in dark arrows.
Default is <code>TRUE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>show_connection</code></td>
<td>
<p>Should connecting lines be shown? Default is <code>TRUE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>show_annotation</code></td>
<td>
<p>Should "f(x)" and "E(f(x))" be plotted? Default is <code>TRUE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>annotation_size</code></td>
<td>
<p>Size of the annotation text (f(x)=... and E(f(x))=...).</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>f(x) denotes the prediction on the SHAP scale, while E(f(x)) refers to the
baseline SHAP value.
</p>


<h3>Value</h3>

<p>An object of class "ggplot" (or "patchwork") representing a waterfall plot.
</p>


<h3>Methods (by class)</h3>


<ul>
<li> <p><code>sv_waterfall(default)</code>: Default method.
</p>
</li>
<li> <p><code>sv_waterfall(shapviz)</code>: SHAP waterfall plot for an object of class "shapviz".
</p>
</li>
<li> <p><code>sv_waterfall(mshapviz)</code>: SHAP waterfall plot for an object of class "mshapviz".
</p>
</li>
</ul>
<h3>See Also</h3>

<p><code>sv_force()</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">dtrain &lt;- xgboost::xgb.DMatrix(
  data.matrix(iris[, -1]), label = iris[, 1], nthread = 1
)
fit &lt;- xgboost::xgb.train(data = dtrain, nrounds = 20, nthread = 1)
x &lt;- shapviz(fit, X_pred = dtrain, X = iris[, -1])
sv_waterfall(x)
sv_waterfall(x, row_id = 123, max_display = 2, size = 9, fill_colors = 4:5)

# Ordered by colnames(x), combined with max_display
sv_waterfall(
  x[, sort(colnames(x))], order_fun = function(s) length(s):1, max_display = 3
)

# Aggregate over all observations with Petal.Length == 1.4
sv_waterfall(x, row_id = x$X$Petal.Length == 1.4)
</code></pre>


</div>