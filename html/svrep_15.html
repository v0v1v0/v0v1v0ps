<div class="container">

<table style="width: 100%;"><tr>
<td>get_design_quad_form</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Determine the quadratic form matrix of a variance estimator for a survey design object</h2>

<h3>Description</h3>

<p>Determines the quadratic form matrix of a specified variance estimator,
by parsing the information stored in a survey design object created using
the 'survey' package.
</p>


<h3>Usage</h3>

<pre><code class="language-R">get_design_quad_form(
  design,
  variance_estimator,
  ensure_psd = FALSE,
  aux_var_names = NULL
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>design</code></td>
<td>
<p>A survey design object created using the 'survey' (or 'srvyr') package,
with class <code>'survey.design'</code> or <code>'svyimputationList'</code>. Also accepts two-phase design objects
with class <code>'twophase2'</code>; see the section below titled "Two-Phase Designs" for
more information about handling of two-phase designs.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>variance_estimator</code></td>
<td>
<p>The name of the variance estimator
whose quadratic form matrix should be created. <br>
See the section "Variance Estimators" below.
Options include:
</p>

<ul>
<li> <p><strong>"Yates-Grundy"</strong>: <br> The Yates-Grundy variance estimator based on
first-order and second-order inclusion probabilities.
</p>
</li>
<li> <p><strong>"Horvitz-Thompson"</strong>: <br> The Horvitz-Thompson variance estimator based on
first-order and second-order inclusion probabilities.
</p>
</li>
<li> <p><strong>"Poisson Horvitz-Thompson"</strong>: <br> The Horvitz-Thompson variance estimator
based on assuming Poisson sampling, with first-order inclusion probabilities
inferred from the sampling probabilities of the survey design object.
</p>
</li>
<li> <p><strong>"Stratified Multistage SRS"</strong>: <br> The usual stratified multistage variance estimator
based on estimating the variance of cluster totals within strata at each stage.
</p>
</li>
<li> <p><strong>"Ultimate Cluster"</strong>: <br> The usual variance estimator based on estimating
the variance of first-stage cluster totals within first-stage strata.
</p>
</li>
<li> <p><strong>"Deville-1"</strong>: <br> A variance estimator for unequal-probability
sampling without replacement, described in Matei and Tillé (2005)
as "Deville 1".
</p>
</li>
<li> <p><strong>"Deville-2"</strong>: <br> A variance estimator for unequal-probability
sampling without replacement, described in Matei and Tillé (2005) as "Deville 2".
</p>
</li>
<li> <p><strong>"Deville-Tille": </strong> <br> A variance estimator useful
for balanced sampling designs, proposed by Deville and Tillé (2005).
</p>
</li>
<li> <p><strong>"SD1"</strong>: <br> The non-circular successive-differences variance estimator described by Ash (2014),
sometimes used for variance estimation for systematic sampling.
</p>
</li>
<li>
<p><strong>"SD2"</strong>:  <br> The circular successive-differences variance estimator described by Ash (2014).
This estimator is the basis of the "successive-differences replication" estimator commonly used
for variance estimation for systematic sampling.
</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ensure_psd</code></td>
<td>
<p>If <code>TRUE</code> (the default), ensures
that the result is a positive semidefinite matrix. This
is necessary if the quadratic form is used as an input for
replication methods such as the generalized bootstrap.
For mathematical details, please see the documentation for the function <code>get_nearest_psd_matrix()</code>.
The approximation method is discussed by Beaumont and Patak (2012)
in the context of forming replicate weights for two-phase samples.
The authors argue that this approximation should
lead to only a small overestimation of variance.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>aux_var_names</code></td>
<td>
<p>Only required if <code>variance_estimator = "Deville-Tille"</code>.
Should be a character vector of variable names for auxiliary variables
to be used in the Breidt and Chauvet (2011) variance estimator.</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>A matrix representing the quadratic form of a specified variance estimator,
based on extracting information about clustering, stratification,
and selection probabilities from the survey design object.
</p>


<h3>Variance Estimators</h3>

<p>See variance-estimators for a
description of each variance estimator.
</p>


<h3>Two-Phase Designs</h3>

<p>For a two-phase design, <code>variance_estimator</code> should be a list of variance estimators' names,
with two elements, such as <code>list('Ultimate Cluster', 'Poisson Horvitz-Thompson')</code>.
In two-phase designs, only the following estimators may be used for the second phase:
</p>

<ul>
<li>
<p> "Ultimate Cluster"
</p>
</li>
<li>
<p> "Stratified Multistage SRS"
</p>
</li>
<li>
<p> "Poisson Horvitz-Thompson"
</p>
</li>
</ul>
<p>For statistical details on the handling of two-phase designs,
see the documentation for make_twophase_quad_form.
</p>


<h3>References</h3>

<p>- Ash, S. (2014). "<em>Using successive difference replication for estimating variances</em>."
<strong>Survey Methodology</strong>, Statistics Canada, 40(1), 47–59.
<br><br>
- Beaumont, Jean-François, and Zdenek Patak. (2012). "<em>On the Generalized Bootstrap for Sample Surveys with Special Attention to Poisson Sampling: Generalized Bootstrap for Sample Surveys.</em>"
<strong>International Statistical Review</strong> 80 (1): 127–48.
<br><br>
- Bellhouse, D.R. (1985). "<em>Computing Methods for Variance Estimation in Complex Surveys</em>."
<strong>Journal of Official Statistics</strong>, Vol.1, No.3.
<br><br>
- Deville, J.‐C., and Tillé, Y. (2005). "<em>Variance approximation under balanced sampling.</em>"
<strong>Journal of Statistical Planning and Inference</strong>, 128, 569–591.
<br><br>
- Särndal, C.-E., Swensson, B., &amp; Wretman, J. (1992). "<em>Model Assisted Survey Sampling</em>." Springer New York.
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Not run: 
# Example 1: Quadratic form for successive-difference variance estimator ----

   data('library_stsys_sample', package = 'svrep')

   ## First, ensure data are sorted in same order as was used in sampling
   library_stsys_sample &lt;- library_stsys_sample[
     order(library_stsys_sample$SAMPLING_SORT_ORDER),
   ]

   ## Create a survey design object
   design_obj &lt;- svydesign(
     data = library_stsys_sample,
     strata = ~ SAMPLING_STRATUM,
     ids = ~ 1,
     fpc = ~ STRATUM_POP_SIZE
   )

   ## Obtain quadratic form
   quad_form_matrix &lt;- get_design_quad_form(
     design = design_obj,
     variance_estimator = "SD2"
   )

   ## Estimate variance of estimated population total
   y &lt;- design_obj$variables$LIBRARIA
   wts &lt;- weights(design_obj, type = 'sampling')
   y_wtd &lt;- as.matrix(y) * wts
   y_wtd[is.na(y_wtd)] &lt;- 0

   pop_total &lt;- sum(y_wtd)

   var_est &lt;- t(y_wtd) %*% quad_form_matrix %*% y_wtd
   std_error &lt;- sqrt(var_est)

   print(pop_total); print(std_error)

   # Compare to estimate from assuming SRS
   svytotal(x = ~ LIBRARIA, na.rm = TRUE,
            design = design_obj)

# Example 2: Two-phase design (second phase is nonresponse) ----

  ## Estimate response propensities, separately by stratum
  library_stsys_sample[['RESPONSE_PROB']] &lt;- svyglm(
    design = design_obj,
    formula = I(RESPONSE_STATUS == "Survey Respondent") ~ SAMPLING_STRATUM,
    family = quasibinomial('logistic')
  ) |&gt; predict(type = 'response')

  ## Create a survey design object,
  ## where nonresponse is treated as a second phase of sampling
  twophase_design &lt;- twophase(
    data = library_stsys_sample,
    strata = list(~ SAMPLING_STRATUM, NULL),
    id = list(~ 1, ~ 1),
    fpc = list(~ STRATUM_POP_SIZE, NULL),
    probs = list(NULL, ~ RESPONSE_PROB),
    subset = ~ I(RESPONSE_STATUS == "Survey Respondent")
  )

  ## Obtain quadratic form for the two-phase variance estimator,
  ## where first phase variance contribution estimated
  ## using the successive differences estimator
  ## and second phase variance contribution estimated
  ## using the Horvitz-Thompson estimator
  ## (with joint probabilities based on assumption of Poisson sampling)
  get_design_quad_form(
    design = twophase_design,
    variance_estimator = list(
      "SD2",
      "Poisson Horvitz-Thompson"
    )
  )

## End(Not run)
</code></pre>


</div>