<div class="container">

<table style="width: 100%;"><tr>
<td>csv.moodle</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>
Convertir un fichier CSV, ODS ou XLSX en questions Moodle
</h2>

<h3>Description</h3>

<p>Cette fonction permet de convertir un fichier convenablement
construit, en un fichier XML de questions pour Moodle
</p>


<h3>Usage</h3>

<pre><code class="language-R">csv.moodle(fichier.csv,
           colonne.texte = NA, colonne.reponse = NA,
           colonne.note = NA, colonne.note_question = NA,
           colonne.titre = NA,
           colonne.code = NA, colonne.type = NA,
           colonne.retour = NA, colonne.global = NA,
           colonne.penalite = NA,
           colonne.temps = NA, colonne.decimale = NA,
           fichier.xml = if ( TRUE == nv.fichier ) gsub(
                              "\\.[Cc][Ss][Vv]$",
                              ".xml", fichier.csv )
                         else get( "fichier.xml",
                                   envir = SARP.Moodle.env ),
           nv.fichier = TRUE,
           creer.titre = TRUE, lg.titre = 30,
           embellir = TRUE, deja.HTML = FALSE,
           forcer.multiple = TRUE, melanger.reponses = TRUE,
           somme.nulle = FALSE, precision = 3,
           categorie.base = "",
           dossier.images = dirname( fichier.csv ), 
           sep.images = c( '@@', '@@' ), inserer.images = TRUE,
           sep.formules = c( '@\\$', '\\$@' ),
           sep.SMILES = c( '@\\{', '\\}@' ),
           sep = if ( extension == "txt" ) "" else ";",
           header = TRUE, quote = '\"',
           ... )

ods.moodle( fichier.ods, onglet = NA,
            colonne.texte  = NA, colonne.reponse = NA,
            colonne.note   = NA, colonne.note_question = NA,
            colonne.titre  = NA, colonne.code = NA, colonne.type = NA,
            colonne.retour = NA, colonne.global = NA, colonne.penalite = NA,
            colonne.temps  = NA, colonne.decimale = NA,
            fichier.xml = if ( TRUE == nv.fichier ) gsub( "\\.[Oo][Dd][Ss]$",
                                                          ".xml",
                                                          fichier.ods )
                          else get( "fichier.xml", envir = SARP.Moodle.env ),
            nv.fichier = TRUE,
            creer.titre = TRUE, lg.titre = 30, embellir = TRUE, deja.HTML = FALSE,
            forcer.multiple = TRUE, melanger.reponses = TRUE, somme.nulle = FALSE,
            precision = 3,
            categorie.base = "",
            dossier.images = dirname( fichier.ods ),
            sep.images = c( '@@', '@@' ), inserer.images = TRUE,
            sep.formules = c( '@\\$', '\\$@' ),
            sep.SMILES = c( '@\\{', '\\}@' ),
            ... )

xlsx.moodle( fichier.xlsx, onglet = NA,
             colonne.texte  = NA, colonne.reponse = NA,
             colonne.note   = NA, colonne.note_question = NA,
             colonne.titre  = NA, colonne.code = NA, colonne.type = NA,
             colonne.retour = NA, colonne.global = NA, colonne.penalite = NA,
             colonne.temps  = NA, colonne.decimale = NA,
             fichier.xml = if ( TRUE == nv.fichier ) gsub( "\\.[Xx][Ll][Ss][Xx]$",
                                                           ".xml",
                                                           fichier.xlsx )
                           else get( "fichier.xml", envir = SARP.Moodle.env ),
             nv.fichier = TRUE,
             creer.titre = TRUE, lg.titre = 30, embellir = TRUE, deja.HTML = FALSE,
             forcer.multiple = TRUE, melanger.reponses = TRUE, somme.nulle = FALSE,
             precision = 3,
             categorie.base = "",
             dossier.images = dirname( fichier.xlsx ),
             sep.images = c( '@@', '@@' ), inserer.images = TRUE,
             sep.formules = c( '@\\$', '\\$@' ),
             sep.SMILES = c( '@\\{', '\\}@' ),
             ... )
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>fichier.csv, fichier.ods, fichier.xlsx</code></td>
<td>

<p>Un vecteur de chaînes de caractères contenant les noms des fichiers
à convertir. Chacun des fichiers est traité indépendamment, mais
avec les mêmes valeurs des options qui suivent.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>onglet</code></td>
<td>

<p>Le numéro, ou le nom, de la feuille (onglet) du classeur LibreOffice
ou Excel à convertir. S'il n'est pas indiqué, toutes les feuilles
seront converties.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>colonne.texte</code></td>
<td>

<p>Le nom ou le numéro de la colonne qui contient l'énoncé des
questions.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>colonne.reponse</code></td>
<td>

<p>Le nom ou le numéro de la colonne qui contient la ou les réponses
aux questions.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>colonne.note</code></td>
<td>

<p>Le nom ou le numéro de la colonne qui contient la note associée à
chaque réponse. Si elle n'est pas indiquée, une colonne intitulée «
Note » (insensible à la casse) est cherchée dans le fichier. Cette
colonne est obligatoire en cas de question à réponses
multiples. Elle peut alors contenir soit le pourcentage de la note
(voir les détails), soit « Vrai » ou « Faux » (insensible à la
casse) et les pourcentages sont calculés en conséquence (avec
toujours 0 pour « Faux »: indiquez explicitement un pourcentage
négatif si nécessaire). 
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>colonne.note_question</code></td>
<td>
<p> Le nom ou le numéro de la colonne qui
contient la note globale de la question. Si elle n'est pas indiquée,
une colonne intitulée « Note question » (insensible à la casse) est
cherchée dans le fichier. Cette colonne est facultative. Si elle
existe, elle doit contenir un entier strictement positif donnant la
note globale de la question, ou rester vide. Toute note non indiquée
sera supposée égale à 1 (valeur par défaut de Moodle).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>colonne.titre</code></td>
<td>

<p>Le nom ou le numéro de la colonne qui contient le titre à donner à
la question dans Moodle. Si elle est manquante, le titre est
construit, sous la forme <code>xx yy</code> où <code>yy</code> correspond aux
<code>lg.titre</code> premiers caractères de la question, et <code>xx</code> au
code de la question.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>colonne.code</code></td>
<td>

<p>Le nom ou le numéro de la colonne qui contient le code de la
question. Cette colonne n'est obligatoire que pour créer des
questions « cloze ». Si elle est manquante, un code interne de la
forme <code>[Qnn]</code>, où <code>nn</code> est le numéro de la question, est
construit, chaque question correspondant à une ligne avec les deux
colonnes <code>colonne.texte</code> et <code>colonne.reponse</code>
renseignées. Voyez les détails pour davantage de précisions.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>colonne.type</code></td>
<td>

<p>Le nom ou le numéro de la colonne qui contient le type de la
question. Cette colonne peut être utilisée pour indiquer qu'une
question avec plusieurs réponses proposées n'a qu'une seule réponse
possible, en indiquant QCU pour au moins une des réponses (question
à choix unique); QCM permet d'indiquer que l'on peut cocher
plusieurs réponses (question à choix multiples). Dans ce cas,
<code>forcer.multiple</code> est ignoré.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>colonne.retour</code></td>
<td>

<p>Le nom ou le numéro de la colonne qui contient le commentaire à
afficher pour chaque réponse. Cette colonne est facultative.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>colonne.global</code></td>
<td>

<p>Le nom ou le numéro de la colonne qui contient le commentaire à
afficher globalement pour la question. Cette colonne est facultative.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>colonne.penalite</code></td>
<td>
<p> Le nom ou le numéro de la colonne qui
contient la pénalité à mettre en cas de nouvelle tentative de la
question. Si elle n'est pas indiquée, une colonne intitulée «
Pénalité » (insensible à la casse) est cherchée dans le
fichier. Cette colonne est facultative. Si elle existe, elle doit
contenir la fraction de la note globale de la
question qui sera prise en compte pour noter la nouvelle tentative
(par exemple, si la question a une note globale de 2 et la pénalité
est de 0,5, à la seconde tentative la note maximale possible sera de
1) ou rester vide. Toute pénalité non indiquée sera supposée
égale à 1 (pas de pénalité en cas de nouvelle tentative).
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>colonne.temps</code></td>
<td>
<p> Le nom ou le numéro de la colonne qui contient
le temps conseillé pour la question. Cette colonne est facultative.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>colonne.decimale</code></td>
<td>
<p> Le nom ou le numéro de la colonne qui contient
le nombre de chiffres après la virgule attendu pour la réponse à la
question (pour les questions numériques uniquement). Cette colonne
est facultative.  </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fichier.xml</code></td>
<td>

<p>Le nom du fichier XML à créer ou un fichier XML déjà créé avec
<code>debuter_xml.moodle</code>. Par
défaut, la fonction crée un fichier de même nom que le premier
fichier fourni, en remplaçant l'extension <code>.csv</code> par
<code>.xml</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nv.fichier</code></td>
<td>

<p>Une valeur logique indiquant si l'on veut créer un nouveau fichier
(<code>TRUE</code>) ou utiliser un fichier XML déjà ouvert avec
<code>debuter_xml.moodle</code> (<code>FALSE</code>)
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>creer.titre</code></td>
<td>

<p>Une valeur logique indiquant si l'on veut créer un titre pour chaque
question, à partir de son code et du début de son énoncé
(<code>TRUE</code>) ou non. Ignoré si une colonne de titres a été fournie.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lg.titre</code></td>
<td>

<p>Le nombre de caractères de l'énoncé d'une question à conserver pour
construire son titre. Ignoré si une colonne de titres a été fournie
ou si <code>creer.titre=FALSE</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>embellir,deja.HTML</code></td>
<td>

<p>Actuellement inutilisés, prévus pour une version future
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>forcer.multiple</code></td>
<td>

<p>Si <code>TRUE</code>, les questions avec plusieurs réponses sont toujours
considérées comme des réponses à choix multiples (l'étudiant pourra
cocher plusieurs réponses). Sinon, si une seule bonne réponse est
proposée (plus exactement, s'il existe au moins une réponse donnant 100 % des
points), la question est à choix unique (l'étudiant ne pourra
choisir qu'une seule réponse).  Cette option est ignorée pour les
questions qui auraient une valeur indiquée dans la colonne précisée
dans <code>colonne.type</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>melanger.reponses</code></td>
<td>

<p>Si <code>TRUE</code>, autorise Moodle à permuter aléatoirement l'ordre des
réponses lorsqu'il pose la question. Sinon, l'ordre du fichier est
tout le temps utilisé.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>somme.nulle</code></td>
<td>

<p>Cette option précise comment gérer les réponses incorrectes dans un
QCM.  Si <code>FALSE</code>, la note de ces réponses est déterminée à
partir du fichier, le code FAUX étant associé à une note nulle.
Si <code>TRUE</code>, les réponses incorrectes se voient attribuer une
note négative telle que la somme de ces notes vaut -1, de sorte que
si l'étudiant coche toutes les cases du QCM, il a 0 (sauf bien sûr
si toutes les cases correspondent à des questions correctes...).
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>precision</code></td>
<td>
<p>Le nombre de décimales à donner dans la réponse, pour
une réponse numérique (utilisez <code>NA</code> pour une valeur exacte et
ne pas avoir de message indiquant le nombre de décimales ajouté au
texte de la question).
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>categorie.base</code></td>
<td>

<p>La catégorie de base à utiliser pour créer les questions. Elle
contiendra toutes les sous-catégories du fichier, s'il y en a.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dossier.images</code></td>
<td>
<p> Le dossier d'image où trouver les images à
intégrer au fichier XML, ou l'URL de base pour les trouver dans
Moodle (voir <code>definir_dossier.image.moodle</code>). </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sep.images</code></td>
<td>
<p> Les codes servant à encadrer un nom d'image dans
les textes du fichier CSV. </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>inserer.images</code></td>
<td>
<p> Si <code>TRUE</code>, les images sont incluses dans
le fichier XML. Sinon, seul le lien est construit. </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sep.formules</code></td>
<td>
<p> Les codes servant à encadrer une formule
mathématique à convertir grâce à latex dans les textes du fichier
CSV. </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sep.SMILES</code></td>
<td>
<p> Les codes servant à encadrer un code SMILES à
convertir en formule chimique grâce à openbabel dans les textes du
fichier CSV. </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sep, header, quote</code></td>
<td>

<p>Options pour <code>read.table</code>, correspondant au format d'un
fichier CSV par défaut lorsqu'il est créé par Libre office ou Excel.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>

<p>Autres options pour <code>read.table</code>, si nécessaire.
</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>Ces fonctions réalisent la conversion d'un ou plusieurs fichiers
structurés de questions pour Moodle en un fichier XML. La nature des
questions est déduite de la structure du fichier.  Le fichier peut
être au format CSV (format recommandé), Libre Office Calc (ODS) ou
Excel (XLSX). Dans les deux derniers cas, il est possible de convertir
toutes les feuilles du classeur ou juste une partie. Chaque feuille à
convertir doir avoir la structure décrite ci-après, correspondant au
format du fichier CSV.
</p>
<p>Le fichier doit comporter au moins deux colonnes : l'une avec les
énoncés des questions et l'autre avec les réponses. Chaque ligne
correspond à une réponse possible.
</p>
<p>Pour les questions simples, la question tient sur une ligne. La nature
de la question est déduite de la réponse. Si la réponse peut être
convertie en nombre, la question est supposée être une réponse
numérique; elle sera créée avec un appel à
<code>numerique.moodle</code>.  Si la réponse est identifiée comme
une valeur logique (un des textes « V », « F », « T », « Vrai », «
Faux », « True » ou « False », quelle que soit la casse), la question
est supposée être une question binaire avec les deux réponses « Vrai »
et « Faux »; elle sera créée avec un appel à
<code>vrai_faux.moodle</code>.  Dans tous les autres cas, la question
est supposée être à réponse ouverte et courte et sera créée par un
appel à <code>qroc.moodle</code>. Par défaut, la réponse est sensible
à la casse; cela peut être modifié en indiquant « I » dans la colonne
précisant le type de question.
</p>
<p>S'il y a un énoncé, mais pas de réponse, cet énoncé est supposé être
une indication de catégorie (sauf si la question a le même code qu'une
question « cloze », voir plus loin, ou si la colonne précisant le type
de question indique un type particulier) qui sera créée comme une
sous-catégorie de la catégorie de base, par un appel à
<code>categorie.moodle</code>.  Si une colonne précise le type, la
question peut être de type rédactionnel (réponse libre dans un éditeur
de texte, pas de correction automatique; type « R »,
<code>question_ouverte.moodle</code>), description (un texte
s'affiche, mais aucune réponse n'est attendue; type « D »,
<code>description.moodle)</code> ou texte à trou (il faudra replacer
les textes dans les trous de l'énoncé, les trous étant construits à
partir des termes encadrés par des [[doubles crochets]]); type « T »,
<code>glisser_textes.moodle</code>)
</p>
<p>S'il y a une réponse, mais pas d'énoncé, cette réponse est supposée
être une autre réponse possible à une question à choix multiple, dont
l'énoncé est dans la première ligne précédente qui en contient un.
Dans ce cas, le fichier doit contenir une colonne qui contient les
notes associées à chaque réponse. Cette note peut être précise,
exprimée en pourcentage suivant la convention Moodle, ou indicative,
avec la simple mention « Vrai » pour les bonnes réponses et « Faux »
pour les mauvaises. Dans le deuxième cas, les bonnes réponses sont
associées à l'inverse du nombre de bonnes réponses, de sorte que
cocher toutes les bonnes réponses donne la note totale; les mauvaises
réponses sont associées à la note 0 (si <code>somme.nulle=FALSE</code>:
cocher ou non ces réponses ne change rien à la note) ou à l'opposé de
l'inverse du nombre de mauvaises réponses (si <code>somme.nulle=TRUE</code>:
cocher ces réponses diminue la note et cocher toutes les réponses
donne une somme nulle).  Par défaut, la question construite est
toujours un QCM (plusieurs réponses peuvent être choisies), même s'il
y a une seule bonne réponse. Pour demander qu'une seule réponse puisse
être choisie (QCU), indiquez le type QCU dans la colonne indiquée par
<code>colonne.type</code> pour la question considérée. Si vous voulez que
toutes les questions avec une seule bonne réponse soient en QCU, vous
pouvez aussi utiliser l'option <code>forcer.multiple = FALSE</code>.
</p>
<p><strong>Construire des questions “<em>cloze</em>”</strong>
</p>
<p>Pour pouvoir construire des questions “<em>cloze</em>”, le
fichier doit obligatoirement contenir une colonne qui indique le code
de chaque question (y compris les catégories). Ce code doit être
unique pour une même question; toutes les lignes qui auront le même
code seront donc considérées comme faisant partie de la même question.
</p>
<p>De ce fait, si plusieurs lignes d'énoncé renseignées ont le même code,
elles sont considérées faisant partie de la même question et sont
utilisées pour construire une question “<em>cloze</em>”, selon le
même principe que la fonction <code>question_libre.moodle</code>:
après chaque partie d'énoncé, un champ de réponse est créé, dont la
bonne réponse est celle indiquée dans la colonne
<code>colonne.reponse</code> et sert à définir le type de champ de réponse
(selon la logique des questions en une ligne).  Pour avoir un texte
après le dernier champ de réponse, laissez la colonne
<code>colonne.reponse</code> vide tout en gardant le même code de question.
</p>
<p>Pour avoir des questions avec réponse à choisir dans une liste, mettez
une réponse par ligne sans mettre d'énoncé avant, comme pour un QCM.
La colonne <code>colonne.type</code> permet de préciser le type d'affichage,
avec les codes Moodle (<code>MULTICHOICE</code>, <code>MULTICHOICE_S</code>...).
Il est possible d'abréger le code: M correspond à un choix dans un
menu déroulant (une seule réponse possible ; <code>MULTICHOICE</code>) ; H,
à des réponses juxtaposés (<code>MULTICHOICE_H</code>) ; V, à des réponses
superposées (<code>MULTICHOICE_V</code>) ; SA, à un champ libre attendant
une réponse courte, de type Q. R. O. C. (<code>SHORTANSWER</code>).  Pour
les réponses superposées ou juxtaposés, par défaut, une seule réponse
peut être choisie et l'ordre est celui indiqué dans le fichier. Il est
possible d'indiquer que plusieurs réponses peuvent être choisies en
ajoutant le code M (VM, HM) ; il est possible de demander à Moodle de
tirer au sort l'ordre des réponses en ajoutant le code A (MA, VA,
VMA...) ou S (MS, VS...).  Pour le champ libre, par défaut la casse
est ignorée. Il est possible d'indiquer que la casse doit être
contrôlée grâce au code SAC (<code>SHORTANSWER_C</code>). L'ordre des codes
n'a pas d'importance (HM et MH donneront tous deux une question de
type <code>MULTICHOICE_H</code>).
</p>
<p><strong>Insérer des images</strong>
</p>
<p>Il est possible de faire référence à une image dans les textes
(énoncés, réponses, commentaires) en encadrant le nom de fichier de
l'image par les séparateurs choisis, par défaut <code>@@</code>. Il est
possible de redimensionner l'image en faisant suivre le nom de l'image
d'un point d'exclamation, puis de la largeur, du caractère x et de la
hauteur.  Attention, il semblerait que Moodle ne déforme pas les
images, quelles que soient les dimensions demandées.  Par défaut,
l'image sera incluse au fichier XML.
</p>
<p>Deux types d'image peuvent être créés au vol : les formules
mathématiques et les formules chimiques. Voir les fonctions
<code>inserer_formule.moodle</code> et
<code>inserer_SMILES.moodle</code> pour plus de détails.
</p>


<h3>Value</h3>

<p>De façon invisible, une liste des data.frames des questions après
traitement de chaque fichier.  Elle n'a guère d'autre intérêt que pour
détecter l'origine d'un problème de conversion.
</p>


<h3>Attention!</h3>

<p>Moodle est assez peu permissif pour les notes
exprimées en pourcentage; en particulier, lorsque ce pourcentage ne
tombe pas juste (33% pour trois bonnes réponses, par exemple), à
cause de l'arrondi il peut rejeter le fichier créé. Dans ce cas,
désactivez l'arrêt en cas d'erreur et demandez l'arrondi à la note la
plus proche pour pouvoir importer les questions.
</p>


<h3>Author(s)</h3>

<p>Emmanuel Curis <a href="mailto:emmanuel.curis@parisdescartes.fr">emmanuel.curis@parisdescartes.fr</a>
</p>


<h3>See Also</h3>

<p>Les fonctions de base de création de questions pour plus de souplesse,
et en particulier pour créer des questions non gérées par le format de
fichier ci-dessus.
</p>
<p><code>csv_optique.moodle</code> pour convertir des fichiers CSV au
format utilisé par les lecteurs optiques.
</p>


<h3>Examples</h3>

<pre><code class="language-R">  # Conversion du fichier d'exemple fourni
  #  (à placer dans le répertoire de travail)
## Not run: 
  csv.moodle( "exemple_Moodle.csv", colonne.code = "Code" )

## End(Not run)
</code></pre>


</div>