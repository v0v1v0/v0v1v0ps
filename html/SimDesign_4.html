<div class="container">

<table style="width: 100%;"><tr>
<td>SimCollect</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Collapse separate simulation files into a single result</h2>

<h3>Description</h3>

<p>This function collects and aggregates the results from
<code>SimDesign</code>'s <code>runSimulation</code> into a single
objects suitable for post-analyses, or combines all the saved results directories and combines
them into one. This is useful when results are run piece-wise on one node (e.g., 500 replications
in one batch, 500 again at a later date, though be careful about the <code>set.seed</code>
use as the random numbers will tend to correlate the more it is used) or run independently across different
nodes/computing cores (e.g., see <code>runArraySimulation</code>.
</p>


<h3>Usage</h3>

<pre><code class="language-R">SimCollect(
  dir = NULL,
  files = NULL,
  filename = NULL,
  select = NULL,
  check.only = FALSE,
  target.reps = NULL,
  warning_details = FALSE,
  error_details = TRUE
)

aggregate_simulations(...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>dir</code></td>
<td>
<p>a <code>character</code> vector pointing to the directory name containing the <code>.rds</code> files.
All <code>.rds</code> files in this directory will be used after first checking
their status with <code>SimCheck</code>. For greater specificity use the
<code>files</code> argument</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>files</code></td>
<td>
<p>a <code>character</code> vector containing the names of the simulation's final <code>.rds</code> files.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>filename</code></td>
<td>
<p>(optional) name of .rds file to save aggregate simulation file to. If not specified
then the results will only be returned in the R console.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>select</code></td>
<td>
<p>a character vector indicating columns to variables to select from the
<code>SimExtract(what='results')</code> information. This is mainly useful when RAM is an issue
given simulations with many stored estimates. Default includes the results objects
in their entirety, though to omit all internally stored simulation results pass the
character <code>'NONE'</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>check.only</code></td>
<td>
<p>logical; for larger simulations file sets, such as those generated by
<code>runArraySimulation</code>, return the design conditions that do no satisfy the
<code>target.reps</code> and throw warning if files are unexpectedly missing</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>target.reps</code></td>
<td>
<p>(optional) number of replications to check against to evaluate whether
the simulation files returned the desired number of replications. If missing, the highest
detected value from the collected set of replication information will be used</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>warning_details</code></td>
<td>
<p>logical; include the aggregate of the warnings to be extracted via
<code>SimExtract</code>?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>error_details</code></td>
<td>
<p>logical; include the aggregate of the errors to be extracted via
<code>SimExtract</code>?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>not used</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>returns a <code>data.frame/tibble</code> with the (weighted) average/aggregate
of the simulation results
</p>


<h3>Author(s)</h3>

<p>Phil Chalmers <a href="mailto:rphilip.chalmers@gmail.com">rphilip.chalmers@gmail.com</a>
</p>


<h3>References</h3>

<p>Chalmers, R. P., &amp; Adkins, M. C.  (2020). Writing Effective and Reliable Monte Carlo Simulations
with the SimDesign Package. <code>The Quantitative Methods for Psychology, 16</code>(4), 248-280.
<a href="https://doi.org/10.20982/tqmp.16.4.p248">doi:10.20982/tqmp.16.4.p248</a>
</p>
<p>Sigal, M. J., &amp; Chalmers, R. P. (2016). Play it again: Teaching statistics with Monte
Carlo simulation. <code>Journal of Statistics Education, 24</code>(3), 136-156.
<a href="https://doi.org/10.1080/10691898.2016.1246953">doi:10.1080/10691898.2016.1246953</a>
</p>


<h3>See Also</h3>

<p><code>runSimulation</code>, <code>runArraySimulation</code>,
<code>SimCheck</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Not run: 

setwd('my_working_directory')

## run simulations to save the .rds files (or move them to the working directory)
# seeds1 &lt;- genSeeds(design)
# seeds2 &lt;- genSeeds(design, old.seeds=seeds1)
# ret1 &lt;- runSimulation(design, ..., seed=seeds1, filename='file1')
# ret2 &lt;- runSimulation(design, ..., seed=seeds2, filename='file2')

# saves to the hard-drive and stores in workspace
final &lt;- SimCollect(files = c('file1.rds', 'file2.rds'))
final

# If filename not included, can be extracted from results
# files &lt;- c(SimExtract(ret1, 'filename'), SimExtract(ret2, 'filename'))
# final &lt;- SimCollect(files = files)


#################################################
# Example where each row condition is repeated, evaluated independently,
# and later collapsed into a single analysis object

# Each condition repeated four times (hence, replications
# should be set to desired.reps/4)
Design &lt;- createDesign(mu = c(0,5),
                       N  = c(30, 60))
Design

# assume the N=60 takes longer, and should be spread out across more arrays
Design_long &lt;- expandDesign(Design, c(2,2,4,4))
Design_long

replications &lt;- c(rep(50, 4), rep(25,8))
data.frame(Design_long, replications)

#-------------------------------------------------------------------

Generate &lt;- function(condition, fixed_objects) {
    dat &lt;- with(condition, rnorm(N, mean=mu))
    dat
}

Analyse &lt;- function(condition, dat, fixed_objects) {
    ret &lt;- c(mean=mean(dat), SD=sd(dat))
    ret
}

Summarise &lt;- function(condition, results, fixed_objects) {
    ret &lt;- colMeans(results)
    ret
}

#-------------------------------------------------------------------

# create directory to store all final simulation files
dir.create('sim_files/')

iseed &lt;- genSeeds()

# distribute jobs independently
sapply(1:nrow(Design_long), \(i) {
  runArraySimulation(design=Design_long, replications=replications,
                generate=Generate, analyse=Analyse, summarise=Summarise,
                arrayID=i, dirname='sim_files/', filename='job', iseed=iseed)
}) |&gt; invisible()

# check that all replications satisfy target
SimCollect('sim_files/', check.only = TRUE)

# this would have been returned were the target.rep supposed to be 1000
SimCollect('sim_files/', check.only = TRUE, target.reps=1000)

# aggregate into single object
sim &lt;- SimCollect('sim_files/')
sim

SimClean(dir='sim_files/')


## End(Not run)
</code></pre>


</div>