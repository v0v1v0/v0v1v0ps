<div class="container">

<table style="width: 100%;"><tr>
<td>shapviz</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Initialize "shapviz" Object</h2>

<h3>Description</h3>

<p>This function creates an object of class "shapviz" from a matrix of SHAP values, or
from a fitted model of type
</p>

<ul>
<li>
<p> XGBoost,
</p>
</li>
<li>
<p> LightGBM, or
</p>
</li>
<li>
<p> H2O (tree-based regression or binary classification model).
</p>
</li>
</ul>
<p>Furthermore, <code>shapviz()</code> can digest the results of
</p>

<ul>
<li> <p><code>fastshap::explain()</code>,
</p>
</li>
<li> <p><code>shapr::explain()</code>,
</p>
</li>
<li> <p><code>treeshap::treeshap()</code>,
</p>
</li>
<li> <p><code>DALEX::predict_parts()</code>,
</p>
</li>
<li> <p><code>kernelshap::kernelshap()</code>,
</p>
</li>
<li> <p><code>kernelshap::permshap()</code>, and
</p>
</li>
<li> <p><code>kernelshap::additive_shap()</code>,
</p>
</li>
</ul>
<p>check the vignettes for examples.
</p>


<h3>Usage</h3>

<pre><code class="language-R">shapviz(object, ...)

## Default S3 method:
shapviz(object, ...)

## S3 method for class 'matrix'
shapviz(object, X, baseline = 0, collapse = NULL, S_inter = NULL, ...)

## S3 method for class 'xgb.Booster'
shapviz(
  object,
  X_pred,
  X = X_pred,
  which_class = NULL,
  collapse = NULL,
  interactions = FALSE,
  ...
)

## S3 method for class 'lgb.Booster'
shapviz(object, X_pred, X = X_pred, which_class = NULL, collapse = NULL, ...)

## S3 method for class 'explain'
shapviz(object, X = NULL, baseline = NULL, collapse = NULL, ...)

## S3 method for class 'treeshap'
shapviz(
  object,
  X = object[["observations"]],
  baseline = 0,
  collapse = NULL,
  ...
)

## S3 method for class 'predict_parts'
shapviz(object, ...)

## S3 method for class 'shapr'
shapviz(object, X = object[["x_test"]], collapse = NULL, ...)

## S3 method for class 'kernelshap'
shapviz(object, X = object[["X"]], which_class = NULL, collapse = NULL, ...)

## S3 method for class 'H2ORegressionModel'
shapviz(object, X_pred, X = as.data.frame(X_pred), collapse = NULL, ...)

## S3 method for class 'H2OBinomialModel'
shapviz(object, X_pred, X = as.data.frame(X_pred), collapse = NULL, ...)

## S3 method for class 'H2OModel'
shapviz(object, X_pred, X = as.data.frame(X_pred), collapse = NULL, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>object</code></td>
<td>
<p>For XGBoost, LightGBM, and H2O, this is the fitted model used to
calculate SHAP values from <code>X_pred</code>.
In the other cases, it is the object containing the SHAP values.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>Parameters passed to other methods (currently only used by
the <code>predict()</code> functions of XGBoost, LightGBM, and H2O).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>X</code></td>
<td>
<p>Matrix or data.frame of feature values used for visualization.
Must contain at least the same column names as the SHAP matrix represented by
<code>object</code>/<code>X_pred</code> (after optionally collapsing some of the SHAP columns).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>baseline</code></td>
<td>
<p>Optional baseline value, representing the average response at the
scale of the SHAP values. It will be used for plot methods that explain single
predictions.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>collapse</code></td>
<td>
<p>A named list of character vectors. Each vector specifies the
feature names whose SHAP values need to be summed up.
The names determine the resulting collapsed column/dimension names.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>S_inter</code></td>
<td>
<p>Optional 3D array of SHAP interaction values.
If <code>object</code> has shape n x p, then <code>S_inter</code> needs to be of
shape n x p x p. Summation over the second (or third) dimension should yield the
usual SHAP values. Furthermore, dimensions 2 and 3 are expected to be symmetric.
Default is <code>NULL</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>X_pred</code></td>
<td>
<p>Data set as expected by the <code>predict()</code> function of
XGBoost, LightGBM, or H2O. For XGBoost, a matrix or <code>xgb.DMatrix</code>,
for LightGBM a matrix, and for H2O a <code>data.frame</code> or an <code>H2OFrame</code>.
Only used for XGBoost, LightGBM, or H2O objects.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>which_class</code></td>
<td>
<p>In case of a multiclass or multioutput setting,
which class/output (&gt;= 1) to explain. Currently relevant for XGBoost, LightGBM,
kernelshap, and permshap.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>interactions</code></td>
<td>
<p>Should SHAP interactions be calculated (default is <code>FALSE</code>)?
Only available for XGBoost.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>Together with the main input, a data set <code>X</code> of feature values is required,
used only for visualization. It can therefore contain character or factor
variables, even if the SHAP values were calculated from a purely numerical feature
matrix. In addition, to improve visualization, it can sometimes be useful to truncate
gross outliers, logarithmize certain columns, or replace missing values with an
explicit value.
</p>
<p>SHAP values of dummy variables can be combined using the convenient
<code>collapse</code> argument.
Multi-output models created from XGBoost, LightGBM, "kernelshap", or "permshap"
return a "mshapviz" object, containing a "shapviz" object per output.
</p>


<h3>Value</h3>

<p>An object of class "shapviz" with the following elements:
</p>

<ul>
<li> <p><code>S</code>: Numeric matrix of SHAP values.
</p>
</li>
<li> <p><code>X</code>: <code>data.frame</code> containing the feature values corresponding to <code>S</code>.
</p>
</li>
<li> <p><code>baseline</code>: Baseline value, representing the average prediction at the
scale of the SHAP values.
</p>
</li>
<li> <p><code>S_inter</code>: Numeric array of SHAP interaction values (or <code>NULL</code>).
</p>
</li>
</ul>
<h3>Methods (by class)</h3>


<ul>
<li> <p><code>shapviz(default)</code>: Default method to initialize a "shapviz" object.
</p>
</li>
<li> <p><code>shapviz(matrix)</code>: Creates a "shapviz" object from a matrix of SHAP values.
</p>
</li>
<li> <p><code>shapviz(xgb.Booster)</code>: Creates a "shapviz" object from an XGBoost model.
</p>
</li>
<li> <p><code>shapviz(lgb.Booster)</code>: Creates a "shapviz" object from a LightGBM model.
</p>
</li>
<li> <p><code>shapviz(explain)</code>: Creates a "shapviz" object from <code>fastshap::explain()</code>.
</p>
</li>
<li> <p><code>shapviz(treeshap)</code>: Creates a "shapviz" object from <code>treeshap::treeshap()</code>.
</p>
</li>
<li> <p><code>shapviz(predict_parts)</code>: Creates a "shapviz" object from <code>DALEX::predict_parts()</code>.
</p>
</li>
<li> <p><code>shapviz(shapr)</code>: Creates a "shapviz" object from <code>shapr::explain()</code>.
</p>
</li>
<li> <p><code>shapviz(kernelshap)</code>: Creates a "shapviz" object from an object of class 'kernelshap'. This includes
results of <code>kernelshap()</code>, <code>permshap()</code>, and <code>additive_shap()</code>.
</p>
</li>
<li> <p><code>shapviz(H2ORegressionModel)</code>: Creates a "shapviz" object from a (tree-based) H2O regression model.
</p>
</li>
<li> <p><code>shapviz(H2OBinomialModel)</code>: Creates a "shapviz" object from a (tree-based) H2O binary classification model.
</p>
</li>
<li> <p><code>shapviz(H2OModel)</code>: Creates a "shapviz" object from a (tree-based) H2O model (base class).
</p>
</li>
</ul>
<h3>See Also</h3>

<p><code>sv_importance()</code>, <code>sv_dependence()</code>, <code>sv_dependence2D()</code>, <code>sv_interaction()</code>,
<code>sv_waterfall()</code>, <code>sv_force()</code>, <code>collapse_shap()</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">S &lt;- matrix(c(1, -1, -1, 1), ncol = 2, dimnames = list(NULL, c("x", "y")))
X &lt;- data.frame(x = c("a", "b"), y = c(100, 10))
shapviz(S, X, baseline = 4)
# XGBoost models
X_pred &lt;- data.matrix(iris[, -1])
dtrain &lt;- xgboost::xgb.DMatrix(X_pred, label = iris[, 1], nthread = 1)
fit &lt;- xgboost::xgb.train(data = dtrain, nrounds = 10, nthread = 1)

# Will use numeric matrix "X_pred" as feature matrix
x &lt;- shapviz(fit, X_pred = X_pred)
x
sv_dependence(x, "Species")

# Will use original values as feature matrix
x &lt;- shapviz(fit, X_pred = X_pred, X = iris)
sv_dependence(x, "Species")

# "X_pred" can also be passed as xgb.DMatrix, but only if X is passed as well!
x &lt;- shapviz(fit, X_pred = dtrain, X = iris)

# Multiclass setting
params &lt;- list(objective = "multi:softprob", num_class = 3)
X_pred &lt;- data.matrix(iris[, -5])
dtrain &lt;- xgboost::xgb.DMatrix(
  X_pred, label = as.integer(iris[, 5]) - 1, nthread = 1
)
fit &lt;- xgboost::xgb.train(params = params, data = dtrain, nrounds = 10, nthread = 1)

# Select specific class
x &lt;- shapviz(fit, X_pred = X_pred, which_class = 3)
x

# Or combine all classes to "mshapviz" object
x &lt;- shapviz(fit, X_pred = X_pred)
x

# What if we would have one-hot-encoded values and want to explain the original column?
X_pred &lt;- stats::model.matrix(~ . -1, iris[, -1])
dtrain &lt;- xgboost::xgb.DMatrix(X_pred, label = as.integer(iris[, 1]), nthread = 1)
fit &lt;- xgboost::xgb.train(data = dtrain, nrounds = 10, nthread = 1)
x &lt;- shapviz(
  fit,
  X_pred = X_pred,
  X = iris,
  collapse = list(Species = c("Speciessetosa", "Speciesversicolor", "Speciesvirginica"))
)
summary(x)

# Similarly with LightGBM
if (requireNamespace("lightgbm", quietly = TRUE)) {
  fit &lt;- lightgbm::lgb.train(
    params = list(objective = "regression", num_thread = 1),
    data = lightgbm::lgb.Dataset(X_pred, label = iris[, 1]),
    nrounds = 10,
    verbose = -2
  )

  x &lt;- shapviz(fit, X_pred = X_pred)
  x

  # Multiclass
  params &lt;- list(objective = "multiclass", num_class = 3, num_thread = 1)
  X_pred &lt;- data.matrix(iris[, -5])
  dtrain &lt;- lightgbm::lgb.Dataset(X_pred, label = as.integer(iris[, 5]) - 1)
  fit &lt;- lightgbm::lgb.train(params = params, data = dtrain, nrounds = 10)

  # Select specific class
  x &lt;- shapviz(fit, X_pred = X_pred, which_class = 3)
  x

  # Or combine all classes to a "mshapviz" object
  mx &lt;- shapviz(fit, X_pred = X_pred)
  mx
  all.equal(mx[[3]], x)
}
</code></pre>


</div>