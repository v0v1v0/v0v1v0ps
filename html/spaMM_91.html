<div class="container">

<table style="width: 100%;"><tr>
<td>corrHLfit</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>
Fits a mixed model, typically a spatial GLMM.
</h2>

<h3>Description</h3>

<p>This was the first function for fitting all spatial models in spaMM, and is still fully functional, but it is recommended to use <code>fitme</code> which has different defaults and generally selects more efficient fitting methods, and will handle all classes of models that spaMM can fit, including non-spatial ones. <code>corrHLfit</code> performs the joint estimation of correlation parameters, fixed effect and dispersion parameters. 
</p>


<h3>Usage</h3>

<pre><code class="language-R">corrHLfit(formula, data, init.corrHLfit = list(), init.HLfit = list(), 
          ranFix, fixed=list(), lower = list(),  upper = list(), 
          objective = NULL, resid.model = ~1, 
          control.dist = list(), control.corrHLfit = list(),
          processed = NULL, family = gaussian(), method="REML",
          nb_cores = NULL, weights.form = NULL, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>formula</code></td>
<td>

<p>Either a linear model <code>formula</code> (as handled  by various fitting functions) or a <code>predictor</code>, i.e. a formula with attributes (see <code>Predictor</code> and examples below). See Details in <code>spaMM</code> for allowed terms in the formula.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>A data frame containing the variables in the response and the model formula.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>init.corrHLfit</code></td>
<td>

<p>An optional list of initial values for correlation and/or dispersion parameters, e.g. 
<code>list(rho=1,nu=1,lambda=1,phi=1)</code> where <code>rho</code> and <code>nu</code> are parameters of the Matérn family (see <code>Matern</code>), and 
<code>lambda</code> and <code>phi</code> are dispersion parameters (see Details in <code>spaMM</code> for the meaning of these parameters). 
All are optional, but giving values for 
a dispersion parameter changes the ways it is estimated (see Details).
<code>rho</code>  may be a vector (see <code>make_scaled_dist</code>) and, in that case, it is possible that some or all of its elements are <code>NA</code>, for which <code>corrHLfit</code> substitutes automatically determined values.  
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>init.HLfit</code></td>
<td>
<p>See identically named <code>HLfit</code> argument.

</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fixed, ranFix</code></td>
<td>
<p>A list similar to <code>init.corrHLfit</code>, but specifying fixed values of the parameters not estimated. <code>ranFix</code> is the old argument, maintained for back compatibility; <code>fixed</code> is the new argument, uniform across <span class="pkg">spaMM</span> fitting functions. See <code>ranFix</code> for further information.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lower</code></td>
<td>

<p>An optional (sub)list of values of the parameters specified through <code>init.corrHLfit</code>, in the same format as <code>init.corrHLfit</code>, used as lower values in calls to <code>optim</code>. See Details for default values.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>upper</code></td>
<td>
<p>Same as <code>lower</code>, but for upper values.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>objective</code></td>
<td>
<p> For development purpose, not documented (this had a distinct use in the first version of spaMM, but has been deprecated as such).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>resid.model</code></td>
<td>
<p>See identically named <code>HLfit</code> argument.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>control.dist</code></td>
<td>
<p>See <code>control.dist</code> in <code>HLCor</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>control.corrHLfit</code></td>
<td>

<p>This may be used control the optimizer. See <code>spaMM.options</code></p>
</td>
</tr>
</table>
<p> for default values.
</p>
<table>
<tr style="vertical-align: top;">
<td><code>processed</code></td>
<td>
<p>For programming purposes, not documented.  </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>family</code></td>
<td>
<p>Either a <code>family</code> or a <code>multi</code> value. </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method</code></td>
<td>
<p>Character: the fitting method to be used, such as <code>"ML"</code>, <code>"REML"</code> or <code>"PQL/L"</code>. <code>"REML"</code> is the default. Other possible values of <code>HLfit</code>'s <code>method</code> argument are handled.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>weights.form</code></td>
<td>

<p>Specification of prior weights by a one-sided formula: use <code>weights.form = ~ pw</code> instead of <code>prior.weights = pw</code>. The effect will be the same except that such an argument, known to evaluate to an object of class <code>"formula"</code>, is suitable to enforce safe programming practices (see <code>good-practice</code>).  
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nb_cores</code></td>
<td>
<p><b>Not yet operative</b>, only for development purposes. Number of cores to use for parallel computations. </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>

<p>Optional arguments passed to <code>HLCor</code>, <code>HLfit</code> or  <code>mat_sqrt</code>, for example the <code>distMatrix</code> argument 
of <code>HLCor</code>, or the <code>verbose</code> argument of <code>HLfit</code>. Arguments that do not fit within these functions are detected and a warning is issued. In a <code>corrHLfit</code> call, the <code>verbose</code> vector of booleans may include a <code>TRACE=TRUE</code> element, in which case information is displayed for each set of correlation and dispersion parameter values considered by the optimiser (see <code>verbose</code> for further information, mostly useless except for development purposes).
</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>For approximations of likelihood, see <code>method</code>.  For the possible structures of random effects, see <code>random-effects</code>,
</p>
<p>By default <code>corrHLfit</code> will estimate correlation parameters by maximizing the <code>objective</code> value returned by <code>HLCor</code> calls wherein the dispersion parameters are estimated jointly with fixed effects for given correlation parameters. If dispersion parameters are specified in <code>init.corrHLfit</code>, they will also be estimated by maximizing the <code>objective</code> value, and <code>HLCor calls</code> will not estimate them jointly with fixed effects. This means that in general the fixed effect estimates may vary depending on <code>init.corrHLfit</code> when any form of REML correction is applied. 
</p>
<p>Correctly using <code>corrHLfit</code> for likelihood ratio tests of fixed effects may then be tricky. It is safe to perform full ML fits of all parameters (using <code>method="ML"</code>) for such tests (see Examples).   The higher level function <code>fixedLRT</code> is a safe interface for likelihood ratio tests using some form of REML estimation in <code>corrHLfit</code>.  
</p>
<p><code>attr(&lt;fitted object&gt;,"optimInfo")$lower</code> and ...<code>$upper</code> gives the lower and upper bounds for optimization of correlation parameters. These are the default values if the user did not provide explicit values. For the adjacency model, the default values are the inverse of the maximum and minimum eigenvalues of the <code>adjMatrix</code>. For the Matérn model, the default values are not so easily summarized: they are intended to cover the range of values for which there is statistical information to distinguish among them.
</p>


<h3>Value</h3>

<p>The return value of an <code>HLCor</code> call, with additional attributes. The <code>HLCor</code> call is evaluated at the estimated correlation parameter values. These values are included in the return object as its <code>$corrPars</code> member. The attributes added by <code>corrHLfit</code> include the original call of the function (which can be retrived by <code>getCall</code>(&lt;fitted object&gt;), and information about the optimization call within <code>corrHLfit</code>. 
</p>


<h3>See Also</h3>

<p>See more examples on data set <code>Loaloa</code>, to compare fit times by <code>corrHLfit</code> and <code>fitme</code>.
See <code>fixedLRT</code> for likelihood ratio tests.
</p>


<h3>Examples</h3>

<pre><code class="language-R"># Example with an adjacency matrix (autoregressive model):
if (spaMM.getOption("example_maxtime")&gt;0.7) {          
  corrHLfit(cases~I(prop.ag/10) +adjacency(1|gridcode)+offset(log(expec)),
          adjMatrix=Nmatrix,family=poisson(),data=scotlip,method="ML") 
}

#### Examples with Matern correlations
## A likelihood ratio test based on the ML fits of a full and of a null model.
if (spaMM.getOption("example_maxtime")&gt;1.4) {
 data("blackcap")
 (fullfit &lt;- corrHLfit(migStatus ~ means+ Matern(1|longitude+latitude),data=blackcap,
                    method="ML") )
 (nullfit &lt;- corrHLfit(migStatus ~ 1 + Matern(1|longitude+latitude),data=blackcap,
                    method="ML",init.corrHLfit=list(phi=1e-6))) 
 ## p-value:
 1-pchisq(2*(logLik(fullfit)-logLik(nullfit)),df=1)
}
</code></pre>


</div>