<div class="container">

<table style="width: 100%;"><tr>
<td>findPWL</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Find layers of interest (e.g. PWLs) in snowprofile(Layers)</h2>

<h3>Description</h3>

<p>Find one or more layers of interest, such as persistent weak layers (PWL) in a snowprofile or snowprofileLayers object based on combinations of grain type, datetag, grain size,
and stability indices (TSA/ RTA/ critical crack length/ p_unstable) of the layer. The routine can also be used for searching for crusts (or any other grain types).
</p>


<h3>Usage</h3>

<pre><code class="language-R">findPWL(
  x,
  pwl_gtype = c("SH", "DH"),
  pwl_date = NA,
  date_range = c(-5, 0),
  date_range_earlier = as.difftime(date_range[1], units = "days"),
  date_range_later = as.difftime(date_range[2], units = "days"),
  bdate_range = c(-1, 1),
  bdate_range_earlier = as.difftime(bdate_range[1], units = "days"),
  bdate_range_later = as.difftime(bdate_range[2], units = "days"),
  threshold_gtype = pwl_gtype,
  threshold_gsize = NA,
  threshold_TSA = NA,
  threshold_RTA = NA,
  threshold_SK38 = NA,
  threshold_RC = NA,
  threshold_PU = NA
)

labelPWL(x, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>x</code></td>
<td>
<p>snowprofile or snowprofileLayers object</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pwl_gtype</code></td>
<td>
<p>a vector of grain types of interest</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pwl_date</code></td>
<td>
<p>a date of interest given as character ('YYYY-MM-DD') or as POSIXct; set to <code>NA</code> to ignore dates. If given as POSIXct, time comparison between layer dates and pwl_date
will consider the times of day (i.e., hours, etc). Otherwise only consider year/month/days.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>date_range</code></td>
<td>
<p>a numeric array of length 2 that defines a date search window around <code>pwl_date</code>. This date range is applied to <code>ddate</code>s (deposition dates),
or if these are not available to <code>datetag</code>s.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>date_range_earlier</code></td>
<td>
<p>a difftime object of <code>date_range[1]</code> (must be negative).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>date_range_later</code></td>
<td>
<p>a difftime object of <code>date_range[2]</code> (must be positive).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bdate_range</code></td>
<td>
<p>a numeric array of length 2 that defines a date search window around <code>pwl_date</code>. This date range is applied to <code>bdate</code>s (burial dates)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bdate_range_earlier</code></td>
<td>
<p>a difftime object of <code>bdate_range[1]</code> (must be negative).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bdate_range_later</code></td>
<td>
<p>a difftime object of <code>bdate_range[2]</code> (must be positive).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>threshold_gtype</code></td>
<td>
<p>specific grain types that are only deemed a PWL if they pass one or multiple thresholds (see next parameters)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>threshold_gsize</code></td>
<td>
<p>a threshold grain size in order to deem <code>threshold_gtype</code> a PWL; set to <code>NA</code> to ignore grain sizes.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>threshold_TSA</code></td>
<td>
<p>a threshold TSA value (see computeTSA) in order to deem <code>threshold_gtype</code> a PWL; set to <code>NA</code> to ignore TSA.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>threshold_RTA</code></td>
<td>
<p>a threshold RTA value (see computeRTA) in order to deem <code>threshold_gtype</code> a PWL; set to <code>NA</code> to ignore RTA.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>threshold_SK38</code></td>
<td>
<p>a threshold SK38 in order to deem <code>threshold_gtype</code> a PWL; set to <code>NA</code> to ignore this threshold.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>threshold_RC</code></td>
<td>
<p>a threshold critical crack length in order to deem <code>threshold_gtype</code> a PWL; set to <code>NA</code> to ignore this threshold.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>threshold_PU</code></td>
<td>
<p>a threshold value for p_unstable in order to deem <code>threshold_gtype</code> a PWL; set to <code>NA</code> to ignore this threshold.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>passed on to findPWL</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>In case date considerations are included in your search, either one of the date window conditions needs to be satisfied to return a given layer:
</p>

<ul>
<li> <p><code>ddate</code> or <code>datetag</code> within <code>date_range</code>, <strong>or</strong>
</p>
</li>
<li> <p><code>bdate</code> within <code>bdate_range</code>
</p>
</li>
</ul>
<p>If the input object contains deposition dates (<code>ddate</code>, mostly in simulated profiles),
but no <code>bdates</code>, they are automatically computed by deriveDatetag;
otherwise the date window is applied to the <code>datetag</code> (mostly for manual profiles).
</p>
<p>If you apply thresholds to your search, only layers are returned that satisfy <em>at least one</em> of the provided thresholds.
</p>
<p>The <code>labelPWL</code> wrapper function is primarily used by <code>sarp.snowprofile.alignment::averageSP</code>.
</p>


<h3>Value</h3>

<p><code>findPWL</code>: An index vector of PWLs that match the desired requirements
</p>
<p><code>labelPWL</code>: The input object with an extra boolean column appended to the layer object, called <code style="white-space: pre;">⁠$layerOfInterest⁠</code>.
</p>


<h3>Functions</h3>


<ul>
<li> <p><code>findPWL()</code>: Find layers of interest (e.g., PWLs) in <code>snowprofile</code> or <code>snowprofileLayers</code>
</p>
</li>
<li> <p><code>labelPWL()</code>: Label layers of interest (e.g., weak layers) in <code>snowprofile</code>
</p>
</li>
</ul>
<h3>Author(s)</h3>

<p>fherla
</p>


<h3>Examples</h3>

<pre><code class="language-R">## get index vector:
findPWL(SPpairs$A_modeled)

## get layers subset:
SPpairs$A_manual$layers[findPWL(SPpairs$A_manual), ]
SPpairs$A_manual$layers[findPWL(SPpairs$A_manual, threshold_gsize = 2.2,
                        threshold_gtype = c("FC", "FCxr")), ]
## all (SH, DH), and (FC, FCxr) &gt;= 1 mm grain size:
SPpairs$A_modeled$layers[findPWL(SPpairs$A_modeled, pwl_gtype = c("SH", "DH", "FC", "FCxr"),
                                 threshold_gsize = 1, threshold_gtype = c("FC", "FCxr")), ]
## use TSA threshold:
SPpairs$A_modeled &lt;- computeTSA(SPpairs$A_modeled)
SPpairs$A_modeled$layers[findPWL(SPpairs$A_modeled, pwl_gtype = c("SH", "DH", "FC", "FCxr"),
                                 threshold_TSA = 4, threshold_gtype = c("FC", "FCxr")), ]

## searching for a specific pwl_date:
## let's construct one layer and an array of pwl_dates
tl &lt;- snowprofileLayers(height = 1, gtype = "SH",
                        ddate = as.POSIXct("2020-12-15"),
                        bdate = as.POSIXct("2020-12-20"))
pwl_dates &lt;- paste0("2020-12-", seq(14, 22))
## which pwl_date will 'find' that layer?
sapply(pwl_dates, function(dt) length(findPWL(tl, pwl_date = dt)) &gt; 0)
## same example, but with bdate being NA:
tl &lt;- snowprofileLayers(height = 1, gtype = "SH",
                        ddate = as.POSIXct("2020-12-15"),
                        bdate = as.POSIXct(NA), dropNAs = FALSE)
sapply(pwl_dates, function(dt) length(findPWL(tl, pwl_date = dt)) &gt; 0)

## pwl_date example with proper profile:
sp &lt;- deriveDatetag(SPpairs$A_manual)
sp$layers
pwl_dates &lt;- paste0("2019-02-", seq(18, 26))
names(pwl_dates) &lt;- pwl_dates
## which pwl_date will 'find' the two layers with (b)date labels?
list(pwl_date = lapply(pwl_dates, function(dt) {
  sp$layers[findPWL(sp, pwl_gtype = c("SH", "FC"), pwl_date = dt),
            c("height", "gtype", "ddate", "bdate")]
}))

## same example as above, but including TSA threshold:
sp &lt;- computeTSA(sp)
## the SH layer has TSA 5, the FC layer has TSA 4:
list(pwl_date = lapply(pwl_dates, function(dt) {
  sp$layers[findPWL(sp, pwl_gtype = c("SH", "FC"), pwl_date = dt, threshold_TSA = 5),
            c("height", "gtype", "ddate", "bdate")]
}))
## --&gt; no more FC layer in output since its TSA value is below the threshold!

## can also be used to search for crusts:
SPpairs$A_manual$layers[findPWL(SPpairs$A_manual, pwl_gtype = "MFcr"), ]

</code></pre>


</div>