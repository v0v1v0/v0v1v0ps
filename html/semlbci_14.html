<div class="container">

<table style="width: 100%;"><tr>
<td>gen_userp</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Create a Wrapper To Be Used
in 'lavaan' Models</h2>

<h3>Description</h3>

<p>Make a function on
<code>lavaan</code> object usable in a <code>lavaan</code>
model syntax.
</p>


<h3>Usage</h3>

<pre><code class="language-R">gen_userp(func, sem_out)

gen_sem_out_userp(
  userp,
  sem_out,
  userp_name = "semlbciuserp1234",
  fix = TRUE,
  control_args = list(),
  iter.max = 10000,
  max_attempts = 5
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>func</code></td>
<td>
<p>A function that receives a
<code>lavaan</code>-object and returns a scalar.
See Details on the restriction on this
function.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sem_out</code></td>
<td>
<p>A <code>lavaan</code>-class object
to be modified.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>userp</code></td>
<td>
<p>A function that is
generated by <code>gen_userp()</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>userp_name</code></td>
<td>
<p>The name of the
function <code>userp</code> to be used in the
<code>lavaan</code> model. It does not have to
be the name of the function in
<code>userp</code>. Should be changed only if it
conflicts with another object in the
parent environment, which should not
happen if the model is always fitted
in a clean R session.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fix</code></td>
<td>
<p>If <code>TRUE</code>, the default,
the function generated is used to fix
the value of <code>userp</code> to a target
value using an equality constraint.
If <code>FALSE</code>, then the function simply
fits the model to the data.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>control_args</code></td>
<td>
<p>To be passed to
the argument of the same name in
<code>lavaan::lavaan()</code>. Default is
<code>list()</code>. Can be used to set the
default values of this argument
in the generated function.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>iter.max</code></td>
<td>
<p>The maximum number of
iteration when the generated function
fit the model. Default is 10000.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>max_attempts</code></td>
<td>
<p>If the initial
fit with the equality constraint
fails, how many more attempts
will be made by the generated
function. Default is 5.</p>
</td>
</tr>
</table>
<h3>Details</h3>



<h4><code>gen_userp</code></h4>

<p>There are cases in which we want to
create a user parameter which is a
function of other free parameters,
computed by a function. However such
a function may work only on a
<code>lavaan</code> object.
</p>
<p>If the target function works by
extracting parameter estimates stored
in the <code>Model</code> slot and/or the
<code>implied</code> slot, then <code>gen_userp()</code>
can be used to convert it to a
function that retrieves the parameter
estimates when being called by
<code>lavaan::lavaan()</code> or its wrappers,
modifies the stored
<code>lavaan</code> object using
<code>lavaan::lav_model_set_parameters()</code>
and <code>lavaan::lav_model_implied()</code> to
change the estimates, and call the
target function.
</p>
<p>Note that this is an unconventional
way to define a user parameter and
the generated function should always
be checked to see whether it works as
expected.
</p>
<p>As shown in the examples, the
parameter computed this may not
have standard error nor <em>p</em>-value.
</p>
<p>The main purpose is for the point
estimate, for searching the
likelihood-based confidence bound
using <code>ci_bound_ur()</code> and
<code>ci_bound_ur_i()</code>.
</p>
<p>Note that the target function
specified in <code>func</code> should work
directly on the parameter estimates
stored in the <code>Model</code> slot and then
get the estimates using
<code>lavaan::lav_model_get_parameters()</code>.
Functions that work on the unmodified
output generated by
<code>lavaan::lavaan()</code> usually do not
work.
</p>
<p>Users are not recommended to use
<code>gen_userp()</code> and <code>gen_sem_out_userp()</code>
directly because they require
unconventional way to extract
parameter estimates from a lavaan
model. However, developers may use
them to include functions
they wrote in a lavaan model. This
is the technique used by
<code>ci_bound_ur_i()</code> to constrain any
parameter in a model to an arbitrary
value.
</p>



<h4><code>gen_sem_out_userp</code></h4>

<p>The function <code>gen_sem_out_userp()</code>
is to be used internally
for generating a function for searching
a likelihood-based confidence bound.
It is exported because it needs to
be run in an fresh external R process,
usually created by <code>callr</code> in other
internal functions.
</p>



<h3>Value</h3>



<h4><code>gen_userp</code></h4>

<p>It returns a function that
accepts a numeric vector of length
equals to the number of free parameters
in <code>sem_out</code>, and returns a scalar
which is the output of <code>func</code>. If this
vector is not supplied, it will try to
find it in the <code>parent.frame()</code>. This
is how it works inside a <code>lavaan</code>
model.
</p>



<h4><code>gen_sem_out_userp</code></h4>

<p>If <code>fix</code> is <code>TRUE</code>, it returns a
function with these arguments:
</p>

<ul>
<li> <p><code>target</code>: The value to which the
user-defined parameter will be fixed
to.
</p>
</li>
<li> <p><code>verbose</code>: If <code>TRUE</code>, additional
information will be printed when
fitting the model.
</p>
</li>
<li> <p><code>control</code>: The values to be passed
as a list to the argument of the
same name in <code>lavaan::lavaan()</code>.
</p>
</li>
<li> <p><code>seed</code>: Numeric. If supplied, it
will be used in <code>set.seed()</code> to
initialize the random number
generator. Necessary to reproduce
some results because random numbers
are used in some steps in <code>lavaan</code>.
If <code>NULL</code>, the default, <code>set.seed()</code>
will not be called.
</p>
</li>
</ul>
<p>If <code>fix</code> is 'FALSE, then it returns a
function with optional arguments that
will be ignored, Calling it will
simply fit the modified model to the
data. Useful for getting the value of
the user-defined parameter.
</p>



<h3>Examples</h3>

<pre><code class="language-R">
library(lavaan)

data(simple_med)
dat &lt;- simple_med
mod &lt;-
"
m ~ a*x
y ~ b*m
ab := a*b
"
fit_med &lt;- sem(mod, simple_med, fixed.x = FALSE)
parameterEstimates(fit_med)

# A trivial example for verifying the results
my_ab &lt;- function(object) {
    # Need to use lav_model_get_parameters()
    # because the object is only a modified
    # lavaan-object, not one directly
    # generated by lavaan function
    est &lt;- lavaan::lav_model_get_parameters(object@Model, type = "user")
    unname(est[1] * est[2])
  }

# Check the function
my_ab(fit_med)
coef(fit_med, type = "user")["ab"]

# Create the function
my_userp &lt;- gen_userp(func = my_ab,
                      sem_out = fit_med)
# Try it on the vector of free parameters
my_userp(coef(fit_med))

# Generate a modified lavaan model
fit_userp &lt;- gen_sem_out_userp(userp = my_userp,
                               userp_name = "my_userp",
                               sem_out = fit_med)

# This function can then be used in the model syntax.

# Note that the following example only work when called inside the
# workspace or inside other functions such as ci_bound_ur()`
# and `ci_bound_ur_i()` because `lavaan::sem()` will
# search `my_userp()` in the global environment.

# Therefore, the following lines are commented out.
# They should be run only in a "TRUE" interactive
# session.

# mod2 &lt;-
# "
# m ~ x
# y ~ m
# ab := my_userp()
# "
# fit_med2 &lt;- sem(mod2, simple_med, fixed.x = FALSE)
# parameterEstimates(fit_med2)
#
# # Fit the model with the output of the function, a*b
# # fixed to .50
#
# fit_new &lt;- fit_userp(.50)
#
# # Check if the parameter ab is fixed to .50
# parameterEstimates(fit_new)


</code></pre>


</div>