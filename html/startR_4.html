<div class="container">

<table style="width: 100%;"><tr>
<td>Collect</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Collect and merge the computation results</h2>

<h3>Description</h3>

<p>The final step of the startR workflow after the data operation. It is used when
the parameter 'wait' of Compute() is FALSE. It combines all the chunks of the
results as one data array when the execution is done. See more details on 
<a href="https://earth.bsc.es/gitlab/es/startR/-/blob/master/inst/doc/practical_guide.md">practical guide</a>.
Collect() calls Collect_ecflow() or Collect_autosubmit() according to the 
chosen workflow manager.
</p>


<h3>Usage</h3>

<pre><code class="language-R">Collect(startr_exec, wait = TRUE, remove = TRUE, on_remote = FALSE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>startr_exec</code></td>
<td>
<p>An R object returned by Compute() when the parameter 'wait'
of Compute() is FALSE. It can be directly from a Compute() call or read from
the RDS file.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>wait</code></td>
<td>
<p>A logical value deciding whether the R session waits for the 
Collect() call to finish (TRUE) or not (FALSE). If TRUE, it will be a 
blocking call, in which Collect() will retrieve information from the HPC,
including signals and outputs, each polling_period seconds. The the status
can be monitored on the workflow manager GUI. Collect() will not return  
until the results of all the chunks have been received. If FALSE, Collect()
return an error if the execution has not finished, otherwise it will return
the merged array. The default value is TRUE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>remove</code></td>
<td>
<p>A logical value deciding whether to remove of all chunk results 
received from the HPC after data being collected, as well as the local job 
folder under 'ecflow_suite_dir' or 'autosubmit_suite_dir'. To preserve the
data and Collect() them as many times as desired, set remove to FALSE. The
default value is TRUE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>on_remote</code></td>
<td>
<p>A logical value deciding to the function is run locally and
sync the outputs back from HPC (FALSE, default), or it is run on HPC 
(TRUE).</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>A list of merged data array.
</p>


<h3>Examples</h3>

<pre><code class="language-R"> data_path &lt;- system.file('extdata', package = 'startR')
 path_obs &lt;- file.path(data_path, 'obs/monthly_mean/$var$/$var$_$sdate$.nc')
 sdates &lt;- c('200011', '200012')
 data &lt;- Start(dat = list(list(path = path_obs)),
               var = 'tos',
               sdate = sdates,
               time = 'all',
               latitude = 'all',
               longitude = 'all',
               return_vars = list(latitude = 'dat',
                                  longitude = 'dat',
                                  time = 'sdate'),
               retrieve = FALSE)
 fun &lt;- function(x) {
           lat = attributes(x)$Variables$dat1$latitude
           weight = sqrt(cos(lat * pi / 180))
           corrected = Apply(list(x), target_dims = "latitude",
                             fun = function(x) {x * weight})
         }
 step &lt;- Step(fun = fun,
              target_dims = 'latitude',
              output_dims = 'latitude',
              use_libraries = c('multiApply'),
              use_attributes = list(data = "Variables"))
 wf &lt;- AddStep(data, step)
 ## Not run: 
 res &lt;- Compute(wf, chunks = list(longitude = 2, sdate = 2),
                threads_load = 1,
                threads_compute = 4,
                cluster = list(queue_host = 'nord3',
                               queue_type = 'lsf',
                               temp_dir = '/on_hpc/tmp_dir/',
                               cores_per_job = 2,
                               job_wallclock = '05:00',
                               max_jobs = 4,
                               extra_queue_params = list('#BSUB -q bsc_es'),
                               bidirectional = FALSE,
                               polling_period = 10
                ),
                ecflow_suite_dir = '/on_local_machine/username/ecflow_dir/',
                wait = FALSE)
 saveRDS(res, file = 'test_collect.Rds')
 collect_info &lt;- readRDS('test_collect.Rds')
 result &lt;- Collect(collect_info, wait = TRUE)
 
## End(Not run)

</code></pre>


</div>